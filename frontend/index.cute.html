<!-- ======= å£¹å®…ã€€æ´»æ½‘å¯æ„›é¢¨ãƒ»å‰ç«¯ä¸€é å¼ï¼ˆStrikingly ç‰ˆï¼‰ ======= -->
<style>
:root{
  --pink:#ffd1dc; --mint:#c8f7dc; --lemon:#fff5cc; --sky:#bfe9ff; --ink:#404545;
  --bg:#fff; --accent:#ff8fb1; --brand:#ff7aa2;
  --radius:18px; --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box} .cute{font-family:"Nunito","Segoe UI",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink)}
.c-card{background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; position:relative; overflow:hidden}
.c-card:before{content:""; position:absolute; width:140px;height:140px; right:-40px; top:-40px; border-radius:50%; background:radial-gradient(circle at 30% 30%, var(--pink), #fff0); opacity:.5}
.c-title{font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px}
.c-title .b{background:var(--pink); padding:4px 10px; border-radius:999px}
.row{display:grid; gap:14px}
.grid-2{grid-template-columns:1fr 1fr} .grid-3{grid-template-columns:1fr 1fr 1fr}
.btn{border:none; border-radius:999px; padding:10px 14px; background:linear-gradient(120deg,var(--accent),var(--brand));
 color:#fff; font-weight:700; box-shadow:var(--shadow); cursor:pointer; transition:transform .05s ease}
.btn:active{transform:translateY(1px)} .btn-ghost{background:#0000;color:var(--ink); border:2px dashed var(--accent)}
.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--lemon); font-weight:700}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--mint); font-size:12px; font-weight:700}
.help{font-size:12px; opacity:.7}
hr.c{border:none; height:1px; background:linear-gradient(90deg,#0000,#0002,#0000); margin:10px 0}
.preview{width:100%; border-radius:12px; border:1px solid #eee; box-shadow:var(--shadow)}
.toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.tool{background:#fff; border:1px dashed var(--accent); border-radius:999px; padding:8px 12px; cursor:pointer}
.tool.active{background:var(--pink)}
.color-chip{width:28px;height:28px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer}
.flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.hidden{display:none}
.note{background:var(--sky); padding:8px 12px; border-radius:10px; font-size:12px}
.small{font-size:12px}
.kawaii{background:linear-gradient(180deg,#fff, #fff8fb)}
/* å››æ ¼ç‰†ä¸‹è¼‰éˆ• */
.dl{position:absolute; top:10px; right:10px; text-decoration:none; background:#0008; color:#fff; padding:6px 8px; border-radius:8px; font-weight:800}
.card-img{position:relative}
</style>

<div class="cute row grid-2 kawaii" id="app">

  <!-- å·¦ï¼šæµç¨‹å€ -->
  <div class="row">
    <!-- 1. ä¸Šå‚³ï¼‹å³é è¦½ -->
    <div class="c-card">
      <div class="c-title"><span class="b">â‘ </span> ä¸Šå‚³èˆŠå±‹ç…§ç‰‡ï¼ˆâ‰¤2MBï¼‰</div>
      <div class="help">é¸æª”å¾Œç«‹å³é¡¯ç¤ºé è¦½ï¼›è‹¥è¶…é 2MB æœƒå…ˆåœ¨ç€è¦½å™¨ç«¯è‡ªå‹•å£“ç¸®å†ä¸Šå‚³ã€‚</div>
      <div class="toolbar" style="margin:8px 0;">
        <label class="tool">ğŸ“· é¸æ“‡æª”æ¡ˆ <input id="file" type="file" accept="image/png,image/jpeg" style="display:none"></label>
        <span id="uploadStatus" class="badge">å°šæœªä¸Šå‚³</span>
      </div>
      <img id="preview" class="preview" alt="é è¦½å°‡é¡¯ç¤ºæ–¼æ­¤">
    </div>

    <!-- 2. è‡ªå‹•åµæ¸¬ï¼†åˆä½µé®ç½© -->
    <div class="c-card">
      <div class="c-title"><span class="b">â‘¡</span> è‡ªå‹•çµæ§‹ï¼‹æ·±åº¦åµæ¸¬</div>
      <div class="toolbar">
        <button id="btnDetect" class="btn">ğŸ” åµæ¸¬æ¢æŸ±ç‰†é–€çª—</button>
        <span id="detectBadge" class="badge">å¾…åµæ¸¬</span>
      </div>
      <hr class="c">
      <div class="help">å®Œæˆå¾Œæœƒå‡ºç¾ <b>åˆä½µé®ç½©</b> åœ–å±¤ï¼Œä¸‹ä¸€æ­¥é€²å…¥ã€Œæ‰‹ç¹ªä¿®æ­£ã€ã€‚</div>
      <img id="merged" class="preview hidden" alt="åˆä½µé®ç½©é è¦½">
    </div>

    <!-- 3. åˆä½µé®ç½©ï¼šæœ€å¾Œä¿®æ­£ï¼ˆæ‰‹ç¹ªï¼‰ -->
    <div class="c-card">
      <div class="c-title"><span class="b">â‘¢</span> é®ç½©æœ€å¾Œä¿®æ­£ï¼ˆåƒ…åœ¨åˆä½µé®ç½©ä¸Šï¼‰</div>
      <div class="help">æ¨¡å¼ï¼š<b>Editable</b>ï¼å¯æ”¹å€ï¼ˆå®¶å…·/æè³ªæ›¿æ›ï¼‰ï¼›<b>Locked</b>ï¼ä¸å¯è®Šå‹•çš„çµæ§‹ã€‚</div>
      <div class="toolbar">
        <button class="tool active" data-mode="editable">ğŸ–Œï¸ ç•« Editable</button>
        <button class="tool" data-mode="locked">ğŸ§± ç•« Locked</button>
        <label class="tool">ç­†åˆ·<input id="brush" type="range" min="6" max="40" value="16" style="vertical-align:middle"></label>
        <button id="btnUndo" class="tool">â†©ï¸ å¾©åŸ</button>
        <button id="btnCommitMask" class="btn">âœ… é€å‡ºæœ€çµ‚é®ç½©</button>
        <span id="maskBadge" class="badge">æœªæäº¤</span>
      </div>
      <div style="position:relative">
        <canvas id="canvas" class="preview" height="0"></canvas>
        <div class="note" style="margin-top:8px;">æŠ€å·§ï¼šåˆ‡æ›æ¨¡å¼å¾Œåœ¨éœ€è¦è™•ç›´æ¥å¡—æŠ¹ï¼›æäº¤å¾Œï¼Œå¾Œç«¯çš„ç”Ÿåœ–æœƒä»¥ <b>æœ€çµ‚é®ç½©ï¼‹åŸåœ–ï¼‹Promptï¼‹çŸ¥è­˜åº«</b> ç‚ºæº–ã€‚</div>
      </div>
    </div>

    <!-- 4. é¢¨æ ¼ï¼‹è‰²å¡ -->
    <div class="c-card">
      <div class="c-title"><span class="b">â‘£</span> é¸é¢¨æ ¼ï¼ˆâ‰¤3ï¼‰èˆ‡è‰²å¡ï¼ˆ1ä¸»ï¼‹1/2/3é…ï¼‰</div>
      <div class="row grid-3" id="styleList"></div>
      <hr class="c">
      <div class="flex">
        <span class="pill">ğŸ¨ ä¸»è‰²</span><input type="color" id="mainColor" value="#ffd1dc" class="color-chip">
        <span class="pill">é…è‰²</span><div id="accents"></div>
        <button id="addAccent" class="tool">ï¼‹æ–°å¢é…è‰²</button>
        <button id="removeAccent" class="tool">ï¼ç§»é™¤é…è‰²</button>
      </div>
    </div>

    <!-- 5. ç”Ÿæˆèˆ‡é¸å®š Gate -->
    <div class="c-card">
      <div class="c-title"><span class="b">â‘¤</span> ç”Ÿæˆ 1â€“3 å¼µæ–°é¢¨æ ¼åœ–ï¼ˆgpt-image-1ï¼‰</div>
      <div class="toolbar">
        <button id="btnGenerate" class="btn">ğŸŒŸ é–‹å§‹ç”Ÿæˆ</button>
        <span id="genBadge" class="badge">å¾…ç”Ÿæˆ</span>
      </div>
      <div id="variants" class="row grid-3" style="margin-top:10px"></div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnFurniture" class="btn" disabled>ğŸ›‹ï¸ é€²å…¥å®¶å…·ç·¨ä¿®ï¼ˆéœ€å…ˆé¸ä¸€å¼µï¼‰</button>
        <button id="btnSkipDownload" class="btn-ghost" disabled>â¬‡ï¸ ç›´æ¥ä¸‹è¼‰é€™å¼µ</button>
      </div>
    </div>
  </div>

  <!-- å³ï¼šå››æ ¼æ¯”å°ç‰†ï¼ˆå«ä¸‹è¼‰ï¼‰ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¥</span> å››æ ¼æ¯”å°ç‰†ï¼ˆåŸåœ–ï¼‹æœ€å¤š 3 å¼µè®Šé«”ï¼‰</div>
    <div id="compare" class="row grid-2" style="margin-top:10px"></div>
    <div class="help">æ¯ä¸€æ ¼å³ä¸Šè§’ â¬‡ï¸ å¯ç›´æ¥ä¸‹è¼‰ï¼ˆçš†å«å£¹å®… LOGOï¼‰ã€‚</div>
  </div>

</div>

<script>
const BASE_URL = (window.API_BASE||'https://oldroomchange-image3.onrender.com');
const ABS = (u)=> u?.startsWith('http') ? u : (BASE_URL + u);
const $ = (q)=>document.querySelector(q); const $$=(q)=>[...document.querySelectorAll(q)];
const state = {
  image:null,     // {id,w,h,previewURL}
  maskVersion:null,
  masks:{lock:null, editable:null, merged:null, depth:null},
  drawing:{mode:'editable', brush:16, history:[]},
  styles:[], selectedStyles:new Set(), kbVersion:null,
  palette:{main:'#ffd1dc', accents:['#bfe9ff']},
  variants:[], selectedResultId:null
};

/* ============== 1) ä¸Šå‚³ï¼‹å³æ™‚é è¦½ï¼ˆå« >2MB å£“ç¸®ï¼‰ ============== */
const fileInput = $('#file'), pv = $('#preview'), uploadStatus = $('#uploadStatus');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  pv.src = URL.createObjectURL(f); // ç«‹å³é è¦½
  const file = await compressIfNeeded(f, 2*1024*1024);
  const fd = new FormData(); fd.append('file', file);
  uploadStatus.textContent='ä¸Šå‚³ä¸­â€¦';
  try{
    const r = await fetch(BASE_URL+'/upload',{method:'POST',body:fd});
    const d = await r.json();
    state.image={id:d.image_id,w:d.w,h:d.h,previewURL:pv.src};
    uploadStatus.textContent='å·²ä¸Šå‚³ âœ”';
    // åˆå§‹åŒ– compare ç‰†ï¼ˆå…ˆåªæ”¾åŸåœ–ï¼‰
    renderCompare();
  }catch(err){ alert('ä¸Šå‚³å¤±æ•—'); uploadStatus.textContent='ä¸Šå‚³å¤±æ•—'; }
});
async function compressIfNeeded(file, maxBytes){
  if(file.size<=maxBytes) return file;
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, Math.sqrt(maxBytes / file.size));
  const canvas = document.createElement('canvas'); canvas.width=bmp.width*scale; canvas.height=bmp.height*scale;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0,canvas.width,canvas.height);
  const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  return new File([blob],'compressed.jpg',{type:'image/jpeg'});
}

/* ============== 0) è®€çŸ¥è­˜åº«æ¨£å¼æ¸…å–® ============== */
(async function loadMeta(){
  try{
    const r=await fetch(BASE_URL+'/meta/styles'); const d=await r.json();
    state.styles = d.styles||[]; state.kbVersion = d.kb_version||'kb';
  }catch{ // å¾Œç«¯å°šæœªæä¾›æ™‚çš„å®‰å…¨é è¨­
    state.styles = [{code:'modern',name:'ç¾ä»£é¢¨'},{code:'classical',name:'å¤å…¸é¢¨'},{code:'industrial',name:'å·¥æ¥­é¢¨'},{code:'scandinavian',name:'åŒ—æ­é¢¨'}];
    state.kbVersion = 'kb-local';
  }
  renderStyleList();
})();

/* ============== 2) è‡ªå‹•åµæ¸¬ï¼ˆæ¢æŸ±ç‰†é–€çª—ï¼‹æ·±åº¦ï¼‰ ============== */
$('#btnDetect').addEventListener('click', async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
  $('#detectBadge').textContent='åµæ¸¬ä¸­â€¦';
  try{
    let r = await fetch(BASE_URL+'/detect/v2',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id})});
if(!r.ok){ r = await fetch(BASE_URL+'/detect',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id})}); }
    const d = await r.json();
    state.maskVersion = d.mask_version;
    state.masks = { lock:d.lock_mask, editable:d.editable_mask, merged:d.merged_overlay, depth:d.depth_map };
    $('#detectBadge').textContent='å®Œæˆ âœ”';
    $('#merged').src = d.merged_overlay; $('#merged').classList.remove('hidden');
    await initCanvasForEditing(d); // è¼‰å…¥é®ç½©åˆ°å¯ç¹ªå±¤
  }catch(err){ alert('åµæ¸¬å¤±æ•—'); $('#detectBadge').textContent='å¤±æ•—'; }
});

/* ============== 3) åˆä½µé®ç½©ï¼šæœ€å¾Œä¿®æ­£ï¼ˆç•« Editable/Lockedï¼‰ ============== */
const canvas = $('#canvas'); const brush = $('#brush');
let ctx, imgW=0, imgH=0;
async function initCanvasForEditing(d){
  // èƒŒæ™¯è¼‰åŸåœ–ä»¥åˆ©æ¯”å°ï¼›å…©å±¤ç¹ªåœ–åˆ†åˆ¥ä»£è¡¨ editable èˆ‡ locked
  const base = await loadImage(state.image.previewURL);
  imgW = base.width; imgH = base.height;
  canvas.width=imgW; canvas.height=imgH; ctx = canvas.getContext('2d');
  ctx.drawImage(base,0,0,imgW,imgH); // èƒŒæ™¯ï¼ˆåƒè€ƒï¼‰
  // ç–Šåˆä½µé®ç½©åŠé€æ˜é¡¯ç¤º
  const merged = await loadImage(ABS(d.merged_overlay));
  ctx.globalAlpha = .35; ctx.drawImage(merged,0,0,imgW,imgH); ctx.globalAlpha = 1;

  // å»ºå…©å€‹é›¢å± canvas ä½œç‚ºå¯ç·¨è¼¯é®ç½©ã€é–å®šé®ç½©ï¼ˆè¼‰å…¥å¾Œç«¯åˆå§‹ç‰ˆæœ¬ï¼‰
  state._editableLayer = await loadToOffscreen(ABS(d.editable_mask));
  state._lockedLayer   = await loadToOffscreen(ABS(d.lock_mask));

  // å•Ÿç”¨ç•«ç­†
  enableDrawing();
}
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function loadToOffscreen(url){
  const img = await loadImage(url); const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); return c;
}
function enableDrawing(){
  const tools=$$('.tool[data-mode]'); tools.forEach(t=>t.onclick=()=>{ tools.forEach(x=>x.classList.remove('active')); t.classList.add('active'); state.drawing.mode=t.dataset.mode; });
  brush.oninput=()=>state.drawing.brush=+brush.value;
  let painting=false, last=null;
  canvas.onmousedown=(e)=>{painting=true; last=pos(e); pushHistory(); drawDot(last.x,last.y);};
  canvas.onmousemove=(e)=>{ if(painting){ const p=pos(e); drawLine(last,p); last=p; } };
  window.onmouseup=()=>painting=false;
  $('#btnUndo').onclick=undo;
  $('#btnCommitMask').onclick=commitMask;
}
function pos(e){ const r=canvas.getBoundingClientRect(); return {x:Math.round((e.clientX-r.left)*canvas.width/r.width), y:Math.round((e.clientY-r.top)*canvas.height/r.height)} }
function targetLayer(){ return state.drawing.mode==='editable' ? state._editableLayer : state._lockedLayer; }
function drawDot(x,y){ drawLine({x,y},{x:x+.1,y:y+.1}); }
function drawLine(a,b){
  const c = targetLayer(); const cctx=c.getContext('2d');
  cctx.lineCap='round'; cctx.lineJoin='round';
  cctx.strokeStyle = state.drawing.mode==='editable' ? 'white' : 'black'; // å‡è¨­ editable=ç™½ã€locked=é»‘
  cctx.lineWidth = state.drawing.brush; cctx.beginPath(); cctx.moveTo(a.x,a.y); cctx.lineTo(b.x,b.y); cctx.stroke();
  // ç•«åœ¨ä¸»ç•«å¸ƒåšè¦–è¦ºæç¤ºï¼ˆå½©è‰²ï¼‰
  ctx.drawImage(state.drawing.mode==='editable'? tint(c,'#4ade80',.4) : tint(c,'#ef4444',.4),0,0);
}
function tint(srcCanvas,color,alpha){
  const c=document.createElement('canvas'); c.width=srcCanvas.width; c.height=srcCanvas.height;
  const cx=c.getContext('2d'); cx.drawImage(srcCanvas,0,0);
  cx.globalCompositeOperation='source-in'; cx.fillStyle=color; cx.globalAlpha=alpha; cx.fillRect(0,0,c.width,c.height);
  cx.globalCompositeOperation='source-over'; cx.globalAlpha=1; return c;
}
/* ç°¡æ˜“å¾©åŸ */
function pushHistory(){ state.drawing.history.push({ e:state._editableLayer.toDataURL(), l:state._lockedLayer.toDataURL() }); if(state.drawing.history.length>20) state.drawing.history.shift(); }
function undo(){ const h=state.drawing.history.pop(); if(!h) return; loadImage(h.e).then(i=>{const c=state._editableLayer.getContext('2d'); c.clearRect(0,0,imgW,imgH); c.drawImage(i,0,0)}); loadImage(h.l).then(i=>{const c=state._lockedLayer.getContext('2d'); c.clearRect(0,0,imgW,imgH); c.drawImage(i,0,0)}); }

/* æäº¤æœ€çµ‚é®ç½©ï¼ˆå…©å¼µ PNGï¼‰ */
async function commitMask(){
  if(!state.image) return;
  $('#maskBadge').textContent='æäº¤ä¸­â€¦';
  const [lockBlob, editableBlob] = await Promise.all([ blobFromCanvas(state._lockedLayer), blobFromCanvas(state._editableLayer) ]);
  const fd = new FormData();
  fd.append('image_id', state.image.id);
  fd.append('lock_mask', lockBlob, 'lock.png');
  fd.append('editable_mask', editableBlob, 'editable.png');
  try{
    const r=await fetch(BASE_URL+'/mask/commit',{method:'POST',body:fd});
    const d=await r.json(); state.maskVersion=d.mask_version; $('#maskBadge').textContent='å·²æäº¤ v'+d.mask_version+' âœ”';
  }catch{ alert('æäº¤å¤±æ•—'); $('#maskBadge').textContent='å¤±æ•—'; }
}
function blobFromCanvas(c){ return new Promise(res=>c.toBlob(res,'image/png')); }

/* ============== 4) é¢¨æ ¼æ¸…å–®ï¼†è‰²å¡ï¼ˆ1 ä¸» + 1/2/3 é…ï¼‰ ============== */
function renderStyleList(){
  const box = $('#styleList'); box.innerHTML='';
  state.styles.forEach(s=>{
    const id='s_'+s.code;
    const d=document.createElement('label'); d.className='c-card'; d.style.cursor='pointer';
    d.innerHTML=`<div class="flex"><input type="checkbox" id="${id}" data-code="${s.code}">
      <span class="pill">ğŸ’– ${s.name||s.code}</span><span class="small">ï¼ˆæœ€å¤š 3ï¼‰</span></div>`;
    d.querySelector('input').onchange=(e)=>{
      const code=e.target.dataset.code;
      if(e.target.checked){ if(state.selectedStyles.size>=3){ e.target.checked=false; alert('æœ€å¤šé¸ä¸‰ç¨®'); return; } state.selectedStyles.add(code); }
      else state.selectedStyles.delete(code);
    };
    box.appendChild(d);
  });
  // è‰²å¡
  $('#mainColor').oninput=(e)=>state.palette.main=e.target.value;
  const accentsBox = $('#accents'); function rerenderAccents(){
    accentsBox.innerHTML='';
    state.palette.accents.forEach((v,i)=>{
      const inp=document.createElement('input'); inp.type='color'; inp.value=v; inp.className='color-chip';
      inp.oninput=(e)=>state.palette.accents[i]=e.target.value; accentsBox.appendChild(inp);
    });
  }
  $('#addAccent').onclick=()=>{ if(state.palette.accents.length>=3) return alert('é…è‰²æœ€å¤š 3 å€‹'); state.palette.accents.push('#c8f7dc'); rerenderAccents(); };
  $('#removeAccent').onclick=()=>{ if(state.palette.accents.length<=1) return alert('è‡³å°‘ 1 å€‹é…è‰²'); state.palette.accents.pop(); rerenderAccents(); };
  rerenderAccents();
}

/* ============== 5) ç”Ÿæˆè®Šé«”ï¼ˆgpt-image-1ï¼‰ ============== */
$('#btnGenerate').onclick = async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³');
  if(!state.maskVersion) return alert('è«‹å…ˆå®Œæˆåµæ¸¬èˆ‡é®ç½©æäº¤');
  if(state.selectedStyles.size===0) return alert('è«‹è‡³å°‘é¸ 1 ç¨®é¢¨æ ¼');
  $('#genBadge').textContent='ç”Ÿæˆä¸­â€¦';
  const body = {
    image_id: state.image.id,
    mask_version: state.maskVersion,
    styles: [...state.selectedStyles],
    palette: { main: state.palette.main, accents: state.palette.accents },
    logo: true
  };
  try{
    const r=await fetch(BASE_URL+'/generate',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    const d=await r.json();
    state.variants = d.variants||[]; renderVariants(); $('#genBadge').textContent='å®Œæˆ âœ”';
    // åŒæ­¥å››æ ¼ç‰†
    renderCompare();
  }catch{ alert('ç”Ÿæˆå¤±æ•—'); $('#genBadge').textContent='å¤±æ•—'; }
};

function renderVariants(){
  const box=$('#variants'); box.innerHTML='';
  state.variants.forEach(v=>{
    const card=document.createElement('div'); card.className='c-card';
    card.innerHTML = `
      <div class="card-img">
        <img src="${ABS(v.url)}" class="preview" alt="${v.style}">
        <a class="dl" href="${ABS(v.download_url||v.url)}" download>â¬‡ï¸</a>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn choose">âœ… é¸æ“‡æ­¤åœ–</button>
        <span class="badge">style: ${v.style}</span>
      </div>`;
    card.querySelector('.choose').onclick=async ()=>{
      try{
        await fetch(BASE_URL+'/select',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id, result_id:v.result_id})});
        state.selectedResultId=v.result_id;
        $('#btnFurniture').disabled=false; $('#btnSkipDownload').disabled=false;
      }catch{ alert('é¸æ“‡å¤±æ•—'); }
    };
    box.appendChild(card);
  });
  // è‹¥ç„¡è®Šé«”ï¼Œé–æŒ‰éˆ•
  const able = state.variants.length>0;
  $('#btnFurniture').disabled=!able; $('#btnSkipDownload').disabled=!able;
}

/* ============== 6) å››æ ¼æ¯”å°ç‰†ï¼ˆå«ä¸‹è¼‰ï¼‰ ============== */
async function renderCompare(){
  const box=$('#compare'); box.innerHTML='';
  if(!state.image) return;
  const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).join(',');
  try{
    const r=await fetch(`${BASE_URL}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    const d=await r.json();
    (d.items||[]).forEach(it=>{
      const cell=document.createElement('div'); cell.className='c-card card-img';
      cell.innerHTML=`<img src="${ABS(it.url)}" class="preview"><a class="dl" href="${ABS(it.download_url||it.url)}" download>â¬‡ï¸</a>`;
      box.appendChild(cell);
    });
  }catch{ /* éœé»˜å¤±æ•—å³å¯ */ }
}

/* å®¶å…· Gate & ç•¥éç›´æ¥ä¸‹è¼‰ */
$('#btnFurniture').onclick=()=>{ if(!state.selectedResultId) return; alert('âœ… å·²è§£é–å®¶å…·ç·¨ä¿®ï¼ˆæ­¤è™•å¯å°å‘ç·¨ä¿®é æˆ–å½ˆçª—ï¼‰'); };
$('#btnSkipDownload').onclick=()=>{
  const v = state.variants.find(x=>x.result_id===state.selectedResultId)||state.variants[0];
  if(!v) return alert('å°šç„¡å¯ä¸‹è¼‰åœ–ç‰‡'); location.href = v.download_url||v.url;
};
</script>
<!-- ======= /END ======= -->