<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èˆŠå±‹æ›æ–°é¢¨æ ¼ Â· ä¹¾æ·¨ä¿®æ­£ç‰ˆï¼ˆæ¸¸æ¨™å°é½Šï¼‹åŠå¯¬ç•«å¸ƒï¼‹æ¯”å°ç‰†ä¿®æ­£ï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ffd1dc; --mint:#c8f7dc; --lemon:#fff5cc; --sky:#bfe9ff; --ink:#333;
  --bg:#fff; --accent:#ff8fb1; --brand:#ff7aa2; --green:#1ebe6b;
  --radius:18px; --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;padding:14px;background:linear-gradient(180deg,#fff,#fff8fb);
  font-family:"Nunito","Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;display:grid;gap:14px}
.c-card{background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; position:relative; overflow:hidden}
.c-title{font-weight:900; font-size:18px; display:flex; align-items:center; gap:8px}
.c-title .b{background:var(--pink); padding:4px 10px; border-radius:999px}
.btn{border:none; border-radius:999px; padding:10px 14px; background:linear-gradient(120deg,var(--accent),var(--brand)); color:#fff; font-weight:800; box-shadow:var(--shadow); cursor:pointer; transition:transform .05s ease}
.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.5; cursor:not-allowed}
.tool{background:#fff; border:1px dashed var(--accent); border-radius:999px; padding:8px 12px; cursor:pointer}
.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--lemon); font-weight:800}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--mint); font-size:12px; font-weight:800}
.help{font-size:12px; opacity:.75}
hr.c{border:none; height:1px; background:linear-gradient(90deg,#0000,#0002,#0000); margin:10px 0}
.preview{width:100%; border-radius:12px; border:1px solid #eee; box-shadow:var(--shadow); background:#fff}
.grid-3{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px}
.card-img{position:relative}
.dl{position:absolute; top:10px; right:10px; text-decoration:none; background:#0008; color:#fff; padding:6px 8px; border-radius:8px; font-weight:800}
.hidden{display:none}

/* å…±ç”¨å·¥å…·åˆ— */
.toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.nowrap-group{ display:inline-flex; align-items:center; gap:8px; flex-wrap:nowrap; }
#accents{ display:inline-flex; align-items:center; gap:6px; }

/* ç•«å¸ƒå€ */
.canvas-wrap{ position:relative; width:100%; }
.canvas-stack{ position:relative; display:inline-block; width:100%; }
#editCanvas, #editCursor, #fbaseCanvas, #fmaskCanvas{ display:block; width:100%; height:auto; border-radius:12px; }
#editCanvas, #fbaseCanvas{ border:2px solid #f0f0f0; box-shadow:var(--shadow) }
#editCursor{ position:absolute; left:0; top:0; pointer-events:none; z-index:10 }
#fmaskCanvas{ position:absolute; left:0; top:0; pointer-events:auto; z-index:5 }
.legend{position:absolute; left:10px; top:10px; background:#0009; color:#fff; padding:4px 8px; border-radius:8px; font-weight:800}

/* è®“é è¦½èˆ‡ç·¨è¼¯ç•«å¸ƒé¡¯ç¤ºåŠå¯¬ï¼ˆä¸æ”¹å…§éƒ¨åƒç´ ï¼Œä¿æŒå°é½Šï¼‰ */
.half{ width:50%!important; max-width:50%!important; }
</style>

<script>
const FALLBACK_STYLES = [
  {"code":"åŒ—æ­é¢¨","name":"åŒ—æ­é¢¨","brief":"ç°¡ç´„ç·šæ¢ã€è‡ªç„¶æ¡å…‰ã€åŠŸèƒ½å°å‘"},
  {"code":"ç¾ä»£é¢¨","name":"ç¾ä»£é¢¨","brief":"å¹¾ä½•åˆ†æ˜ã€æ¥µç°¡æ”¶ç´ã€ç»ç’ƒé‡‘å±¬æ„Ÿ"},
  {"code":"å·¥æ¥­é¢¨","name":"å·¥æ¥­é¢¨","brief":"å¤–éœ²çµæ§‹ã€ç²—ç·æè³ªã€æ·±è‰²èª¿"},
  {"code":"ç¾å¼é„‰æ‘é¢¨","name":"ç¾å¼é„‰æ‘é¢¨","brief":"æº«é¦¨æœ¨ä½œã€ç¶“å…¸ç·šæ¿ã€å¾©å¤ç´°ç¯€"},
  {"code":"æ—¥å¼ä¾˜å¯‚é¢¨","name":"æ—¥å¼ä¾˜å¯‚é¢¨","brief":"ç•™ç™½ã€è‡ªç„¶æè³ªã€ä¸å°ç¨±ç¾"},
  {"code":"æ—¥å¼ç¦ªé¢¨","name":"æ—¥å¼ç¦ªé¢¨","brief":"å°ç¨±ã€è‡ªç„¶å…‰ã€ç°¡æ·¨æè³ª"},
  {"code":"åœ°ä¸­æµ·é¢¨","name":"åœ°ä¸­æµ·é¢¨","brief":"æ‹±é–€ã€ç™½ç‰†ã€è—ç™½å°æ¯”"},
  {"code":"è¼•å¥¢å¤å…¸é¢¨","name":"è¼•å¥¢å¤å…¸é¢¨","brief":"ç·šæ¿é€ å‹ã€é‡‘å±¬é»ç¶´ã€é«˜é›…æè³ª"},
  {"code":"æ··æ­é¢¨","name":"æ··æ­é¢¨","brief":"å¤šç¨®é¢¨æ ¼èåˆã€å‰µæ„å¸ƒå±€"},
  {"code":"é„‰æ‘é¢¨","name":"é„‰æ‘é¢¨","brief":"ç²—ç·æœ¨è³ªã€æº«æš–è‰²èª¿"},
  {"code":"æ¥µç°¡é¢¨","name":"æ¥µç°¡é¢¨","brief":"ç©ºé–“ç•™ç™½ã€æ¥µç°¡å®¶å…·"},
  {"code":"ç¾ä»£å¥¢è¯é¢¨","name":"ç¾ä»£å¥¢è¯é¢¨","brief":"é«˜ç´šæè³ªã€å¤§è†½è‰²å½©"},
  {"code":"è—è¡“å¾©å¤é¢¨","name":"è—è¡“å¾©å¤é¢¨","brief":"è—è¡“æ„Ÿå¼·çƒˆã€å¤å…¸å®¶å…·"}
];

(function(){ const _default='https://oldroomchange-image3.onrender.com'; window.API_BASE=window.API_BASE||_default; })();
const ABS = (u)=> u?.startsWith('http') ? u : (window.API_BASE + u);
const $  = (q)=> document.querySelector(q);
const $$ = (q)=> [...document.querySelectorAll(q)];

const state = {
  image:null, maskVersion:null, lockLayer:null,
  styles:[], selectedStyles:new Set(),
  palette:{main:'#ffd1dc', accents:['#bfe9ff']},
  variants:[], selectedResultId:null,
  fmask:null, mapUrlToId:{}, mapIdToStyle:{}
};
</script>
</head>
<body>
<div class="wrap" id="app">

  <div class="c-card">
    <div class="c-title"><span class="b">â‘ </span> ä¸Šå‚³èˆŠå±‹ç…§ç‰‡ï¼ˆâ‰¤2MBï¼‰</div>
    <div class="help">é¸æª”å¾Œç«‹å³é è¦½ã€‚è‹¥ >2MB æœƒè‡ªå‹•å£“ç¸®å¾Œå†ä¸Šå‚³ã€‚</div>
    <div class="toolbar" style="margin:8px 0;">
      <label class="tool">ğŸ“· é¸æ“‡æª”æ¡ˆ <input id="file" type="file" accept="image/png,image/jpeg" style="display:none"></label>
      <span id="uploadStatus" class="badge">å°šæœªä¸Šå‚³</span>
    </div>
    <img id="preview" class="preview half" alt="é è¦½">
    <hr class="c">
    <div class="toolbar">
      <label class="pill">ç©ºé–“
        <select id="roomTypeSel" class="tool" style="margin-left:6px">
          <option value="living">å®¢å»³</option>
          <option value="bedroom">è‡¥å®¤</option>
          <option value="study">æ›¸æˆ¿</option>
          <option value="dining">é¤å»³</option>
          <option value="kitchen">å»šæˆ¿</option>
          <option value="bathroom">è¡›æµ´</option>
          <option value="balcony">é™½å°</option>
          <option value="entry">ç„é—œ</option>
          <option value="corridor">èµ°å»Š</option>
        </select>
      </label>
      <label class="tool" id="flagTv" style="display:inline-flex;align-items:center"><input type="checkbox" id="hasTV" checked> éœ€è¦ TV ç‰†ï¼ˆå»ºç«‹æˆ–ä¿ç•™ï¼‰</label>
      <label class="tool" id="flagWD" style="display:none;align-items:center"><input type="checkbox" id="allowWD"> å¯è¡Œä¹¾æ¿•åˆ†é›¢</label>
      <label class="tool" id="flagNewF" style="display:inline-flex;align-items:center"><input type="checkbox" id="allowNewFur"> ç©ºæˆ¿è‡ªå‹•é…ç½®åŸºæœ¬å®¶å…·ï¼ˆåƒ…æ¯›èƒšå±‹/ç©ºæˆ¿ç”Ÿæ•ˆï¼‰</label>
    </div>
    <div class="help">æç¤ºï¼šä¸Šé¢çš„ã€Œç©ºæˆ¿è‡ªå‹•é…ç½®åŸºæœ¬å®¶å…·ã€åƒ…åœ¨<strong>æ¯›èƒšå±‹/ç©ºæˆ¿</strong>ã€ä¸”åµæ¸¬ä¸åˆ°å®¶å…·éŒ¨é»æ™‚ç”Ÿæ•ˆï¼›æœ‰ç¾æœ‰å®¶å…·æ™‚åªæœƒæ›æè³ª/é¡è‰²ã€‚</div>
    
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘¡</span> è‡ªå‹•çµæ§‹ï¼‹æ·±åº¦åµæ¸¬</div>
    <div class="toolbar">
      <button id="btnDetect" class="btn">ğŸ” åµæ¸¬æ¢æŸ±ç‰†é–€çª—</button>
      <span id="detectBadge" class="badge">å¾…åµæ¸¬</span>
    </div>
    <hr class="c">
    <div class="help">å®Œæˆå¾Œé¡¯ç¤º <b>åˆä½µé®ç½©</b> èˆ‡é–å®šå€ï¼ˆç¶ ï¼‰é è¦½ã€‚</div>
    <div class="toolbar">
      <label class="tool"><input type="checkbox" id="noMask" checked> ç„¡é®ç½©ï¼ˆåŸåœ–+promptï¼‰</label>
      <span class="help">å‹¾é¸å¾Œå¯ç•¥éåµæ¸¬èˆ‡é®ç½©ï¼Œç›´æ¥ç”¨åŸåœ–ï¼‹æç¤ºè©é€²è¡Œç”Ÿæˆã€‚</span>
    </div>
    <div class="toolbar">
    </div>
    <img id="merged" class="preview half hidden" alt="åˆä½µé®ç½©">
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘¢</span> é®ç½©æœ€å¾Œä¿®æ­£ï¼ˆç•«<b style="color:#1ebe6b">ç¶ </b>=ä¸å¯è®Šå‹•ï¼‰</div>
    <div class="help">ç•«å¸ƒé¡¯ç¤ºåŠå¯¬ï¼Œæ¸¸æ¨™èˆ‡è½ç­†ä½ç½® 1:1 å°é½Šã€‚</div>
    <div class="toolbar">
      <button class="tool" id="toolDraw">ğŸ–Œï¸ ç¹ªè£½ï¼ˆç¶ ï¼‰</button>
      <button class="tool" id="toolErase">ğŸ§½ æ©¡çš®æ“¦</button>
      <label class="tool">ç­†åˆ·<input id="brush" type="range" min="6" max="60" value="22" style="vertical-align:middle"></label>
      <button id="btnUndo" class="tool">â†©ï¸ å¾©åŸ</button>
      <button id="btnCommitMask" class="btn">âœ… é€å‡ºæœ€çµ‚é®ç½©</button>
      <span id="maskBadge" class="badge">æœªæäº¤</span>
    </div>
    <div class="canvas-wrap">
      <div class="canvas-stack half" id="editStack">
        <canvas id="editCanvas" height="0"></canvas>
        <canvas id="editCursor" height="0"></canvas>
      </div>
    </div>
    <div class="help">æ¨™ç¤ºï¼šç¶ è‰²è¦†ç–Šï¼é–å®šä¸å¯è®Šå‹•ï¼ˆè³‡æ–™å±¤ï¼ç™½:é–å®šï¼é€æ˜:å¯æ”¹ï¼‰ã€‚</div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘£</span> é¸é¢¨æ ¼ï¼ˆâ‰¤3ï¼‰èˆ‡è‰²å¡ï¼ˆ1ä¸»ï¼‹1~3é…ï¼‰</div>
    <div id="styleList" class="grid-3"></div>
    <hr class="c">
    <div class="toolbar">
      <span class="pill">ğŸ¨ ä¸»è‰²</span>
      <input type="color" id="mainColor" value="#ffd1dc" style="width:32px;height:32px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer">
      <div class="nowrap-group">
        <span class="pill">é…è‰²</span>
        <div id="accents"></div>
      </div>
      <button id="addAccent" class="tool">ï¼‹æ–°å¢é…è‰²</button>
      <button id="removeAccent" class="tool">ï¼ç§»é™¤é…è‰²</button>
    </div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘¤</span> ç”Ÿæˆ 1â€“3 å¼µæ–°é¢¨æ ¼åœ–ï¼ˆgpt-image-1ï¼‰</div>
    <div class="toolbar">
      <button id="btnGenerate" class="btn">ğŸŒŸ é–‹å§‹ç”Ÿæˆ</button>
      <span id="genBadge" class="badge">å¾…ç”Ÿæˆ</span>
    </div>
    <div id="variants" class="grid-3" style="margin-top:10px"></div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘¥</span> å››æ ¼æ¯”å°ç‰†ï¼ˆåŸåœ–ï¼‹æœ€å¤š 3 å¼µè®Šé«”ï¼‰</div>
    <div id="compare" class="grid-3" style="margin-top:10px"></div>
    <div class="help">æ¯æ ¼å³ä¸Šè§’ â¬‡ï¸ å¯ä¸‹è¼‰ï¼ˆçš†å«å£¹å®… LOGOï¼‰ã€‚</div>
    <div class="toolbar" style="margin-top:8px">
      <button id="btnGrid" class="btn">ğŸ§© ä¸‹è¼‰ 2Ã—2 åˆä½µåœ–</button>
      <span class="help">å°‡ã€ŒåŸåœ–ï¼‹æœ€å¤š 3 å¼µè®Šé«”ã€åˆä½µæˆå–®å¼µ PNGã€‚</span>
    </div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">â‘¦</span> å®¶å…·ç·¨ä¿®ï¼ˆå…ˆåœ¨â‘¥é¸ä¸€å¼µï¼‰</div>
    <div class="help">å…ˆåœ¨ä¸Šä¸€æ­¥<b>é»é¸ä¸€å¼µå–œæ­¡çš„é¢¨æ ¼åœ–</b>ã€‚ä¹‹å¾Œç”¨ç•«ç­†æå‡ºè¦ç·¨ä¿®çš„ç¯„åœï¼ˆé»‘=å¯ç·¨ä¿®ã€ç™½=é–å®šï¼‰ã€‚</div>
    <div class="toolbar">
      <div class="seg" id="fActionSeg">
        <button data-act="add" class="tool active">æ–°å¢</button>
        <button data-act="swap" class="tool">æ›´æ›</button>
        <button data-act="recolor" class="tool">æ”¹è‰²</button>
      </div>
      <input id="fObject" class="tool" placeholder="å®¶å…·æè¿°æˆ–åç¨±ï¼ˆä¾‹ï¼šmodern sofaï¼‰"/>
      <span class="pill">é¡è‰² <input id="fColor" type="color" value="#cc9966" style="width:28px;height:28px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer"/></span>
      <button class="tool" id="fToolDraw">ğŸ–Œï¸ ç¹ªè£½ï¼ˆé»‘ï¼‰</button>
      <button class="tool" id="fToolErase">ğŸ§½ æ©¡çš®æ“¦ï¼ˆç™½ï¼‰</button>
      <label class="tool">ç­†åˆ·<input id="fBrush" type="range" min="6" max="60" value="22" style="vertical-align:middle"></label>
      <button id="btnFMaskClear" class="tool">ğŸ§¼ æ¸…ç©ºé¸å€</button>
      <button id="btnFurniture" class="btn" disabled>ğŸ›‹ï¸ å¥—ç”¨å®¶å…·</button>
    </div>

    <div class="small chips" id="fQuick" style="margin-top:6px">
      <span class="chip tool" data-obj="ç¾ä»£é¢¨ æ²™ç™¼">æ²™ç™¼</span>
      <span class="chip tool" data-obj="å›ºå®šå¼ é›»è¦–æ«ƒ">é›»è¦–æ«ƒ</span>
      <span class="chip tool" data-obj="èŒ¶å‡ ">èŒ¶å‡ </span>
      <span class="chip tool" data-obj="åœ°æ¯¯">åœ°æ¯¯</span>
      <span class="chip tool" data-obj="è½åœ°ç‡ˆ">è½åœ°ç‡ˆ</span>
      <span class="chip tool" data-obj="æ”¶ç´å±•ç¤ºæ«ƒ">å±•ç¤ºæ«ƒ</span>
      <span class="chip tool" data-obj="è—è¡“æ›ç•«">æ›ç•«</span>
    </div>

    <div class="canvas-wrap" style="margin-top:8px">
      <div class="canvas-stack">
        <canvas id="fbaseCanvas" height="0"></canvas>
        <canvas id="fmaskCanvas" height="0"></canvas>
      </div>
      <div class="legend">é»‘è‰²é¸å€ï¼å®¶å…·ç·¨ä¿®ç¯„åœï¼ˆç™½ï¼é–å®šï¼‰</div>
    </div>
    <div id="fResult" class="grid-3" style="margin-top:10px"></div>
  </div>

</div>

<script>
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function compressIfNeeded(file, maxBytes){
  if(file.size<=maxBytes) return file;
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, Math.sqrt(maxBytes / file.size));
  const canvas = document.createElement('canvas'); canvas.width=bmp.width*scale; canvas.height=bmp.height*scale;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0,canvas.width,canvas.height);
  const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  return new File([blob],'compressed.jpg',{type:'image/jpeg'});
}
async function forceDownload(url, filename){
  try{
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename || ('download_'+Date.now());
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }catch(e){ alert('ä¸‹è¼‰å¤±æ•—'); }
}
function canvasPos(canvas, clientX, clientY){
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  return { x: Math.round((clientX - r.left) * scaleX), y: Math.round((clientY - r.top) * scaleY) };
}

(async function loadMeta(){
  try{
    const r = await fetch(window.API_BASE + '/meta/styles'); const d = await r.json();
    state.styles = (Array.isArray(d.styles) && d.styles.length) ? d.styles : FALLBACK_STYLES;
  }catch{ state.styles = FALLBACK_STYLES; }
  renderStyleList();
})();
function renderStyleList(){
  const box = $('#styleList'); box.innerHTML='';
  state.styles.forEach(s=>{
    const id = 's_'+(s.code||s.name);
    const card = document.createElement('label'); card.className='c-card'; card.style.cursor='pointer';
    card.innerHTML = `<div class="small" style="font-weight:900">ğŸ’– ${s.name||s.code}</div>
      <div class="small">${s.brief||''}</div>
      <div style="margin-top:6px"><input type="checkbox" id="${id}" data-code="${s.code||s.name}"> é¸å–</div>`;
    card.querySelector('input').onchange = (e)=>{
      const code = e.target.dataset.code;
      if(e.target.checked){ if(state.selectedStyles.size>=3){ e.target.checked=false; return alert('æœ€å¤šé¸ä¸‰ç¨®'); } state.selectedStyles.add(code); }
      else state.selectedStyles.delete(code);
    };
    box.appendChild(card);
  });
  $('#mainColor').oninput=(e)=> state.palette.main=e.target.value;
  function rerenderAccents(){
    const box = $('#accents'); box.innerHTML='';
    state.palette.accents.forEach((v,i)=>{
      const inp=document.createElement('input'); inp.type='color'; inp.value=v;
      inp.style.width='28px'; inp.style.height='28px'; inp.style.borderRadius='8px'; inp.style.border='2px solid #fff'; inp.style.boxShadow='0 2px 6px #0002'; inp.style.cursor='pointer';
      inp.oninput=(e)=> state.palette.accents[i]=e.target.value; box.appendChild(inp);
    });
  }
  $('#addAccent').onclick=()=>{ if(state.palette.accents.length>=3) return alert('é…è‰²æœ€å¤š 3 å€‹'); state.palette.accents.push('#bfe9ff'); rerenderAccents(); };
  $('#removeAccent').onclick=()=>{ if(state.palette.accents.length<=1) return alert('è‡³å°‘ 1 å€‹é…è‰²'); state.palette.accents.pop(); rerenderAccents(); };
  rerenderAccents();
}

const fileInput = $('#file'), pv = $('#preview'), uploadStatus = $('#uploadStatus');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  pv.src = URL.createObjectURL(f);
  const file = await compressIfNeeded(f, 2*1024*1024);
  const fd = new FormData(); fd.append('file', file);
  uploadStatus.textContent='ä¸Šå‚³ä¸­â€¦';
  try{
    const r = await fetch(window.API_BASE+'/upload',{method:'POST',body:fd});
    if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
    const d = await r.json();
    state.image={id:d.image_id,w:d.w,h:d.h,previewURL:pv.src};
    uploadStatus.textContent='å·²ä¸Šå‚³ âœ”';
    await initEditCanvas();
    await initFurnitureCanvas();
    renderCompare();
  }catch(err){ console.error(err); alert('ä¸Šå‚³å¤±æ•—'); uploadStatus.textContent='ä¸Šå‚³å¤±æ•—'; }
});

async function initEditCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#editCanvas'), cur = $('#editCursor');
  cv.width = base.width; cv.height = base.height;
  cur.width = base.width; cur.height = base.height;
  cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
  state.lockLayer = document.createElement('canvas'); state.lockLayer.width=cv.width; state.lockLayer.height=cv.height;
  state.lockLayer.getContext('2d').clearRect(0,0,cv.width,cv.height);
  setupEditCursor();
  redrawEditCanvas();
}
async function initFurnitureCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#fbaseCanvas'), mk = $('#fmaskCanvas');
  cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
  cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
  state.fmask = document.createElement('canvas'); state.fmask.width=mk.width; state.fmask.height=mk.height;
  const _fmctx=state.fmask.getContext('2d'); _fmctx.fillStyle='#fff'; _fmctx.fillRect(0,0,state.fmask.width,state.fmask.height);
}

$('#btnDetect').addEventListener('click', async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
  if(document.querySelector('#noMask')?.checked){
    $('#detectBadge').textContent = 'å·²ç•¥éï¼ˆç„¡é®ç½©ï¼‰';
    return;
  }
  $('#detectBadge').textContent = 'åµæ¸¬ä¸­â€¦';
  try{
    const r = await fetch(window.API_BASE + '/detect', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ image_id: state.image.id })
    });
    const d = await r.json();
    state.maskVersion = d.mask_version;
    $('#detectBadge').textContent = 'å®Œæˆ âœ”';
    $('#merged').src = ABS(d.merged_overlay);
    $('#merged').classList.remove('hidden');

    // è¼‰å…¥ lock_mask ä¸¦ç•«åˆ° lockLayerï¼ˆç™½=é–å®šï¼‰
    const lockImg = await loadImage(ABS(d.lock_mask));
    const lctx = state.lockLayer.getContext('2d');
    lctx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height);
    lctx.drawImage(lockImg,0,0,state.lockLayer.width,state.lockLayer.height);

    // æŠŠç°éšè½‰æˆç™½è‰²é®ç½©ï¼ˆalpha=255 è¡¨ç¤ºé–å®šï¼‰ä»¥ä¾¿å¾ŒçºŒç¶ è‰²è¦†ç–Š
    const w = state.lockLayer.width, h = state.lockLayer.height;
    const img = lctx.getImageData(0,0,w,h), dt = img.data;
    for (let i=0; i<dt.length; i+=4) {
      const v = (dt[i]+dt[i+1]+dt[i+2])/3;
      const locked = v > 127;
      dt[i]=255; dt[i+1]=255; dt[i+2]=255; dt[i+3]= locked ? 255 : 0;
    }
    lctx.putImageData(img,0,0);
    redrawEditCanvas();
  }catch(err){
    console.error(err);
    alert('åµæ¸¬å¤±æ•—');
    $('#detectBadge').textContent = 'å¤±æ•—';
  }
});

let drawMode = 'draw';
$('#toolDraw').onclick=()=>{ drawMode='draw'; };
$('#toolErase').onclick=()=>{ drawMode='erase'; };

function setupEditCursor(){
  const cv = $('#editCanvas'), cur = $('#editCursor'); if(!cv || !cur) return;
  function syncSize(){
    cur.width = cv.width; cur.height = cv.height;
    const s = getComputedStyle(cv); cur.style.width = s.width; cur.style.height = s.height;
  }
  syncSize(); window.addEventListener('resize', syncSize);

  const cctx = cur.getContext('2d');
  function renderCircle(clientX, clientY){
    const p = canvasPos(cv, clientX, clientY);
    cctx.clearRect(0,0,cur.width,cur.height);
    const r = (+$('#brush').value)/2;
    cctx.beginPath(); cctx.arc(p.x, p.y, r, 0, Math.PI*2);
    cctx.lineWidth = 2;
    cctx.strokeStyle = (drawMode==='erase') ? 'rgba(255,120,0,.95)' : 'rgba(30,190,107,.95)';
    cctx.stroke();
  }
  cv.addEventListener('mousemove', e=> renderCircle(e.clientX, e.clientY), {passive:true});
  cv.addEventListener('mouseleave', ()=> cctx.clearRect(0,0,cur.width,cur.height), {passive:true});
  cv.addEventListener('touchmove', e=>{ if(!e.touches.length) return; const t=e.touches[0]; renderCircle(t.clientX,t.clientY); }, {passive:true});
}

const editCanvas = $('#editCanvas');
let drawing=false, last=null;
function drawDot(x,y){ drawLine({x,y},{x:x+.1,y:y+.1}); }
function drawLine(a,b){
  const c = state.lockLayer; const cx=c.getContext('2d');
  cx.lineCap='round'; cx.lineJoin='round'; cx.lineWidth = +$('#brush').value;
  if(drawMode==='draw'){ cx.globalCompositeOperation='source-over'; cx.strokeStyle='white'; }
  else{ cx.globalCompositeOperation='destination-out'; cx.strokeStyle='rgba(0,0,0,1)'; }
  cx.beginPath(); cx.moveTo(a.x,a.y); cx.lineTo(b.x,b.y); cx.stroke(); cx.globalCompositeOperation='source-over';
  redrawEditCanvas();
}
function redrawEditCanvas(){
  if(!state.image) return;
  loadImage(state.image.previewURL).then(base=>{
    const cv=editCanvas, cx=cv.getContext('2d'); cx.clearRect(0,0,cv.width,cv.height); cx.drawImage(base,0,0,cv.width,cv.height);
    const tint = document.createElement('canvas'); tint.width=state.lockLayer.width; tint.height=state.lockLayer.height;
    const tx = tint.getContext('2d'); tx.drawImage(state.lockLayer,0,0);
    tx.globalCompositeOperation='source-in'; tx.fillStyle='rgba(30,190,107,0.85)'; tx.fillRect(0,0,tint.width,tint.height);
    cx.drawImage(tint,0,0);
  });
}
editCanvas.addEventListener('mousedown', (e)=>{ if(!state.lockLayer) return; drawing=true; const p=canvasPos(editCanvas,e.clientX,e.clientY); last=p; pushLockHistory(); drawDot(p.x,p.y); });
window.addEventListener('mouseup', ()=>{ drawing=false; });
editCanvas.addEventListener('mousemove', (e)=>{ if(!drawing) return; const p=canvasPos(editCanvas,e.clientX,e.clientY); drawLine(last,p); last=p; });
editCanvas.addEventListener('touchstart', (e)=>{ if(!e.touches.length||!state.lockLayer) return; const t=e.touches[0]; drawing=true; const p=canvasPos(editCanvas,t.clientX,t.clientY); last=p; pushLockHistory(); drawDot(p.x,p.y); }, {passive:true});
editCanvas.addEventListener('touchmove', (e)=>{ if(!e.touches.length||!drawing) return; const t=e.touches[0]; const p=canvasPos(editCanvas,t.clientX,t.clientY); drawLine(last,p); last=p; }, {passive:true});
editCanvas.addEventListener('touchend', ()=>{ drawing=false; }, {passive:true});

state._lockHist = [];
function pushLockHistory(){ state._lockHist.push(state.lockLayer.toDataURL()); if(state._lockHist.length>25) state._lockHist.shift(); }
$('#btnUndo').onclick=()=>{
  const last = state._lockHist.pop(); if(!last) return;
  loadImage(last).then(img=>{ const cx=state.lockLayer.getContext('2d'); cx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height); cx.drawImage(img,0,0); redrawEditCanvas(); });
};

$('#btnCommitMask').onclick=async()=>{
  if(!state.image) return;
  $('#maskBadge').textContent='æäº¤ä¸­â€¦';
  const _mask = document.createElement('canvas'); _mask.width=state.lockLayer.width; _mask.height=state.lockLayer.height;
  const _mx = _mask.getContext('2d'); _mx.drawImage(state.lockLayer,0,0);
  const _im = _mx.getImageData(0,0,_mask.width,_mask.height); const _dt=_im.data;
  for(let i=0;i<_dt.length;i+=4){ const a=_dt[i+3]; const v = a>32 ? 255 : 0; _dt[i]=v; _dt[i+1]=v; _dt[i+2]=v; _dt[i+3]=255; }
  _mx.putImageData(_im,0,0);
  const fd=new FormData(); fd.append('image_id', state.image.id);
  const blob = await new Promise(res=>_mask.toBlob(res,'image/png')); fd.append('lock_mask', blob, 'lock.png');
  try{
    const r=await fetch(window.API_BASE+'/mask/commit',{method:'POST', body:fd});
    if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
    const d=await r.json(); state.maskVersion=d.mask_version; $('#maskBadge').textContent='å·²æäº¤ v'+d.mask_version+' âœ”';
  }catch(e){ console.error(e); $('#maskBadge').textContent='å¤±æ•—'; alert('æäº¤å¤±æ•—'); }
};

$('#btnGenerate').onclick = async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³');
  if(!state.maskVersion && !document.querySelector('#noMask')?.checked) return alert('è«‹å…ˆå®Œæˆåµæ¸¬èˆ‡é®ç½©æäº¤ï¼›æˆ–å‹¾é¸ã€Œç„¡é®ç½©ï¼ˆåŸåœ–+promptï¼‰ã€');
  if(state.selectedStyles.size===0) return alert('è«‹è‡³å°‘é¸ 1 ç¨®é¢¨æ ¼');
  $('#genBadge').textContent='ç”Ÿæˆä¸­â€¦';

  state.variants = [];
  state.mapUrlToId = {};
  state.mapIdToStyle = {};
  renderVariants();
  renderCompare();

  const styles = [...state.selectedStyles];
  for (let i=0; i<styles.length; i++){
    const st = styles[i];
    const useNoMask = document.querySelector('#noMask')?.checked;
    const body = { image_id: state.image.id, styles: [st],
      palette: { main: state.palette.main, accents: state.palette.accents },
      logo: true };
    if(!useNoMask && state.maskVersion){ body.mask_version = state.maskVersion; }
    try{
      const r=await fetch(window.API_BASE+'/generate',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
      const d=await r.json();
      const got = d.variants||[];
      got.forEach(v=>{
        const url = ABS(v.url);
        if(v.result_id) state.mapUrlToId[url] = v.result_id;
        if(v.result_id && v.style) state.mapIdToStyle[v.result_id] = v.style;
      });
      state.variants.push(...got);
      renderVariants(); renderCompare();
      $('#genBadge').textContent=`å·²å®Œæˆ ${i+1}/${styles.length} å¼µ`;
    }catch(err){ console.error(err); alert(`ç”Ÿæˆã€Œ${st}ã€å¤±æ•—ï¼š`+err.message); }
  }
  $('#genBadge').textContent='å®Œæˆ âœ”';
};

function renderVariants(){
  const box=$('#variants'); box.innerHTML='';
  state.variants.forEach(v=>{
    const url = ABS(v.url);
    if(v.result_id) state.mapUrlToId[url] = v.result_id;
    if(v.result_id && v.style) state.mapIdToStyle[v.result_id] = v.style;

    const card=document.createElement('div'); card.className='c-card';
    const filename = `variant_${v.result_id||''}.png`;
    card.innerHTML = `<div class="card-img">
        <img src="${url}" class="preview" alt="${v.style||''}">
        <a class="dl" href="${url}" download>â¬‡ï¸</a>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <span class="badge">style: ${v.style||'-'}</span>
        <span class="help">è«‹åˆ°ã€Œâ‘¥ å››æ ¼æ¯”å°ç‰†ã€é¸æ“‡æ­¤åœ–</span>
      </div>`;
    card.querySelector('.dl').addEventListener('click', (e)=>{ e.preventDefault(); forceDownload(url, filename); });
    box.appendChild(card);
  });
}

async function renderCompare(){
  const box = $('#compare'); if(!box) return;
  if(!state.image){ box.innerHTML = '<div class="help">è«‹å…ˆä¸Šå‚³åœ–ç‰‡</div>'; return; }
  box.innerHTML = '<div class="help">è¼‰å…¥ä¸­â€¦</div>';
  try{
    const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).filter(Boolean).join(',');
    const r=await fetch(`${window.API_BASE}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    const d=await r.json();
    const items = (d.items||[]);
    box.innerHTML='';
    items.forEach((it, idx)=>{
      const imgURL = ABS(it.url);
      const rid = it.result_id || it.id || state.mapUrlToId[imgURL] || null;
      const styleText = (it.style || it.style_code || (rid? state.mapIdToStyle[rid] : null) || it.name || it.meta?.style || '-');
      const isOriginal = (it.tag === 'base' || it.style === 'original' || idx===0);

      const cell=document.createElement('div'); cell.className='c-card card-img';
      const fileName = (isOriginal?'original':'result') + '_' + (rid||it.id||idx) + '.png';
      cell.innerHTML=`<img src="${imgURL}" class="preview" alt="${styleText}">
        <a class="dl" href="${imgURL}" download>â¬‡ï¸</a>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn select-btn"${(isOriginal||!rid)?' disabled':''}>âœ… é¸æ“‡æ­¤åœ–</button>
          <span class="badge">${isOriginal?'åŸåœ–':'style: '+styleText}</span>
        </div>`;
      cell.querySelector('.dl').addEventListener('click',(e)=>{ e.preventDefault(); forceDownload(imgURL, fileName); });

      const sel = cell.querySelector('.select-btn');
      if(!isOriginal && rid){
        sel.addEventListener('click', async ()=>{
          try{
            const res = await fetch(window.API_BASE+'/select', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ image_id:state.image.id, result_id: rid })
            });
            if(!res.ok) console.warn('å¾Œç«¯ /select å›æ‡‰é 2xxï¼Œä»å˜—è©¦æœ¬åœ°é¸å–ã€‚');
          }catch(e){ console.warn('é¸æ“‡ API å¤±æ•—ï¼Œæ¡æœ¬åœ° fallbackï¼š', e); }
          state.selectedResultId = rid;
          $('#btnFurniture').disabled=false;
          const base = await loadImage(imgURL);
          const cv = $('#fbaseCanvas'), mk = $('#fmaskCanvas');
          cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
          cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
          const v = mk.getContext('2d'); v.clearRect(0,0,mk.width,mk.height);
          const m = state.fmask.getContext('2d'); m.fillStyle='#fff'; m.fillRect(0,0,state.fmask.width,state.fmask.height);
          alert('å·²é¸æ“‡æ­¤åœ–');
        });
      }
      box.appendChild(cell);
    });
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="help">æ¯”å°ç‰†è¼‰å…¥å¤±æ•—</div>';
  }
}

$('#btnGrid').addEventListener('click', async ()=>{
  if(!state.image){ alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡'); return; }
  let data;
  try{
    const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).filter(Boolean).join(',');
    const r=await fetch(`${window.API_BASE}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    data = await r.json();
  }catch(e){ return alert('è®€å–æ¯”å°æ¸…å–®å¤±æ•—'); }
  const urls = (data.items||[]).map(it=>ABS(it.url)).slice(0,4);
  if(!urls.length) return alert('æ²’æœ‰å¯åˆä½µçš„é …ç›®');
  async function loadBmp(u){ const r = await fetch(u,{credentials:'omit'}); if(!r.ok) throw new Error('è®€åœ–å¤±æ•—'); const b = await r.blob(); return await createImageBitmap(b); }
  let bmps=[]; try{ bmps = await Promise.all(urls.map(loadBmp)); }catch(e){ return alert('è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼ˆè«‹ç¢ºèªå¾Œç«¯ CORSï¼‰'); }
  const pad=16, gap=16, tileW=bmps[0].width, tileH=bmps[0].height;
  const W = pad*2 + tileW*2 + gap, H = pad*2 + tileH*2 + gap;
  const cv=document.createElement('canvas'); cv.width=W; cv.height=H; const cx=cv.getContext('2d'); cx.fillStyle='#fff'; cx.fillRect(0,0,W,H);
  const place=[ [pad,pad], [pad+tileW+gap,pad], [pad,pad+tileH+gap], [pad+tileW+gap,pad+tileH+gap] ];
  bmps.forEach((bmp,i)=>{ const [bx,by]=place[i]; const s=Math.min(tileW/bmp.width, tileH/bmp.height); const w=Math.round(bmp.width*s), h=Math.round(bmp.height*s); const x=bx+Math.round((tileW-w)/2), y=by+Math.round((tileH-h)/2); cx.drawImage(bmp,x,y,w,h); });
  cv.toBlob(blob=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`compare_grid_${Date.now()}.png`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }, 'image/png');
});

const fmk = $('#fmaskCanvas');
let fMode='draw';
$('#fToolDraw').onclick=()=>{ fMode='draw'; };
$('#fToolErase').onclick=()=>{ fMode='erase'; };
$('#btnFMaskClear').onclick=()=>{ const c=state.fmask.getContext('2d'); c.fillStyle='#fff'; c.fillRect(0,0,state.fmask.width,state.fmask.height); fmk.getContext('2d').clearRect(0,0,fmk.width,fmk.height); };
$('#fActionSeg').addEventListener('click',(e)=>{ const btn=e.target.closest('button'); if(!btn) return; $$('#fActionSeg button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $('#fActionSeg').dataset.act = btn.dataset.act; });
$('#fQuick').addEventListener('click',(e)=>{ const c=e.target.closest('.chip'); if(!c) return; $('#fObject').value = c.dataset.obj || ''; });

function fpos(e){ return canvasPos(fmk, e.clientX, e.clientY); }
let fDrawing=false, fLast=null;
function fDraw(a,b){
  const m = state.fmask.getContext('2d');
  m.lineCap='round'; m.lineJoin='round'; m.lineWidth = +$('#fBrush').value;
  if(fMode==='draw'){ m.globalCompositeOperation='source-over'; m.strokeStyle='#000'; } else { m.globalCompositeOperation='source-over'; m.strokeStyle='#fff'; }
  m.beginPath(); m.moveTo(a.x,a.y); m.lineTo(b.x,b.y); m.stroke();
  const v = fmk.getContext('2d'); v.clearRect(0,0,fmk.width,fmk.height); v.globalAlpha=0.5; v.drawImage(state.fmask,0,0);
}
fmk.addEventListener('mousedown', e=>{ fDrawing=true; fLast=fpos(e); fDraw(fLast,{x:fLast.x+0.1,y:fLast.y+0.1}); });
window.addEventListener('mouseup', ()=>{ fDrawing=false; });
fmk.addEventListener('mousemove', e=>{ if(!fDrawing) return; const p=fpos(e); fDraw(fLast,p); fLast=p; });
fmk.addEventListener('touchstart', e=>{ if(!e.touches.length) return; const t=e.touches[0]; fDrawing=true; const p=fpos(t); fLast=p; fDraw(fLast,{x:fLast.x+0.1,y:fLast.y+0.1}); }, {passive:true});
fmk.addEventListener('touchmove', e=>{ if(!e.touches.length||!fDrawing) return; const t=e.touches[0]; const p=fpos(t); fDraw(fLast,p); fLast=p; }, {passive:true});
fmk.addEventListener('touchend', ()=>{ fDrawing=false; }, {passive:true});

$('#btnFurniture').onclick=async()=>{
  if(!state.selectedResultId) return alert('è«‹å…ˆåœ¨â‘¥é¸æ“‡ä¸€å¼µè®Šé«”');
  const any = state.fmask.getContext('2d').getImageData(0,0,state.fmask.width,state.fmask.height).data.some(v=>v!==255);
  if(!any){ const mctx=state.fmask.getContext('2d'); mctx.fillStyle='#000'; mctx.fillRect(0,0,state.fmask.width,state.fmask.height); }
  const maskURL = state.fmask.toDataURL('image/png');
  const payload = { image_id:state.image.id, result_id:state.selectedResultId, action:($('#fActionSeg').dataset.act||'add'), object:$('#fObject').value, color:$('#fColor').value, mask_data_url:maskURL };
  try{
    const _f=await fetch(window.API_BASE+'/furniture',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(!_f.ok){ const t=await _f.text(); throw new Error('å®¶å…·æ“ä½œå¤±æ•—ï¼šHTTP '+_f.status+' '+t); }
    const d = await _f.json();
    if(!d.ok && !d.url) throw new Error(d.error||'å®¶å…·æ“ä½œå¤±æ•—');
    const url = ABS(d.url || d.image_url);
    const box = $('#fResult'); const card=document.createElement('div'); card.className='c-card card-img';
    card.innerHTML=`<img src="${url}" class="preview"><div class="toolbar" style="margin-top:8px"><button class="tool dl">â¬‡ï¸ ä¸‹è¼‰</button></div>`;
    box.prepend(card);
    card.querySelector('.dl').addEventListener('click',()=> forceDownload(url, 'furniture_result.png'));
    alert('å®¶å…·ç·¨ä¿®å®Œæˆï¼');
  }catch(err){ console.error(err); alert('å®¶å…·æ“ä½œå¤±æ•—ï¼š'+err.message); }
};
</script>
</body>
</html>