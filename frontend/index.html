<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èˆŠå±‹æ›æ–°é¢¨æ ¼ Â· å®Œæ•´ç‰ˆï¼ˆç¶ =é–å®šãƒ»æ“¦=å¯æ”¹ï¼‰</title>
<!--
èªªæ˜ï¼š
æ­¤å–®æª”å‰ç«¯æä¾› 1~7 æ­¥é©Ÿæµç¨‹ï¼šä¸Šå‚³â†’åµæ¸¬â†’æ‰‹ç¹ªä¿®æ­£â†’é¸é¢¨æ ¼+è‰²å¡â†’ç”Ÿæˆâ†’å››æ ¼æ¯”å°â†’å®¶å…·ç·¨ä¿®ã€‚
æ‰€æœ‰ API çš†å°é½Šå¾Œç«¯ï¼ˆ/upload, /detect/v2â†’/detect fallback, /mask/commit, /generate, /select, /compare, /furniture, /download, /meta/stylesï¼‰ã€‚
-->

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ffd1dc; --mint:#c8f7dc; --lemon:#fff5cc; --sky:#bfe9ff; --ink:#333;
  --bg:#fff; --accent:#ff8fb1; --brand:#ff7aa2; --green:#1ebe6b;
  --radius:18px; --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box} body{margin:0;padding:14px;background:linear-gradient(180deg,#fff,#fff8fb);font-family:"Nunito","Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;display:grid;gap:14px}
.c-card{background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; position:relative; overflow:hidden}
.c-title{font-weight:900; font-size:18px; display:flex; align-items:center; gap:8px}
.c-title .b{background:var(--pink); padding:4px 10px; border-radius:999px}
.btn{border:none; border-radius:999px; padding:10px 14px; background:linear-gradient(120deg,var(--accent),var(--brand)); color:#fff; font-weight:800; box-shadow:var(--shadow); cursor:pointer; transition:transform .05s ease}
.btn:active{transform:translateY(1px)} .btn-ghost{background:#0000;color:var(--ink); border:2px dashed var(--accent)}
.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--lemon); font-weight:800}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--mint); font-size:12px; font-weight:800}
.help{font-size:12px; opacity:.75}
hr.c{border:none; height:1px; background:linear-gradient(90deg,#0000,#0002,#0000); margin:10px 0}
.preview{width:100%; border-radius:12px; border:1px solid #eee; box-shadow:var(--shadow); background:#fff}
.toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.color-chip{width:28px;height:28px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer}
.small{font-size:12px}
.grid-3{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px}
.card-img{position:relative}
.dl{position:absolute; top:10px; right:10px; text-decoration:none; background:#0008; color:#fff; padding:6px 8px; border-radius:8px; font-weight:800}
.tool{background:#fff; border:1px dashed var(--accent); border-radius:999px; padding:8px 12px; cursor:pointer}
.hidden{display:none}

/* canvas å€ */
.canvas-wrap{position:relative}
#editCanvas, #fmaskCanvas{border-radius:12px; border:2px solid #f0f0f0; box-shadow:var(--shadow)}
#fmaskCanvas{position:absolute; left:0; top:0; pointer-events:none}
.legend{position:absolute; left:10px; top:10px; background:#0009; color:#fff; padding:4px 8px; border-radius:8px; font-weight:800}
</style>

<script>
// å¾Œç«¯ API å…¥å£ï¼šå¯ç”¨ window.API_BASE è¦†å¯«ï¼Œé è¨­ç‚º Render ç¶²å€
const BASE_URL = (window.API_BASE||'https://oldroomchange-image3.onrender.com');
/* æŠŠå¾Œç«¯å›å‚³çš„ç›¸å°è·¯å¾‘ï¼ˆ/files/...ï¼‰è½‰ç‚ºçµ•å°ç¶²å€ï¼Œé¿å…åœ¨ Strikingly ç¶²åŸŸä¸‹ç„¡æ³•é¡¯ç¤º */
const ABS = (u)=> u?.startsWith('http') ? u : (BASE_URL + u);
const $ = (q)=>document.querySelector(q); const $$=(q)=>[...document.querySelectorAll(q)];
// å‰ç«¯ç‹€æ…‹ï¼šimageï¼ˆåŸºæœ¬è³‡è¨Šï¼‰ã€lockLayerï¼ˆé–å®šé®ç½©ï¼‰ã€stylesï¼ˆé¢¨æ ¼æ¸…å–®ï¼‰ã€variantsï¼ˆç”Ÿæˆçµæœï¼‰ç­‰
const state = {
  image:null,     // {id,w,h,previewURL}
  maskVersion:null,
  lockLayer:null, // offscreen canvas for "ä¸å¯è®Šå‹•çµæ§‹"
  styles:[], selectedStyles:new Set(), kbVersion:null,
  palette:{main:'#ffd1dc', accents:['#bfe9ff']},
  variants:[], selectedResultId:null,
  fmask:null,    // furniture region offscreen canvas
  fRectSel:false, fRectStart:null
};
</script>
</head>
<body>
<div class="wrap" id="app">

  <!-- â‘  ä¸Šå‚³ï¼šè¶…é 2MB æœƒå…ˆåœ¨ç€è¦½å™¨ç«¯å£“ç¸®å†é€ï¼›æˆåŠŸå¾Œåˆå§‹åŒ–ç•«å¸ƒèˆ‡æ¯”å°ç‰† -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘ </span> ä¸Šå‚³èˆŠå±‹ç…§ç‰‡ï¼ˆâ‰¤2MBï¼‰</div>
    <div class="help">é¸æª”å¾Œç«‹å³é¡¯ç¤ºé è¦½ï¼›è‹¥è¶…é 2MB æœƒå…ˆåœ¨ç€è¦½å™¨ç«¯è‡ªå‹•å£“ç¸®å†ä¸Šå‚³ã€‚</div>
    <div class="toolbar" style="margin:8px 0;">
      <label class="tool">ğŸ“· é¸æ“‡æª”æ¡ˆ <input id="file" type="file" accept="image/png,image/jpeg" style="display:none"></label>
      <span id="uploadStatus" class="badge">å°šæœªä¸Šå‚³</span>
    </div>
    <img id="preview" class="preview" alt="é è¦½å°‡é¡¯ç¤ºæ–¼æ­¤">
  </div>

  <!-- â‘¡ åµæ¸¬ï¼šå„ªå…ˆå‘¼å« /detect/v2ï¼ˆGPT Vision å¤šé‚Šå½¢åˆ†å±¤ï¼‰ï¼Œå¤±æ•—æ‰é€€å› /detectï¼ˆOpenCV/å®‰å…¨é è¨­ï¼‰ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¡</span> è‡ªå‹•çµæ§‹ï¼‹æ·±åº¦åµæ¸¬</div>
    <div class="toolbar">
      <button id="btnDetect" class="btn">ğŸ” åµæ¸¬æ¢æŸ±ç‰†é–€çª—</button>
      <span id="detectBadge" class="badge">å¾…åµæ¸¬</span>
    </div>
    <hr class="c">
    <div class="help">å®Œæˆå¾Œæœƒå‡ºç¾ <b>åˆä½µé®ç½©</b> èˆ‡ã€Œé–å®šçµæ§‹ï¼ˆç¶ ï¼ä¸å¯æ›´æ”¹ï¼‰ã€åœ–å±¤é è¦½ï¼Œä¸‹ä¸€æ­¥é€²å…¥ã€Œæ‰‹ç¹ªä¿®æ­£ã€ã€‚</div>
    <img id="merged" class="preview hidden" alt="åˆä½µé®ç½©é è¦½">
  </div>

  <!-- â‘¢ æ‰‹ç¹ªä¿®æ­£ï¼šåƒ…ç¶­è­·ã€Œä¸å¯è®Šå‹•çµæ§‹ã€çš„é–å®šé®ç½©ï¼ˆç¶ ï¼‰ï¼›æä¾›ç•«ç­†ã€æ©¡çš®æ“¦ã€å¾©åŸï¼›æäº¤æ™‚åªå‚³ lock_mask -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¢</span> é®ç½©æœ€å¾Œä¿®æ­£ï¼ˆåƒ…ç•«ã€Œä¸å¯è®Šå‹•çµæ§‹=ç¶ ã€ï¼‰</div>
    <div class="help">åªéœ€ç•«å‡º<b>ä¸å¯è®Šå‹•çš„çµæ§‹</b>ï¼ˆé–€çª—ã€æ¨‘æŸ±ã€ç‰†è§’ã€åœ°/å£/å¤©äº¤ç•Œç­‰ï¼‰ï¼›éŒ¯èª¤å¯ç”¨æ©¡çš®æ“¦æ“¦æ‰ã€‚</div>
    <div class="toolbar">
      <button class="tool" id="toolDraw">ğŸ–Œï¸ ç¹ªè£½ï¼ˆç¶ ï¼‰</button>
      <button class="tool" id="toolErase">ğŸ§½ æ©¡çš®æ“¦</button>
      <label class="tool">ç­†åˆ·<input id="brush" type="range" min="6" max="60" value="22" style="vertical-align:middle"></label>
      <button id="btnUndo" class="tool">â†©ï¸ å¾©åŸ</button>
      <button id="btnCommitMask" class="btn">âœ… é€å‡ºæœ€çµ‚é®ç½©</button>
      <span id="maskBadge" class="badge">æœªæäº¤</span>
    </div>
    <div class="canvas-wrap">
      <canvas id="editCanvas" class="preview" height="0"></canvas>
      <div class="legend">ç¶ è‰²ï¼é–å®šä¸å¯è®Šå‹•</div>
    </div>
  </div>

  <!-- â‘£ é¢¨æ ¼èˆ‡è‰²å¡ï¼šå¾ /meta/styles è®€å– {name, brief}ï¼›æœ€å¤šé¸ 3 ç¨®ï¼›è‰²å¡ç‚º 1 ä¸» + æœ€å¤š 3 é…è‰²ï¼Œå¥—ç”¨è‡³æ‰€æœ‰é¢¨æ ¼ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘£</span> é¸é¢¨æ ¼ï¼ˆâ‰¤3ï¼‰èˆ‡è‰²å¡ï¼ˆ1ä¸»ï¼‹1/2/3é…ï¼‰</div>
    <div id="styleList" class="grid-3"></div>
    <hr class="c">
    <div class="toolbar">
      <span class="pill">ğŸ¨ ä¸»è‰²</span><input type="color" id="mainColor" value="#ffd1dc" class="color-chip">
      <span class="pill">é…è‰²</span><div id="accents"></div>
      <button id="addAccent" class="tool">ï¼‹æ–°å¢é…è‰²</button>
      <button id="removeAccent" class="tool">ï¼ç§»é™¤é…è‰²</button>
    </div>
  </div>

  <!-- â‘¤ ç”Ÿæˆï¼šå‘¼å« /generateï¼ˆgpt-image-1ï¼‰ï¼ŒåŒè‰²å¡å¥—ç”¨åˆ°æ‰€æœ‰é¢¨æ ¼ï¼›è‡ªå‹•ç–Šå£¹å®… LOGOï¼›çµæœå‡ºå¡ç‰‡ï¼Œå¯é¸æ“‡æ­¤åœ–é–‹å•Ÿç¬¬â‘¦æ­¥ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¤</span> ç”Ÿæˆ 1â€“3 å¼µæ–°é¢¨æ ¼åœ–ï¼ˆgpt-image-1ï¼‰</div>
    <div class="toolbar">
      <button id="btnGenerate" class="btn">ğŸŒŸ é–‹å§‹ç”Ÿæˆ</button>
      <span id="genBadge" class="badge">å¾…ç”Ÿæˆ</span>
    </div>
    <div id="variants" class="grid-3" style="margin-top:10px"></div>
  </div>

  <!-- â‘¥ æ¯”å°ç‰†ï¼šæ¥åœ¨ â‘¤ å¾Œï¼›å‘¼å« /compare åˆæˆå››æ ¼ï¼ˆåŸåœ–ï¼‹å‰ä¸‰è®Šé«”ï¼‰ï¼Œæ¯æ ¼å³ä¸Šè§’å¯ä¸‹è¼‰ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¥</span> å››æ ¼æ¯”å°ç‰†ï¼ˆåŸåœ–ï¼‹æœ€å¤š 3 å¼µè®Šé«”ï¼‰</div>
    <div id="compare" class="grid-3" style="margin-top:10px"></div>
    <div class="help">æ¯ä¸€æ ¼å³ä¸Šè§’ â¬‡ï¸ å¯ç›´æ¥ä¸‹è¼‰ï¼ˆçš†å«å£¹å®… LOGOï¼‰ã€‚</div>
<div class="toolbar" style="margin-top:8px">
  <button id="btnGrid" class="btn">ğŸ§© ä¸‹è¼‰ 2Ã—2 åˆä½µåœ–</button>
  <span class="help">å°‡ã€ŒåŸåœ–ï¼‹æœ€å¤š 3 å¼µè®Šé«”ã€åˆä½µæˆå–®å¼µ PNG</span>
</div>
  </div>

  <!-- â‘¦ å®¶å…·ç·¨ä¿®ï¼šå…ˆåœ¨ â‘¤ é¸å®šä¸€å¼µè®Šé«”ä½œç‚ºåº•åœ–ï¼›ä»¥çŸ©å½¢æ¡†é¸ç”¢ç”Ÿ mask_data_urlï¼›å‘¼å« /furniture æ–°å¢/æ›´æ›/æ”¹è‰²ï¼Œç”¢å‡ºå« LOGO çš„çµæœ -->
  <div class="c-card">
    <div class="c-title"><span class="b">â‘¦</span> å®¶å…·ç·¨ä¿®ï¼ˆé¸å®šå¾Œï¼‰</div>
    <div class="help">è«‹å…ˆåœ¨ä¸Šä¸€æ­¥<b>é»é¸ä¸€å¼µå–œæ­¡çš„é¢¨æ ¼åœ–</b>ã€‚å†æ–¼ä¸‹æ–¹ç•«å‡ºéœ€è¦ç·¨ä¿®çš„å€åŸŸï¼Œé¸æ“‡æ–°å¢/æ›¿æ›/æ”¹è‰²å¾Œé€å‡ºã€‚</div>
    <div class="toolbar">
      <select id="fAction" class="tool">
        <option value="add">æ–°å¢</option>
        <option value="swap">æ›´æ›</option>
        <option value="recolor">æ”¹è‰²</option>
      </select>
      <input id="fObject" class="tool" placeholder="å®¶å…·æè¿°æˆ–åç¨±ï¼ˆä¾‹ï¼šmodern sofaï¼‰"/>
      <span class="pill">é¡è‰² <input id="fColor" type="color" value="#cc9966" class="color-chip"/></span>
      <button id="btnFRect" class="tool">ğŸŸ¦ çŸ©å½¢æ¡†é¸</button>
      <button id="btnFMaskClear" class="tool">ğŸ§¼ æ¸…ç©ºé¸å€</button>
      <button id="btnFurniture" class="btn" disabled>ğŸ›‹ï¸ å¥—ç”¨å®¶å…·</button>
    </div>
    <div class="canvas-wrap" style="margin-top:8px">
      <canvas id="fbaseCanvas" class="preview" height="0"></canvas>
      <canvas id="fmaskCanvas" height="0"></canvas>
      <div class="legend">ç™½è‰²é¸å€ï¼å®¶å…·ç·¨ä¿®ç¯„åœ</div>
    </div>
    <div id="fResult" class="grid-3" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* ===== å°å·¥å…· ===== */
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function compressIfNeeded(file, maxBytes){
  if(file.size<=maxBytes) return file;
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, Math.sqrt(maxBytes / file.size));
  const canvas = document.createElement('canvas'); canvas.width=bmp.width*scale; canvas.height=bmp.height*scale;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0,canvas.width,canvas.height);
  const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  return new File([blob],'compressed.jpg',{type:'image/jpeg'});
}
function toBlob(c){ return new Promise(r=>c.toBlob(r,'image/png')); }

/* ===== 0) è¼‰å…¥é¢¨æ ¼ï¼ˆå«æ‘˜è¦ï¼‰ ===== */
(async function loadMeta(){
  try{
    const r=await fetch(BASE_URL+'/meta/styles'); const d=await r.json();
    state.styles = d.styles||[]; state.kbVersion = d.kb_version||'kb';
  }catch{
    state.styles = [{code:'ç¾ä»£é¢¨',name:'ç¾ä»£é¢¨',brief:'ç·šæ¢ç°¡æ½”ã€æè³ªç´”æ·¨'}];
    state.kbVersion = 'kb-local';
  }
  renderStyleList();
})();
function renderStyleList(){
  const box = $('#styleList'); box.innerHTML='';
  state.styles.forEach(s=>{
    const id='s_'+(s.code||s.name);
    const card=document.createElement('label'); card.className='c-card'; card.style.cursor='pointer';
    card.innerHTML = `<div class="small" style="font-weight:900">ğŸ’– ${s.name||s.code}</div>
      <div class="small">${s.brief||''}</div>
      <div style="margin-top:6px"><input type="checkbox" id="${id}" data-code="${s.code||s.name}"> é¸å–</div>`;
    card.querySelector('input').onchange=(e)=>{
      const code=e.target.dataset.code;
      if(e.target.checked){ if(state.selectedStyles.size>=3){ e.target.checked=false; alert('æœ€å¤šé¸ä¸‰ç¨®'); return; } state.selectedStyles.add(code); }
      else state.selectedStyles.delete(code);
    };
    box.appendChild(card);
  });
  // è‰²å¡
  $('#mainColor').oninput=(e)=>state.palette.main=e.target.value;
  const accentsBox = $('#accents');
  function rerenderAccents(){
    accentsBox.innerHTML='';
    state.palette.accents.forEach((v,i)=>{
      const inp=document.createElement('input'); inp.type='color'; inp.value=v; inp.className='color-chip';
      inp.oninput=(e)=>state.palette.accents[i]=e.target.value; accentsBox.appendChild(inp);
    });
  }
  $('#addAccent').onclick=()=>{ if(state.palette.accents.length>=3) return alert('é…è‰²æœ€å¤š 3 å€‹'); state.palette.accents.push('#bfe9ff'); rerenderAccents(); };
  $('#removeAccent').onclick=()=>{ if(state.palette.accents.length<=1) return alert('è‡³å°‘ 1 å€‹é…è‰²'); state.palette.accents.pop(); rerenderAccents(); };
  rerenderAccents();
}

/* ===== 1) ä¸Šå‚³ ===== */
const fileInput = $('#file'), pv = $('#preview'), uploadStatus = $('#uploadStatus');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  pv.src = URL.createObjectURL(f);
  const file = await compressIfNeeded(f, 2*1024*1024);
  const fd = new FormData(); fd.append('file', file);
  uploadStatus.textContent='ä¸Šå‚³ä¸­â€¦';
  try{
    const r = await fetch(BASE_URL+'/upload',{method:'POST',body:fd});
    const d = await r.json();
    state.image={id:d.image_id,w:d.w,h:d.h,previewURL:pv.src};
    uploadStatus.textContent='å·²ä¸Šå‚³ âœ”';
    // åˆå§‹åŒ–æ¯”å°ç‰†ï¼ˆåŸåœ–ï¼‰
    renderCompare();
    // åˆå§‹åŒ–ç•«å¸ƒå°ºå¯¸
    await initEditCanvas();
    await initFurnitureCanvas();
  }catch(err){ alert('ä¸Šå‚³å¤±æ•—'); uploadStatus.textContent='ä¸Šå‚³å¤±æ•—'; }
});

async function initEditCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#editCanvas'); cv.width=base.width; cv.height=base.height;
  const ctx = cv.getContext('2d'); ctx.drawImage(base,0,0,cv.width,cv.height);
  // å»ºç«‹ lockLayerï¼šç™½=é–å®šï¼ˆä¸å¯è®Šå‹•ï¼‰ï¼Œé»‘=å¯ç·¨è¼¯
  state.lockLayer = document.createElement('canvas'); state.lockLayer.width=cv.width; state.lockLayer.height=cv.height;
  const _lctx = state.lockLayer.getContext('2d'); _lctx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height);
}
async function initFurnitureCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#fbaseCanvas'); const mk = $('#fmaskCanvas');
  cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
  cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
  state.fmask = document.createElement('canvas'); state.fmask.width=mk.width; state.fmask.height=mk.height;
}

/* ===== 2) åµæ¸¬ï¼ˆv2 -> v1 å›é€€ï¼‰ ===== */
$('#btnDetect').addEventListener('click', async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡');
  $('#detectBadge').textContent='åµæ¸¬ä¸­â€¦';
  try{
    // å…ˆå˜—è©¦ GPT Vision v2ï¼›è‹¥å¾Œç«¯æœªå•Ÿç”¨æˆ–å¤±æ•—ï¼Œé€€å› v1
    let r = await fetch(BASE_URL+'/detect/v2',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id})});
    if(!r.ok){ r = await fetch(BASE_URL+'/detect',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id})}); }
    const d = await r.json();
    state.maskVersion = d.mask_version;
    $('#detectBadge').textContent='å®Œæˆ âœ”';
    // åˆä½µé®ç½©ï¼ˆå«ç¶ è‰²é–å®šå€é«˜äº®ï¼‰
    $('#merged').src = ABS(d.merged_overlay); $('#merged').classList.remove('hidden');
    // æŠŠé–å®šé®ç½©ï¼ˆç™½=é–å®šï¼‰è®€å…¥ lockLayer ä¾›å¾ŒçºŒç•«/æ“¦
    const lockImg = await loadImage(ABS(d.lock_mask));
    const lctx = state.lockLayer.getContext('2d'); lctx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height); lctx.drawImage(lockImg,0,0,state.lockLayer.width,state.lockLayer.height);
    
// è½‰æ›é»‘ç™½é®ç½©â†’ç™½/é€æ˜ï¼šç™½=é–å®šã€é€æ˜=å¯æ›´æ”¹
(function(){
  const w=state.lockLayer.width,h=state.lockLayer.height;
  const img=lctx.getImageData(0,0,w,h); const dt=img.data;
  for(let i=0;i<dt.length;i+=4){
    const v=(dt[i]+dt[i+1]+dt[i+2])/3;
    const locked = v>127;
    dt[i]=255; dt[i+1]=255; dt[i+2]=255; dt[i+3]= locked?255:0;
  }
  lctx.putImageData(img,0,0);
})();
// æ›´æ–°è¦–è¦ºè¦†ç–Š
    redrawEditCanvas();
  }catch(err){ alert('åµæ¸¬å¤±æ•—'); $('#detectBadge').textContent='å¤±æ•—'; }
});

/* ===== 3) ä¿®æ­£é–å®šé®ç½©ï¼šç•«/æ“¦ ===== */
let drawMode = 'draw'; // draw | erase
$('#toolDraw').onclick=()=>{ drawMode='draw'; };
$('#toolErase').onclick=()=>{ drawMode='erase'; };
$('#brush').oninput=(e)=>{ /* ç”± drawLine è®€å€¼ */ };

const editCanvas = $('#editCanvas');
let drawing=false, last=null; 
editCanvas.addEventListener('mousedown', (e)=>{ drawing=true; last=pos(editCanvas,e); pushLockHistory(); drawDot(last.x,last.y); });
window.addEventListener('mouseup', ()=>{ drawing=false; });
editCanvas.addEventListener('mousemove', (e)=>{ if(!drawing) return; const p=pos(editCanvas,e); drawLine(last,p); last=p; });

function pos(cv, e){ const r=cv.getBoundingClientRect(); return {x:Math.round((e.clientX-r.left)*cv.width/r.width), y:Math.round((e.clientY-r.top)*cv.height/r.height)} }
function drawDot(x,y){ drawLine({x,y},{x:x+.1,y:y+.1}); }
function drawLine(a,b){
  const c = state.lockLayer; const cx=c.getContext('2d');
  cx.lineCap='round'; cx.lineJoin='round';
  cx.lineWidth = +$('#brush').value;
  if(drawMode==='draw'){
    cx.globalCompositeOperation='source-over';
    cx.strokeStyle='white'; // å¯¦éš›è³‡æ–™ï¼šç™½=é–å®šï¼ˆä¸å¯æ›´æ”¹ï¼‰
  }else{
    cx.globalCompositeOperation='destination-out';
    cx.strokeStyle='rgba(0,0,0,1)'; // æ“¦æˆé€æ˜ï¼å¯æ›´æ”¹
  }
  cx.beginPath(); cx.moveTo(a.x,a.y); cx.lineTo(b.x,b.y); cx.stroke();
  cx.globalCompositeOperation='source-over';
  redrawEditCanvas();
}
function redrawEditCanvas(){
  if(!state.image) return;
  loadImage(state.image.previewURL).then(base=>{
    const cv=editCanvas, cx=cv.getContext('2d'); cx.clearRect(0,0,cv.width,cv.height); cx.drawImage(base,0,0,cv.width,cv.height);
    // å°‡ç™½åº•é®ç½©è‘—è‰²ç‚ºé«˜å¯è¦–æ€§ç¶ è‰²ä»¥ä¾¿æª¢è¦–
    const tint = document.createElement('canvas'); tint.width=state.lockLayer.width; tint.height=state.lockLayer.height;
    const tx = tint.getContext('2d'); tx.drawImage(state.lockLayer,0,0);
    tx.globalCompositeOperation='source-in'; tx.fillStyle='rgba(30,190,107,0.85)'; tx.fillRect(0,0,tint.width,tint.height);
    cx.drawImage(tint,0,0);
  });
}
/* å¾©åŸå †ç–Š */
state._lockHist = [];
function pushLockHistory(){ state._lockHist.push(state.lockLayer.toDataURL()); if(state._lockHist.length>25) state._lockHist.shift(); }
$('#btnUndo').onclick=()=>{
  const last = state._lockHist.pop(); if(!last) return;
  loadImage(last).then(img=>{ const cx=state.lockLayer.getContext('2d'); cx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height); cx.drawImage(img,0,0); redrawEditCanvas(); });
};

/* æäº¤ï¼šåƒ…é€ lock_maskï¼›å¾Œç«¯æœƒè‡ªå‹•åæ¨å‡º editable */
$('#btnCommitMask').onclick=async()=>{
  if(!state.image) return;
  $('#maskBadge').textContent='æäº¤ä¸­â€¦';
  const fd=new FormData(); fd.append('image_id', state.image.id); 
  // åªæäº¤ lock_maskï¼ˆä¸å¯è®Šå‹•çµæ§‹ï¼‰ï¼Œå¾Œç«¯æœƒè‡ªå‹•åæ¨å‡º editable
  const blob = await toBlob(state.lockLayer); fd.append('lock_mask', blob, 'lock.png');
  try{
    const r=await fetch(BASE_URL+'/mask/commit',{method:'POST', body:fd});
    const d=await r.json(); state.maskVersion=d.mask_version; $('#maskBadge').textContent='å·²æäº¤ v'+d.mask_version+' âœ”';
  }catch{ $('#maskBadge').textContent='å¤±æ•—'; alert('æäº¤å¤±æ•—'); }
};

/* ===== 5) ç”Ÿæˆè®Šé«” ===== */
$('#btnGenerate').onclick = async ()=>{
  if(!state.image) return alert('è«‹å…ˆä¸Šå‚³');
  if(!state.maskVersion) return alert('è«‹å…ˆå®Œæˆåµæ¸¬èˆ‡é®ç½©æäº¤');
  if(state.selectedStyles.size===0) return alert('è«‹è‡³å°‘é¸ 1 ç¨®é¢¨æ ¼');
  $('#genBadge').textContent='ç”Ÿæˆä¸­â€¦';
  const body = {
    image_id: state.image.id,
    mask_version: state.maskVersion,
    styles: [...state.selectedStyles],
    palette: { main: state.palette.main, accents: state.palette.accents },
    logo: true
  };
  try{
    const r=await fetch(BASE_URL+'/generate',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
    const d=await r.json();
    state.variants = d.variants||[]; renderVariants(); $('#genBadge').textContent='å®Œæˆ âœ”';
    renderCompare();
    // åˆå§‹åŒ– 7: å®¶å…·ç·¨ä¿®åº•åœ–ï¼ˆé¡¯ç¤ºæ‰€é¸åœ–ï¼‰
    if(state.variants[0]){ await initFurnitureCanvas(); }
  }catch{ alert('ç”Ÿæˆå¤±æ•—'); $('#genBadge').textContent='å¤±æ•—'; }
};

function renderVariants(){
  const box=$('#variants'); box.innerHTML='';
  state.variants.forEach(v=>{
    const card=document.createElement('div'); card.className='c-card';
    card.innerHTML = `<div class="card-img">
        <img src="${ABS(v.url)}" class="preview" alt="${v.style}">
        <a class="dl" href="${ABS(v.download_url||v.url)}" download>â¬‡ï¸</a>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn choose">âœ… é¸æ“‡æ­¤åœ–</button>
        <span class="badge">style: ${v.style}</span>
      </div>`;
    card.querySelector('.choose').onclick=async ()=>{
      try{
        await fetch(BASE_URL+'/select',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({image_id:state.image.id, result_id:v.result_id})});
        state.selectedResultId=v.result_id;
        $('#btnFurniture').disabled=false;
        // é¡¯ç¤ºåˆ°å®¶å…·ç·¨ä¿®åº•åœ–
        const base = await loadImage(ABS(v.url));
        const cv = $('#fbaseCanvas'); const mk = $('#fmaskCanvas');
        cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
        cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
        const mctx = mk.getContext('2d'); mctx.clearRect(0,0,mk.width,mk.height);
        const fmx = state.fmask.getContext('2d'); fmx.clearRect(0,0,state.fmask.width,state.fmask.height);
      }catch{ alert('é¸æ“‡å¤±æ•—'); }
    };
    box.appendChild(card);
  });
}

/* ===== 6) å››æ ¼æ¯”å°ç‰† ===== */
async function renderCompare(){
  const box=$('#compare'); box.innerHTML='';
  if(!state.image) return;
  const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).join(',');
  try{
    const r=await fetch(`${BASE_URL}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    const d=await r.json();
    (d.items||[]).forEach(it=>{
      const cell=document.createElement('div'); cell.className='c-card card-img';
      cell.innerHTML=`<img src="${ABS(it.url)}" class="preview"><a class="dl" href="${ABS(it.download_url||it.url)}" download>â¬‡ï¸</a>`;
      box.appendChild(cell);
    });
  }catch{ /* éœé»˜å¤±æ•— */ }
}

/* ===== 7) å®¶å…·ç·¨ä¿®ï¼šçŸ©å½¢é¸å€ â†’ /furniture ===== */
const fbase = $('#fbaseCanvas'), fmk = $('#fmaskCanvas');
$('#btnFRect').onclick=()=>{ state.fRectSel = !state.fRectSel; fmk.style.pointerEvents = state.fRectSel ? 'auto' : 'none'; };
$('#btnFMaskClear').onclick=()=>{ const c=state.fmask.getContext('2d'); c.clearRect(0,0,state.fmask.width,state.fmask.height); fmk.getContext('2d').clearRect(0,0,fmk.width,fmk.height); };

function pos(cv, e){ const r=cv.getBoundingClientRect(); return {x:Math.round((e.clientX-r.left)*cv.width/r.width), y:Math.round((e.clientY-r.top)*cv.height/r.height)} }
let rectStart=null;
fmk.addEventListener('mousedown', (e)=>{
  if(!state.fRectSel) return;
  rectStart = pos(fmk, e);
});
window.addEventListener('mouseup', (e)=>{
  if(!state.fRectSel || !rectStart) return;
  const p = pos(fmk, e);
  const x=Math.min(rectStart.x,p.x), y=Math.min(rectStart.y,p.y), w=Math.abs(p.x-rectStart.x), h=Math.abs(p.y-rectStart.y);
  // è¦–è¦ºå±¤ï¼šç•«æ¡†
  const vctx = fmk.getContext('2d'); vctx.strokeStyle='#fff'; vctx.lineWidth=2; vctx.setLineDash([8,6]); vctx.strokeRect(x,y,w,h);
  // mask å±¤ï¼ˆç™½=æœ‰æ•ˆï¼‰
  const mctx = state.fmask.getContext('2d'); mctx.fillStyle='#fff'; mctx.fillRect(x,y,w,h);
  rectStart=null; state.fRectSel=false; fmk.style.pointerEvents='none';
});

$('#btnFurniture').onclick=async()=>{
  if(!state.selectedResultId) return alert('è«‹å…ˆåœ¨ä¸Šä¸€æ­¥é¸æ“‡ä¸€å¼µè®Šé«”');
  // è‹¥æ²’æ¡†å‡ºä»»ä½•é¸å€ï¼Œå°±ç”¨æ•´å¼µ
  const any = state.fmask.getContext('2d').getImageData(0,0,state.fmask.width,state.fmask.height).data.some(v=>v!==0);
  if(!any){ const mctx=state.fmask.getContext('2d'); mctx.fillStyle='#fff'; mctx.fillRect(0,0,state.fmask.width,state.fmask.height); }
  const maskURL = state.fmask.toDataURL('image/png');
  const payload = { image_id:state.image.id, result_id:state.selectedResultId, action:$('#fAction').value, object:$('#fObject').value, color:$('#fColor').value, mask_data_url:maskURL };
  try{
    const d = await (await fetch(BASE_URL+'/furniture',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})).json();
    if(!d.ok) throw new Error(d.error||'å®¶å…·æ“ä½œå¤±æ•—');
    // é¡¯ç¤ºçµæœèˆ‡ä¸‹è¼‰ï¼ˆå« LOGOï¼‰
    const box = $('#fResult'); const card=document.createElement('div'); card.className='c-card card-img';
    card.innerHTML=`<img src="${ABS(d.url)}" class="preview"><a class="dl" href="${ABS(d.url)}" download>â¬‡ï¸</a>`;
    box.prepend(card);
    alert('å®¶å…·ç·¨ä¿®å®Œæˆï¼å·²è‡ªå‹•è¦†è“‹å£¹å®… LOGOï¼Œå¯ç›´æ¥ä¸‹è¼‰ã€‚');
  }catch(err){ alert('å®¶å…·æ“ä½œå¤±æ•—ï¼š'+err.message); }
};

/* ===== 6b) ä¸‹è¼‰ 2Ã—2 åˆä½µåœ–ï¼ˆå‰ç«¯åˆæˆï¼Œç„¡éœ€å¾Œç«¯æ”¹å‹•ï¼‰ ===== */
$('#btnGrid')?.addEventListener('click', async ()=>{
  if(!state.image){ alert('è«‹å…ˆä¸Šå‚³åœ–ç‰‡'); return; }
  const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).join(',');
  let data;
  try{
    const r=await fetch(`${BASE_URL}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    data = await r.json();
  }catch(e){ alert('è®€å–æ¯”å°æ¸…å–®å¤±æ•—'); return; }
  const urls = (data.items||[]).map(it=>ABS(it.url)).slice(0,4);
  if(urls.length===0){ alert('æ²’æœ‰å¯åˆä½µçš„é …ç›®'); return; }

  // ä»¥ fetch(blob) + createImageBitmap æ–¹å¼è¼‰åœ–ï¼Œé¿å… crossOrigin é€ æˆ canvas æ±¡æŸ“
  async function loadBmp(u){
    const r = await fetch(u, {credentials:'omit'});
    if(!r.ok) throw new Error('è®€åœ–å¤±æ•—');
    const b = await r.blob();
    return await createImageBitmap(b);
  }
  let bmps=[];
  try{
    bmps = await Promise.all(urls.map(loadBmp));
  }catch(e){
    alert('è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼Œå¯èƒ½æ˜¯å¾Œç«¯æœªé–‹å•Ÿ CORSã€‚è«‹æ–¼å¾Œç«¯ /files å•Ÿç”¨ Access-Control-Allow-Origin:*');
    return;
  }
  // è¨­å®šæ¯æ ¼å°ºå¯¸ï¼šä»¥ç¬¬ä¸€å¼µç‚ºåŸºæº–ï¼ˆå‡è¨­ç®¡ç·šç”¢ç‰©å¤§å°ä¸€è‡´ï¼‰ï¼Œä¸¦è¨­ç½®é‚Šè·èˆ‡é–“è·
  const pad = 16, gap = 16;
  const tileW = bmps[0].width, tileH = bmps[0].height;
  const W = pad*2 + tileW*2 + gap;
  const H = pad*2 + tileH*2 + gap;

  const cv = document.createElement('canvas'); cv.width=W; cv.height=H;
  const cx = cv.getContext('2d');
  cx.fillStyle = '#fff'; cx.fillRect(0,0,W,H);

  function drawAt(i, bx, by){
    const bmp = bmps[i];
    // ç­‰æ¯”ç½®ä¸­å¡«æ»¿æ¡†ï¼ˆä¿æŒæ§‹åœ–æ¯”ä¾‹ï¼Œé¿å…æ‰­æ›²ï¼‰
    const rw = tileW / bmp.width, rh = tileH / bmp.height;
    const s = Math.min(rw, rh);
    const w = Math.round(bmp.width * s), h = Math.round(bmp.height * s);
    const x = bx + Math.round((tileW - w)/2), y = by + Math.round((tileH - h)/2);
    cx.drawImage(bmp, x, y, w, h);
  }

  // ä½ç½®ï¼š
  // 0:(L1) åŸåœ–ï¼Œ1:(R1) è®Šé«”1ï¼Œ2:(L2) è®Šé«”2ï¼Œ3:(R2) è®Šé«”3
  drawAt(0, pad, pad);
  if(bmps[1]) drawAt(1, pad + tileW + gap, pad);
  if(bmps[2]) drawAt(2, pad, pad + tileH + gap);
  if(bmps[3]) drawAt(3, pad + tileW + gap, pad + tileH + gap);

  // ä¸‹è¼‰
  cv.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `compare_grid_${Date.now()}.png`;
    a.click();
    URL.revokeObjectURL(a.href);
  }, 'image/png');
});

</script>
</body>
</html>
