<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>舊屋換新風格 · 乾淨修正版（游標對齊＋半寬畫布＋比對牆修正）</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ffd1dc; --mint:#c8f7dc; --lemon:#fff5cc; --sky:#bfe9ff; --ink:#333;
  --bg:#fff; --accent:#ff8fb1; --brand:#ff7aa2; --green:#1ebe6b;
  --radius:18px; --shadow:0 6px 20px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;padding:14px;background:linear-gradient(180deg,#fff,#fff8fb);
  font-family:"Nunito","Noto Sans TC",system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif;color:var(--ink)}
.wrap{max-width:1100px;margin:0 auto;display:grid;gap:14px}
.c-card{background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; position:relative; overflow:hidden}
.c-title{font-weight:900; font-size:18px; display:flex; align-items:center; gap:8px}
.c-title .b{background:var(--pink); padding:4px 10px; border-radius:999px}
.btn{border:none; border-radius:999px; padding:10px 14px; background:linear-gradient(120deg,var(--accent),var(--brand)); color:#fff; font-weight:800; box-shadow:var(--shadow); cursor:pointer; transition:transform .05s ease}
.btn:active{transform:translateY(1px)}
.btn[disabled]{opacity:.5; cursor:not-allowed}
.tool{background:#fff; border:1px dashed var(--accent); border-radius:999px; padding:8px 12px; cursor:pointer}
.pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--lemon); font-weight:800}
.badge{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--mint); font-size:12px; font-weight:800}
.help{font-size:12px; opacity:.75}
hr.c{border:none; height:1px; background:linear-gradient(90deg,#0000,#0002,#0000); margin:10px 0}
.preview{width:100%; border-radius:12px; border:1px solid #eee; box-shadow:var(--shadow); background:#fff}
.grid-3{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:10px}
.card-img{position:relative}
.dl{position:absolute; top:10px; right:10px; text-decoration:none; background:#0008; color:#fff; padding:6px 8px; border-radius:8px; font-weight:800}
.hidden{display:none}

/* 共用工具列 */
.toolbar{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.nowrap-group{ display:inline-flex; align-items:center; gap:8px; flex-wrap:nowrap; }
#accents{ display:inline-flex; align-items:center; gap:6px; }

/* 畫布區 */
.canvas-wrap{ position:relative; width:100%; }
.canvas-stack{ position:relative; display:inline-block; width:100%; }
#editCanvas, #editCursor, #fbaseCanvas, #fmaskCanvas{ display:block; width:100%; height:auto; border-radius:12px; }
#editCanvas, #fbaseCanvas{ border:2px solid #f0f0f0; box-shadow:var(--shadow) }
#editCursor{ position:absolute; left:0; top:0; pointer-events:none; z-index:10 }
#fmaskCanvas{ position:absolute; left:0; top:0; pointer-events:auto; z-index:5 }
.legend{position:absolute; left:10px; top:10px; background:#0009; color:#fff; padding:4px 8px; border-radius:8px; font-weight:800}

/* 讓預覽與編輯畫布顯示半寬（不改內部像素，保持對齊） */
.half{ width:50%!important; max-width:50%!important; }
</style>

<script>
const FALLBACK_STYLES = [
  {"code":"北歐風","name":"北歐風","brief":"簡約線條、自然採光、功能導向"},
  {"code":"現代風","name":"現代風","brief":"幾何分明、極簡收納、玻璃金屬感"},
  {"code":"工業風","name":"工業風","brief":"外露結構、粗獷材質、深色調"},
  {"code":"美式鄉村風","name":"美式鄉村風","brief":"溫馨木作、經典線板、復古細節"},
  {"code":"日式侘寂風","name":"日式侘寂風","brief":"留白、自然材質、不對稱美"},
  {"code":"日式禪風","name":"日式禪風","brief":"對稱、自然光、簡淨材質"},
  {"code":"地中海風","name":"地中海風","brief":"拱門、白牆、藍白對比"},
  {"code":"輕奢古典風","name":"輕奢古典風","brief":"線板造型、金屬點綴、高雅材質"},
  {"code":"混搭風","name":"混搭風","brief":"多種風格融合、創意布局"},
  {"code":"鄉村風","name":"鄉村風","brief":"粗獷木質、溫暖色調"},
  {"code":"極簡風","name":"極簡風","brief":"空間留白、極簡家具"},
  {"code":"現代奢華風","name":"現代奢華風","brief":"高級材質、大膽色彩"},
  {"code":"藝術復古風","name":"藝術復古風","brief":"藝術感強烈、古典家具"}
];

(function(){ const _default='https://oldroomchange-image3.onrender.com'; window.API_BASE=window.API_BASE||_default; })();
const ABS = (u)=> u?.startsWith('http') ? u : (window.API_BASE + u);
const $  = (q)=> document.querySelector(q);
const $$ = (q)=> [...document.querySelectorAll(q)];

const state = {
  image:null, maskVersion:null, lockLayer:null,
  styles:[], selectedStyles:new Set(),
  palette:{main:'#ffd1dc', accents:['#bfe9ff']},
  variants:[], selectedResultId:null,
  fmask:null, mapUrlToId:{}, mapIdToStyle:{}
};
</script>
</head>
<body>
<div class="wrap" id="app">

  <div class="c-card">
    <div class="c-title"><span class="b">①</span> 上傳舊屋照片（≤2MB）</div>
    <div class="help">選檔後立即預覽。若 >2MB 會自動壓縮後再上傳。</div>
    <div class="toolbar" style="margin:8px 0;">
      <label class="tool">📷 選擇檔案 <input id="file" type="file" accept="image/png,image/jpeg" style="display:none"></label>
      <span id="uploadStatus" class="badge">尚未上傳</span>
    </div>
    <img id="preview" class="preview half" alt="預覽">
    <hr class="c">
    <div class="toolbar">
      <label class="pill">空間
        <select id="roomTypeSel" class="tool" style="margin-left:6px">
          <option value="living">客廳</option>
          <option value="bedroom">臥室</option>
          <option value="study">書房</option>
          <option value="dining">餐廳</option>
          <option value="kitchen">廚房</option>
          <option value="bathroom">衛浴</option>
          <option value="balcony">陽台</option>
          <option value="entry">玄關</option>
          <option value="corridor">走廊</option>
        </select>
      </label>
      <label class="tool" id="flagTv" style="display:inline-flex;align-items:center"><input type="checkbox" id="hasTV" checked> 需要 TV 牆（建立或保留）</label>
      <label class="tool" id="flagWD" style="display:none;align-items:center"><input type="checkbox" id="allowWD"> 可行乾濕分離</label>
      <label class="tool" id="flagNewF" style="display:inline-flex;align-items:center"><input type="checkbox" id="allowNewFur"> 空房自動配置基本家具（僅毛胚屋/空房生效）</label>
    </div>
    <div class="help">提示：上面的「空房自動配置基本家具」僅在<strong>毛胚屋/空房</strong>、且偵測不到家具錨點時生效；有現有家具時只會換材質/顏色。</div>
    
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">②</span> 自動結構＋深度偵測</div>
    <div class="toolbar">
      <button id="btnDetect" class="btn">🔍 偵測梁柱牆門窗</button>
      <span id="detectBadge" class="badge">待偵測</span>
    </div>
    <hr class="c">
    <div class="help">完成後顯示 <b>合併遮罩</b> 與鎖定區（綠）預覽。</div>
    <div class="toolbar">
      <label class="tool"><input type="checkbox" id="noMask" checked> 無遮罩（原圖+prompt）</label>
      <span class="help">勾選後可略過偵測與遮罩，直接用原圖＋提示詞進行生成。</span>
    </div>
    <div class="toolbar">
    </div>
    <img id="merged" class="preview half hidden" alt="合併遮罩">
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">③</span> 遮罩最後修正（畫<b style="color:#1ebe6b">綠</b>=不可變動）</div>
    <div class="help">畫布顯示半寬，游標與落筆位置 1:1 對齊。</div>
    <div class="toolbar">
      <button class="tool" id="toolDraw">🖌️ 繪製（綠）</button>
      <button class="tool" id="toolErase">🧽 橡皮擦</button>
      <label class="tool">筆刷<input id="brush" type="range" min="6" max="60" value="22" style="vertical-align:middle"></label>
      <button id="btnUndo" class="tool">↩︎ 復原</button>
      <button id="btnCommitMask" class="btn">✅ 送出最終遮罩</button>
      <span id="maskBadge" class="badge">未提交</span>
    </div>
    <div class="canvas-wrap">
      <div class="canvas-stack half" id="editStack">
        <canvas id="editCanvas" height="0"></canvas>
        <canvas id="editCursor" height="0"></canvas>
      </div>
    </div>
    <div class="help">標示：綠色覆疊＝鎖定不可變動（資料層＝白:鎖定／透明:可改）。</div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">④</span> 選風格（≤3）與色卡（1主＋1~3配）</div>
    <div id="styleList" class="grid-3"></div>
    <hr class="c">
    <div class="toolbar">
      <span class="pill">🎨 主色</span>
      <input type="color" id="mainColor" value="#ffd1dc" style="width:32px;height:32px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer">
      <div class="nowrap-group">
        <span class="pill">配色</span>
        <div id="accents"></div>
      </div>
      <button id="addAccent" class="tool">＋新增配色</button>
      <button id="removeAccent" class="tool">－移除配色</button>
    </div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">⑤</span> 生成 1–3 張新風格圖（gpt-image-1）</div>
    <div class="toolbar">
      <button id="btnGenerate" class="btn">🌟 開始生成</button>
      <span id="genBadge" class="badge">待生成</span>
    </div>
    <div id="variants" class="grid-3" style="margin-top:10px"></div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">⑥</span> 四格比對牆（原圖＋最多 3 張變體）</div>
    <div id="compare" class="grid-3" style="margin-top:10px"></div>
    <div class="help">每格右上角 ⬇︎ 可下載（皆含壹宅 LOGO）。</div>
    <div class="toolbar" style="margin-top:8px">
      <button id="btnGrid" class="btn">🧩 下載 2×2 合併圖</button>
      <span class="help">將「原圖＋最多 3 張變體」合併成單張 PNG。</span>
    </div>
  </div>

  <div class="c-card">
    <div class="c-title"><span class="b">⑦</span> 家具編修（先在⑥選一張）</div>
    <div class="help">先在上一步<b>點選一張喜歡的風格圖</b>。之後用畫筆描出要編修的範圍（黑=可編修、白=鎖定）。</div>
    <div class="toolbar">
      <div class="seg" id="fActionSeg">
        <button data-act="add" class="tool active">新增</button>
        <button data-act="swap" class="tool">更換</button>
        <button data-act="recolor" class="tool">改色</button>
      </div>
      <input id="fObject" class="tool" placeholder="家具描述或名稱（例：modern sofa）"/>
      <span class="pill">顏色 <input id="fColor" type="color" value="#cc9966" style="width:28px;height:28px;border-radius:8px;border:2px solid #fff; box-shadow:0 2px 6px #0002; cursor:pointer"/></span>
      <button class="tool" id="fToolDraw">🖌️ 繪製（黑）</button>
      <button class="tool" id="fToolErase">🧽 橡皮擦（白）</button>
      <label class="tool">筆刷<input id="fBrush" type="range" min="6" max="60" value="22" style="vertical-align:middle"></label>
      <button id="btnFMaskClear" class="tool">🧼 清空選區</button>
      <button id="btnFurniture" class="btn" disabled>🛋️ 套用家具</button>
    </div>

    <div class="small chips" id="fQuick" style="margin-top:6px">
      <span class="chip tool" data-obj="現代風 沙發">沙發</span>
      <span class="chip tool" data-obj="固定式 電視櫃">電視櫃</span>
      <span class="chip tool" data-obj="茶几">茶几</span>
      <span class="chip tool" data-obj="地毯">地毯</span>
      <span class="chip tool" data-obj="落地燈">落地燈</span>
      <span class="chip tool" data-obj="收納展示櫃">展示櫃</span>
      <span class="chip tool" data-obj="藝術掛畫">掛畫</span>
    </div>

    <div class="canvas-wrap" style="margin-top:8px">
      <div class="canvas-stack">
        <canvas id="fbaseCanvas" height="0"></canvas>
        <canvas id="fmaskCanvas" height="0"></canvas>
      </div>
      <div class="legend">黑色選區＝家具編修範圍（白＝鎖定）</div>
    </div>
    <div id="fResult" class="grid-3" style="margin-top:10px"></div>
  </div>

</div>

<script>
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
async function compressIfNeeded(file, maxBytes){
  if(file.size<=maxBytes) return file;
  const bmp = await createImageBitmap(file);
  const scale = Math.min(1, Math.sqrt(maxBytes / file.size));
  const canvas = document.createElement('canvas'); canvas.width=bmp.width*scale; canvas.height=bmp.height*scale;
  const ctx = canvas.getContext('2d'); ctx.drawImage(bmp,0,0,canvas.width,canvas.height);
  const blob = await new Promise(res=>canvas.toBlob(res,'image/jpeg',0.85));
  return new File([blob],'compressed.jpg',{type:'image/jpeg'});
}
async function forceDownload(url, filename){
  try{
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const blob = await res.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename || ('download_'+Date.now());
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }catch(e){ alert('下載失敗'); }
}
function canvasPos(canvas, clientX, clientY){
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  return { x: Math.round((clientX - r.left) * scaleX), y: Math.round((clientY - r.top) * scaleY) };
}

(async function loadMeta(){
  try{
    const r = await fetch(window.API_BASE + '/meta/styles'); const d = await r.json();
    state.styles = (Array.isArray(d.styles) && d.styles.length) ? d.styles : FALLBACK_STYLES;
  }catch{ state.styles = FALLBACK_STYLES; }
  renderStyleList();
})();
function renderStyleList(){
  const box = $('#styleList'); box.innerHTML='';
  state.styles.forEach(s=>{
    const id = 's_'+(s.code||s.name);
    const card = document.createElement('label'); card.className='c-card'; card.style.cursor='pointer';
    card.innerHTML = `<div class="small" style="font-weight:900">💖 ${s.name||s.code}</div>
      <div class="small">${s.brief||''}</div>
      <div style="margin-top:6px"><input type="checkbox" id="${id}" data-code="${s.code||s.name}"> 選取</div>`;
    card.querySelector('input').onchange = (e)=>{
      const code = e.target.dataset.code;
      if(e.target.checked){ if(state.selectedStyles.size>=3){ e.target.checked=false; return alert('最多選三種'); } state.selectedStyles.add(code); }
      else state.selectedStyles.delete(code);
    };
    box.appendChild(card);
  });
  $('#mainColor').oninput=(e)=> state.palette.main=e.target.value;
  function rerenderAccents(){
    const box = $('#accents'); box.innerHTML='';
    state.palette.accents.forEach((v,i)=>{
      const inp=document.createElement('input'); inp.type='color'; inp.value=v;
      inp.style.width='28px'; inp.style.height='28px'; inp.style.borderRadius='8px'; inp.style.border='2px solid #fff'; inp.style.boxShadow='0 2px 6px #0002'; inp.style.cursor='pointer';
      inp.oninput=(e)=> state.palette.accents[i]=e.target.value; box.appendChild(inp);
    });
  }
  $('#addAccent').onclick=()=>{ if(state.palette.accents.length>=3) return alert('配色最多 3 個'); state.palette.accents.push('#bfe9ff'); rerenderAccents(); };
  $('#removeAccent').onclick=()=>{ if(state.palette.accents.length<=1) return alert('至少 1 個配色'); state.palette.accents.pop(); rerenderAccents(); };
  rerenderAccents();
}

const fileInput = $('#file'), pv = $('#preview'), uploadStatus = $('#uploadStatus');
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  pv.src = URL.createObjectURL(f);
  const file = await compressIfNeeded(f, 2*1024*1024);
  const fd = new FormData(); fd.append('file', file);
  uploadStatus.textContent='上傳中…';
  try{
    const r = await fetch(window.API_BASE+'/upload',{method:'POST',body:fd});
    if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
    const d = await r.json();
    state.image={id:d.image_id,w:d.w,h:d.h,previewURL:pv.src};
    uploadStatus.textContent='已上傳 ✔';
    await initEditCanvas();
    await initFurnitureCanvas();
    renderCompare();
  }catch(err){ console.error(err); alert('上傳失敗'); uploadStatus.textContent='上傳失敗'; }
});

async function initEditCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#editCanvas'), cur = $('#editCursor');
  cv.width = base.width; cv.height = base.height;
  cur.width = base.width; cur.height = base.height;
  cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
  state.lockLayer = document.createElement('canvas'); state.lockLayer.width=cv.width; state.lockLayer.height=cv.height;
  state.lockLayer.getContext('2d').clearRect(0,0,cv.width,cv.height);
  setupEditCursor();
  redrawEditCanvas();
}
async function initFurnitureCanvas(){
  const base = await loadImage(state.image.previewURL);
  const cv = $('#fbaseCanvas'), mk = $('#fmaskCanvas');
  cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
  cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
  state.fmask = document.createElement('canvas'); state.fmask.width=mk.width; state.fmask.height=mk.height;
  const _fmctx=state.fmask.getContext('2d'); _fmctx.fillStyle='#fff'; _fmctx.fillRect(0,0,state.fmask.width,state.fmask.height);
}

$('#btnDetect').addEventListener('click', async ()=>{
  if(!state.image) return alert('請先上傳圖片');
  if(document.querySelector('#noMask')?.checked){
    $('#detectBadge').textContent = '已略過（無遮罩）';
    return;
  }
  $('#detectBadge').textContent = '偵測中…';
  try{
    const r = await fetch(window.API_BASE + '/detect', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ image_id: state.image.id })
    });
    const d = await r.json();
    state.maskVersion = d.mask_version;
    $('#detectBadge').textContent = '完成 ✔';
    $('#merged').src = ABS(d.merged_overlay);
    $('#merged').classList.remove('hidden');

    // 載入 lock_mask 並畫到 lockLayer（白=鎖定）
    const lockImg = await loadImage(ABS(d.lock_mask));
    const lctx = state.lockLayer.getContext('2d');
    lctx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height);
    lctx.drawImage(lockImg,0,0,state.lockLayer.width,state.lockLayer.height);

    // 把灰階轉成白色遮罩（alpha=255 表示鎖定）以便後續綠色覆疊
    const w = state.lockLayer.width, h = state.lockLayer.height;
    const img = lctx.getImageData(0,0,w,h), dt = img.data;
    for (let i=0; i<dt.length; i+=4) {
      const v = (dt[i]+dt[i+1]+dt[i+2])/3;
      const locked = v > 127;
      dt[i]=255; dt[i+1]=255; dt[i+2]=255; dt[i+3]= locked ? 255 : 0;
    }
    lctx.putImageData(img,0,0);
    redrawEditCanvas();
  }catch(err){
    console.error(err);
    alert('偵測失敗');
    $('#detectBadge').textContent = '失敗';
  }
});

let drawMode = 'draw';
$('#toolDraw').onclick=()=>{ drawMode='draw'; };
$('#toolErase').onclick=()=>{ drawMode='erase'; };

function setupEditCursor(){
  const cv = $('#editCanvas'), cur = $('#editCursor'); if(!cv || !cur) return;
  function syncSize(){
    cur.width = cv.width; cur.height = cv.height;
    const s = getComputedStyle(cv); cur.style.width = s.width; cur.style.height = s.height;
  }
  syncSize(); window.addEventListener('resize', syncSize);

  const cctx = cur.getContext('2d');
  function renderCircle(clientX, clientY){
    const p = canvasPos(cv, clientX, clientY);
    cctx.clearRect(0,0,cur.width,cur.height);
    const r = (+$('#brush').value)/2;
    cctx.beginPath(); cctx.arc(p.x, p.y, r, 0, Math.PI*2);
    cctx.lineWidth = 2;
    cctx.strokeStyle = (drawMode==='erase') ? 'rgba(255,120,0,.95)' : 'rgba(30,190,107,.95)';
    cctx.stroke();
  }
  cv.addEventListener('mousemove', e=> renderCircle(e.clientX, e.clientY), {passive:true});
  cv.addEventListener('mouseleave', ()=> cctx.clearRect(0,0,cur.width,cur.height), {passive:true});
  cv.addEventListener('touchmove', e=>{ if(!e.touches.length) return; const t=e.touches[0]; renderCircle(t.clientX,t.clientY); }, {passive:true});
}

const editCanvas = $('#editCanvas');
let drawing=false, last=null;
function drawDot(x,y){ drawLine({x,y},{x:x+.1,y:y+.1}); }
function drawLine(a,b){
  const c = state.lockLayer; const cx=c.getContext('2d');
  cx.lineCap='round'; cx.lineJoin='round'; cx.lineWidth = +$('#brush').value;
  if(drawMode==='draw'){ cx.globalCompositeOperation='source-over'; cx.strokeStyle='white'; }
  else{ cx.globalCompositeOperation='destination-out'; cx.strokeStyle='rgba(0,0,0,1)'; }
  cx.beginPath(); cx.moveTo(a.x,a.y); cx.lineTo(b.x,b.y); cx.stroke(); cx.globalCompositeOperation='source-over';
  redrawEditCanvas();
}
function redrawEditCanvas(){
  if(!state.image) return;
  loadImage(state.image.previewURL).then(base=>{
    const cv=editCanvas, cx=cv.getContext('2d'); cx.clearRect(0,0,cv.width,cv.height); cx.drawImage(base,0,0,cv.width,cv.height);
    const tint = document.createElement('canvas'); tint.width=state.lockLayer.width; tint.height=state.lockLayer.height;
    const tx = tint.getContext('2d'); tx.drawImage(state.lockLayer,0,0);
    tx.globalCompositeOperation='source-in'; tx.fillStyle='rgba(30,190,107,0.85)'; tx.fillRect(0,0,tint.width,tint.height);
    cx.drawImage(tint,0,0);
  });
}
editCanvas.addEventListener('mousedown', (e)=>{ if(!state.lockLayer) return; drawing=true; const p=canvasPos(editCanvas,e.clientX,e.clientY); last=p; pushLockHistory(); drawDot(p.x,p.y); });
window.addEventListener('mouseup', ()=>{ drawing=false; });
editCanvas.addEventListener('mousemove', (e)=>{ if(!drawing) return; const p=canvasPos(editCanvas,e.clientX,e.clientY); drawLine(last,p); last=p; });
editCanvas.addEventListener('touchstart', (e)=>{ if(!e.touches.length||!state.lockLayer) return; const t=e.touches[0]; drawing=true; const p=canvasPos(editCanvas,t.clientX,t.clientY); last=p; pushLockHistory(); drawDot(p.x,p.y); }, {passive:true});
editCanvas.addEventListener('touchmove', (e)=>{ if(!e.touches.length||!drawing) return; const t=e.touches[0]; const p=canvasPos(editCanvas,t.clientX,t.clientY); drawLine(last,p); last=p; }, {passive:true});
editCanvas.addEventListener('touchend', ()=>{ drawing=false; }, {passive:true});

state._lockHist = [];
function pushLockHistory(){ state._lockHist.push(state.lockLayer.toDataURL()); if(state._lockHist.length>25) state._lockHist.shift(); }
$('#btnUndo').onclick=()=>{
  const last = state._lockHist.pop(); if(!last) return;
  loadImage(last).then(img=>{ const cx=state.lockLayer.getContext('2d'); cx.clearRect(0,0,state.lockLayer.width,state.lockLayer.height); cx.drawImage(img,0,0); redrawEditCanvas(); });
};

$('#btnCommitMask').onclick=async()=>{
  if(!state.image) return;
  $('#maskBadge').textContent='提交中…';
  const _mask = document.createElement('canvas'); _mask.width=state.lockLayer.width; _mask.height=state.lockLayer.height;
  const _mx = _mask.getContext('2d'); _mx.drawImage(state.lockLayer,0,0);
  const _im = _mx.getImageData(0,0,_mask.width,_mask.height); const _dt=_im.data;
  for(let i=0;i<_dt.length;i+=4){ const a=_dt[i+3]; const v = a>32 ? 255 : 0; _dt[i]=v; _dt[i+1]=v; _dt[i+2]=v; _dt[i+3]=255; }
  _mx.putImageData(_im,0,0);
  const fd=new FormData(); fd.append('image_id', state.image.id);
  const blob = await new Promise(res=>_mask.toBlob(res,'image/png')); fd.append('lock_mask', blob, 'lock.png');
  try{
    const r=await fetch(window.API_BASE+'/mask/commit',{method:'POST', body:fd});
    if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
    const d=await r.json(); state.maskVersion=d.mask_version; $('#maskBadge').textContent='已提交 v'+d.mask_version+' ✔';
  }catch(e){ console.error(e); $('#maskBadge').textContent='失敗'; alert('提交失敗'); }
};

$('#btnGenerate').onclick = async ()=>{
  if(!state.image) return alert('請先上傳');
  if(!state.maskVersion && !document.querySelector('#noMask')?.checked) return alert('請先完成偵測與遮罩提交；或勾選「無遮罩（原圖+prompt）」');
  if(state.selectedStyles.size===0) return alert('請至少選 1 種風格');
  $('#genBadge').textContent='生成中…';

  state.variants = [];
  state.mapUrlToId = {};
  state.mapIdToStyle = {};
  renderVariants();
  renderCompare();

  const styles = [...state.selectedStyles];
  for (let i=0; i<styles.length; i++){
    const st = styles[i];
    const useNoMask = document.querySelector('#noMask')?.checked;
    const body = { image_id: state.image.id, styles: [st],
      palette: { main: state.palette.main, accents: state.palette.accents },
      logo: true };
    if(!useNoMask && state.maskVersion){ body.mask_version = state.maskVersion; }
    try{
      const r=await fetch(window.API_BASE+'/generate',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+' '+t); }
      const d=await r.json();
      const got = d.variants||[];
      got.forEach(v=>{
        const url = ABS(v.url);
        if(v.result_id) state.mapUrlToId[url] = v.result_id;
        if(v.result_id && v.style) state.mapIdToStyle[v.result_id] = v.style;
      });
      state.variants.push(...got);
      renderVariants(); renderCompare();
      $('#genBadge').textContent=`已完成 ${i+1}/${styles.length} 張`;
    }catch(err){ console.error(err); alert(`生成「${st}」失敗：`+err.message); }
  }
  $('#genBadge').textContent='完成 ✔';
};

function renderVariants(){
  const box=$('#variants'); box.innerHTML='';
  state.variants.forEach(v=>{
    const url = ABS(v.url);
    if(v.result_id) state.mapUrlToId[url] = v.result_id;
    if(v.result_id && v.style) state.mapIdToStyle[v.result_id] = v.style;

    const card=document.createElement('div'); card.className='c-card';
    const filename = `variant_${v.result_id||''}.png`;
    card.innerHTML = `<div class="card-img">
        <img src="${url}" class="preview" alt="${v.style||''}">
        <a class="dl" href="${url}" download>⬇︎</a>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <span class="badge">style: ${v.style||'-'}</span>
        <span class="help">請到「⑥ 四格比對牆」選擇此圖</span>
      </div>`;
    card.querySelector('.dl').addEventListener('click', (e)=>{ e.preventDefault(); forceDownload(url, filename); });
    box.appendChild(card);
  });
}

async function renderCompare(){
  const box = $('#compare'); if(!box) return;
  if(!state.image){ box.innerHTML = '<div class="help">請先上傳圖片</div>'; return; }
  box.innerHTML = '<div class="help">載入中…</div>';
  try{
    const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).filter(Boolean).join(',');
    const r=await fetch(`${window.API_BASE}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    const d=await r.json();
    const items = (d.items||[]);
    box.innerHTML='';
    items.forEach((it, idx)=>{
      const imgURL = ABS(it.url);
      const rid = it.result_id || it.id || state.mapUrlToId[imgURL] || null;
      const styleText = (it.style || it.style_code || (rid? state.mapIdToStyle[rid] : null) || it.name || it.meta?.style || '-');
      const isOriginal = (it.tag === 'base' || it.style === 'original' || idx===0);

      const cell=document.createElement('div'); cell.className='c-card card-img';
      const fileName = (isOriginal?'original':'result') + '_' + (rid||it.id||idx) + '.png';
      cell.innerHTML=`<img src="${imgURL}" class="preview" alt="${styleText}">
        <a class="dl" href="${imgURL}" download>⬇︎</a>
        <div class="toolbar" style="margin-top:8px">
          <button class="btn select-btn"${(isOriginal||!rid)?' disabled':''}>✅ 選擇此圖</button>
          <span class="badge">${isOriginal?'原圖':'style: '+styleText}</span>
        </div>`;
      cell.querySelector('.dl').addEventListener('click',(e)=>{ e.preventDefault(); forceDownload(imgURL, fileName); });

      const sel = cell.querySelector('.select-btn');
      if(!isOriginal && rid){
        sel.addEventListener('click', async ()=>{
          try{
            const res = await fetch(window.API_BASE+'/select', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ image_id:state.image.id, result_id: rid })
            });
            if(!res.ok) console.warn('後端 /select 回應非 2xx，仍嘗試本地選取。');
          }catch(e){ console.warn('選擇 API 失敗，採本地 fallback：', e); }
          state.selectedResultId = rid;
          $('#btnFurniture').disabled=false;
          const base = await loadImage(imgURL);
          const cv = $('#fbaseCanvas'), mk = $('#fmaskCanvas');
          cv.width=base.width; cv.height=base.height; mk.width=base.width; mk.height=base.height;
          cv.getContext('2d').drawImage(base,0,0,cv.width,cv.height);
          const v = mk.getContext('2d'); v.clearRect(0,0,mk.width,mk.height);
          const m = state.fmask.getContext('2d'); m.fillStyle='#fff'; m.fillRect(0,0,state.fmask.width,state.fmask.height);
          alert('已選擇此圖');
        });
      }
      box.appendChild(cell);
    });
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="help">比對牆載入失敗</div>';
  }
}

$('#btnGrid').addEventListener('click', async ()=>{
  if(!state.image){ alert('請先上傳圖片'); return; }
  let data;
  try{
    const varIds = (state.variants||[]).slice(0,3).map(v=>v.result_id).filter(Boolean).join(',');
    const r=await fetch(`${window.API_BASE}/compare?base=${state.image.id}&vars=${varIds}&logo=1`);
    data = await r.json();
  }catch(e){ return alert('讀取比對清單失敗'); }
  const urls = (data.items||[]).map(it=>ABS(it.url)).slice(0,4);
  if(!urls.length) return alert('沒有可合併的項目');
  async function loadBmp(u){ const r = await fetch(u,{credentials:'omit'}); if(!r.ok) throw new Error('讀圖失敗'); const b = await r.blob(); return await createImageBitmap(b); }
  let bmps=[]; try{ bmps = await Promise.all(urls.map(loadBmp)); }catch(e){ return alert('載入圖片失敗（請確認後端 CORS）'); }
  const pad=16, gap=16, tileW=bmps[0].width, tileH=bmps[0].height;
  const W = pad*2 + tileW*2 + gap, H = pad*2 + tileH*2 + gap;
  const cv=document.createElement('canvas'); cv.width=W; cv.height=H; const cx=cv.getContext('2d'); cx.fillStyle='#fff'; cx.fillRect(0,0,W,H);
  const place=[ [pad,pad], [pad+tileW+gap,pad], [pad,pad+tileH+gap], [pad+tileW+gap,pad+tileH+gap] ];
  bmps.forEach((bmp,i)=>{ const [bx,by]=place[i]; const s=Math.min(tileW/bmp.width, tileH/bmp.height); const w=Math.round(bmp.width*s), h=Math.round(bmp.height*s); const x=bx+Math.round((tileW-w)/2), y=by+Math.round((tileH-h)/2); cx.drawImage(bmp,x,y,w,h); });
  cv.toBlob(blob=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`compare_grid_${Date.now()}.png`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); }, 'image/png');
});

const fmk = $('#fmaskCanvas');
let fMode='draw';
$('#fToolDraw').onclick=()=>{ fMode='draw'; };
$('#fToolErase').onclick=()=>{ fMode='erase'; };
$('#btnFMaskClear').onclick=()=>{ const c=state.fmask.getContext('2d'); c.fillStyle='#fff'; c.fillRect(0,0,state.fmask.width,state.fmask.height); fmk.getContext('2d').clearRect(0,0,fmk.width,fmk.height); };
$('#fActionSeg').addEventListener('click',(e)=>{ const btn=e.target.closest('button'); if(!btn) return; $$('#fActionSeg button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $('#fActionSeg').dataset.act = btn.dataset.act; });
$('#fQuick').addEventListener('click',(e)=>{ const c=e.target.closest('.chip'); if(!c) return; $('#fObject').value = c.dataset.obj || ''; });

function fpos(e){ return canvasPos(fmk, e.clientX, e.clientY); }
let fDrawing=false, fLast=null;
function fDraw(a,b){
  const m = state.fmask.getContext('2d');
  m.lineCap='round'; m.lineJoin='round'; m.lineWidth = +$('#fBrush').value;
  if(fMode==='draw'){ m.globalCompositeOperation='source-over'; m.strokeStyle='#000'; } else { m.globalCompositeOperation='source-over'; m.strokeStyle='#fff'; }
  m.beginPath(); m.moveTo(a.x,a.y); m.lineTo(b.x,b.y); m.stroke();
  const v = fmk.getContext('2d'); v.clearRect(0,0,fmk.width,fmk.height); v.globalAlpha=0.5; v.drawImage(state.fmask,0,0);
}
fmk.addEventListener('mousedown', e=>{ fDrawing=true; fLast=fpos(e); fDraw(fLast,{x:fLast.x+0.1,y:fLast.y+0.1}); });
window.addEventListener('mouseup', ()=>{ fDrawing=false; });
fmk.addEventListener('mousemove', e=>{ if(!fDrawing) return; const p=fpos(e); fDraw(fLast,p); fLast=p; });
fmk.addEventListener('touchstart', e=>{ if(!e.touches.length) return; const t=e.touches[0]; fDrawing=true; const p=fpos(t); fLast=p; fDraw(fLast,{x:fLast.x+0.1,y:fLast.y+0.1}); }, {passive:true});
fmk.addEventListener('touchmove', e=>{ if(!e.touches.length||!fDrawing) return; const t=e.touches[0]; const p=fpos(t); fDraw(fLast,p); fLast=p; }, {passive:true});
fmk.addEventListener('touchend', ()=>{ fDrawing=false; }, {passive:true});

$('#btnFurniture').onclick=async()=>{
  if(!state.selectedResultId) return alert('請先在⑥選擇一張變體');
  const any = state.fmask.getContext('2d').getImageData(0,0,state.fmask.width,state.fmask.height).data.some(v=>v!==255);
  if(!any){ const mctx=state.fmask.getContext('2d'); mctx.fillStyle='#000'; mctx.fillRect(0,0,state.fmask.width,state.fmask.height); }
  const maskURL = state.fmask.toDataURL('image/png');
  const payload = { image_id:state.image.id, result_id:state.selectedResultId, action:($('#fActionSeg').dataset.act||'add'), object:$('#fObject').value, color:$('#fColor').value, mask_data_url:maskURL };
  try{
    const _f=await fetch(window.API_BASE+'/furniture',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(!_f.ok){ const t=await _f.text(); throw new Error('家具操作失敗：HTTP '+_f.status+' '+t); }
    const d = await _f.json();
    if(!d.ok && !d.url) throw new Error(d.error||'家具操作失敗');
    const url = ABS(d.url || d.image_url);
    const box = $('#fResult'); const card=document.createElement('div'); card.className='c-card card-img';
    card.innerHTML=`<img src="${url}" class="preview"><div class="toolbar" style="margin-top:8px"><button class="tool dl">⬇︎ 下載</button></div>`;
    box.prepend(card);
    card.querySelector('.dl').addEventListener('click',()=> forceDownload(url, 'furniture_result.png'));
    alert('家具編修完成！');
  }catch(err){ console.error(err); alert('家具操作失敗：'+err.message); }
};
</script>
</body>
</html>