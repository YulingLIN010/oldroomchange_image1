<!DOCTYPE html>
<html lang='zh-Hant'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>Oldroomchange — Strict Embed</title>
</head>
<body>
<div id="orc-container">
  <div id="orc-wrap">
    <div id="orc-left">
      <label id="orc-label" for="fileInput">選擇圖片（≤ 2MB）</label>
      <input id="fileInput" type="file" accept="image/*">
      <div id="status">尚未選擇圖片</div>
      <div id="orc-actions">
        <button id="btnAnalyze" type="button">送出 / analyze</button>
      </div>
    </div>
    <div id="orc-right">
      <div id="orc-stage">
        <canvas id="maskCanvas"></canvas>
        <canvas id="uiCanvas"></canvas>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  // ====== CONFIG ======
  const API_BASE = "https://oldroomchange-image3.onrender.com";        // your backend
  const MAX_MB = 2;                     // 2MB strict limit
  // ====== Helpers ======
  const api = (p)=>{ const base = API_BASE.replace(/\/$/,''); return /^https?:\/\//i.test(p)? p : base + (p.startsWith('/')? p : '/' + p); };
  const css = (el, obj)=>{ if(!el||!obj) return; for(const k in obj) el.style[k]=obj[k]; };
  const $ = (id)=>document.getElementById(id);
  function drawToCanvas(url, maskCan, uiCan){
    return new Promise((resolve,reject)=>{
      const im = new Image();
      im.onload = ()=>{
        const w = im.naturalWidth||im.width, h = im.naturalHeight||im.height;
        [maskCan, uiCan].forEach(c=>{ c.width=w; c.height=h; });
        const m = maskCan.getContext('2d'), u = uiCan.getContext('2d');
        m.clearRect(0,0,w,h); u.clearRect(0,0,w,h);
        m.drawImage(im, 0,0, w, h);
        resolve({w,h});
      };
      im.onerror = ()=>reject(new Error('預覽失敗'));
      im.src = url;
    });
  }
  function attach(){
    const box = $('orc-container'), wrap=$('orc-wrap'), left=$('orc-left'), right=$('orc-right'), stage=$('orc-stage');
    const fileEl = $('fileInput'), status=$('status'), btn=$('btnAnalyze'), maskCan=$('maskCanvas'), uiCan=$('uiCanvas');
    if(!box||!wrap||!left||!right||!stage||!fileEl||!btn||!maskCan||!uiCan||!status) return false;

    // Minimal styles (in JS to avoid <style> tags)
    css(box,   {fontFamily:'ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,PingFang TC,Arial', color:'#111827'});
    css(wrap,  {maxWidth:'960px',margin:'0 auto',display:'flex',gap:'16px',flexWrap:'wrap',alignItems:'flex-start',padding:'16px',background:'#fafafa'});
    css(left,  {flex:'1 1 300px'});
    css(right, {flex:'1 1 320px',minWidth:'320px'});
    css(stage, {position:'relative',border:'1px dashed #e5e7eb',borderRadius:'12px',overflow:'hidden',background:'#fff'});
    css(maskCan,{position:'relative',zIndex:'1',display:'block',maxWidth:'100%'});
    css(uiCan, {position:'absolute',inset:'0',zIndex:'2',pointerEvents:'none',display:'block',maxWidth:'100%'});
    css($('orc-actions'), {marginTop:'10px'});
    css(btn,   {border:'1px solid #e5e7eb',background:'#fff',borderRadius:'10px',padding:'8px 12px',fontWeight:'600',cursor:'pointer'});
    css($('orc-label'), {display:'block',fontWeight:'600',marginBottom:'8px'});
    css($('fileInput'), {display:'block',padding:'8px',border:'1px solid #e5e7eb',background:'#fff',borderRadius:'8px',width:'100%'});
    css(status,{marginTop:'8px',fontSize:'14px',color:'#374151'});

    function setStatus(t){ status.textContent = t; }

    ['change','input'].forEach(ev=> fileEl.addEventListener(ev, async e=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      if(f.size > MAX_MB*1024*1024){ alert(`檔案過大，上限 ${MAX_MB} MB。`); e.target.value=''; setStatus(`已清除：超過 ${MAX_MB}MB 限制`); return; }
      const url = URL.createObjectURL(f);
      try{ const r=await drawToCanvas(url, maskCan, uiCan); setStatus(`已載入本機預覽：${r.w}×${r.h}`); }
      catch(err){ console.error(err); setStatus('Canvas 預覽失敗'); }
      finally{ setTimeout(()=>URL.revokeObjectURL(url), 5000); }
    }));

    btn.addEventListener('click', async ()=>{
      const f = fileEl && fileEl.files && fileEl.files[0];
      if(!f){ alert('請先選擇一張室內照片'); return; }
      if(f.size > MAX_MB*1024*1024){ alert(`檔案過大，上限 ${MAX_MB} MB。`); return; }
      const fd = new FormData();
      fd.append('image', f);
      fd.append('mask', 'smart');
      setStatus('分析中…');
      try{
        const res = await fetch(api('/analyze'), { method:'POST', body: fd });
        const j = await res.json();
        if(!res.ok) throw new Error((j && (j.error||j.message)) || '分析失敗');
        const baseUrl = j.original || api(`/jobs/${j.jobId}/original.jpg`);
        await drawToCanvas(baseUrl, maskCan, uiCan);
        if(j.masks && j.masks.editable_surface){
          const mImg = new Image();
          mImg.crossOrigin='anonymous';
          mImg.onload = ()=>{ maskCan.getContext('2d').drawImage(mImg,0,0,maskCan.width,maskCan.height); };
          mImg.src = j.masks.editable_surface.startsWith('http') ? j.masks.editable_surface : api(j.masks.editable_surface);
        }
        setStatus('分析完成，可修遮罩');
      }catch(err){
        console.error(err);
        alert(err.message||'分析失敗');
        setStatus('分析失敗');
      }
    });

    setStatus('就緒，等待選檔…');
    return true;
  }

  // Wait for fragment to be inserted (Strikingly may inject async)
  const MAX_WAIT=8000; let waited=0;
  const iv = setInterval(()=>{
    if(attach()){ clearInterval(iv); }
    else if((waited+=200)>=MAX_WAIT){ clearInterval(iv); console.warn('[orc] fragment not found'); }
  }, 200);
})();
</script>
</body>
</html>
