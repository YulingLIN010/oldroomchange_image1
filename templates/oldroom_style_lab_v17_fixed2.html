<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>OldRoom ⟷ NewStyle – v1.7L 測試頁</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; margin: 20px; line-height: 1.5; }
    h2 { margin-top: 28px; }
    fieldset { border: 1px solid #eee; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    legend { font-weight: 600; color: #333; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; min-width: 280px; }
    .imgbox { position: relative; display: inline-block; }
    .imgbox img { max-width: 100%; border-radius: 10px; border: 1px solid #ddd; }
    .thumb { width: 240px; height: auto; border-radius: 8px; border: 1px solid #ddd; }
    label { display: inline-block; margin-right: 8px; }
    input[type="text"], input[type="number"], select { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    input[type="color"] { width: 42px; height: 34px; padding: 0; border: none; background: none; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    button:disabled { opacity: .4; cursor: not-allowed; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; cursor: pointer; display:inline-block; margin: 4px 6px 0 0; }
    .out { background: #f8f8f8; border: 1px dashed #ddd; padding: 12px; border-radius: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #666; }
  </style>
</head>
<body>
  <h1>OldRoom ⟷ NewStyle – v1.7L 測試頁</h1>
  <p class="out">這個測試頁完全依照目前後端 <code>/analyze</code> → <code>/masks/save</code> → <code>/render/batch</code> → <code>/render/furniture-edit</code> 的參數命名與回傳格式設計。<br>
  如需 Logo 疊圖，請在伺服器放置 <code>static/logo/LOGO.png</code>，或用下方的「前端下載用疊圖」臨時處理。</p>

  <fieldset>
    <legend>0) API Base</legend>
    <input id="apiBase" style="width:420px" value="http://localhost:5000">
    <button id="btnHealth">健康檢查</button>
    <span id="healthz" class="small mono"></span>
  </fieldset>

  <fieldset>
    <legend>1) 上傳原圖 & 自動分析（S 層 + D 層）</legend>
    <div class="row">
      <div class="col">
        <input type="file" id="fileInput" accept="image/*">
        <button id="btnAnalyze" disabled>送出 /analyze</button>
        <div id="upInfo" class="small mono"></div>
        <div id="preview" class="imgbox"></div>
      </div>
      <div class="col">
        <div>初始 UI 遮罩（白=鎖定、透明=可改）：</div>
        <div id="maskPreview"></div>
        <div>深度（0~1 L8 預覽）：</div>
        <div id="depthPreview"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>2) 手動修正（合併後的最終遮罩）</legend>
    <p>為了簡化流程，這邊直接以「上一步得到的初始 L 遮罩」當作最終遮罩送回去（白=可編輯、黑=保護）。正式整合時請接上你的手繪修正介面再呼叫 <code>/masks/save</code>。</p>
    <button id="btnSaveMask" disabled>送出 /masks/save</button>
    <div id="saveInfo" class="small mono"></div>
  </fieldset>

  <fieldset>
    <legend>3) 生成 1~3 種風格圖（/render/batch）</legend>
    <div class="row">
      <div class="col">
        <div>
          <label>風格（最多 3，逗號分隔）：</label>
          <input id="styles" style="width:360px" placeholder="現代風, 北歐風">
        </div>
        <div style="margin-top:8px">
          <label>主色：</label><input type="color" id="cMain" value="#C0D6DF">
          <label>配1：</label><input type="color" id="c1" value="#4E8098">
          <label>配2：</label><input type="color" id="c2" value="#90C2E7">
          <label>配3：</label><input type="color" id="c3" value="#F6F4F0">
        </div>
        <div style="margin-top:8px">
          <label>Logo 位置：</label>
          <select id="logoPos">
            <option value="bottom-right">右下</option>
            <option value="bottom-left">左下</option>
            <option value="top-right">右上</option>
            <option value="top-left">左上</option>
            <option value="center">置中</option>
          </select>
          <label>大小：</label><input id="logoScale" type="number" value="0.18" step="0.02" min="0.06" max="0.4" style="width:80px">
          <label>不透明：</label><input id="logoOpacity" type="number" value="0.9" step="0.05" min="0.2" max="1" style="width:80px">
        </div>
        <div style="margin-top:8px">
          <button id="btnBatch" disabled>送出 /render/batch</button>
        </div>
      </div>
      <div class="col">
        <div>結果：</div>
        <div id="batchOut" class="grid"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>4) 家具編修（/render/furniture-edit）</legend>
    <div class="row">
      <div class="col">
        <div>
          <label>遮罩來源：</label>
          <label><input type="radio" name="masksrc" value="final" checked> 使用最終遮罩</label>
          <label><input type="radio" name="masksrc" value="upload"> 上傳局部遮罩 PNG</label>
          <input id="maskFile" type="file" accept="image/png" disabled>
        </div>
        <div style="margin-top:8px">
          <label>類型：</label>
          <label><input type="radio" name="ftype" value="replace" checked> 置換</label>
          <label><input type="radio" name="ftype" value="recolor"> 改色</label>
        </div>
        <div id="fReplace">
          <label>置換規格（英文佳）：</label>
          <input id="fSpec" style="width:360px" placeholder="modern sofa, oak legs">
        </div>
        <div id="fRecolor" style="display:none">
          <label>顏色：</label><input type="color" id="fColor" value="#1E3A8A">
        </div>
        <div style="margin-top:8px">
          <button id="btnFurn" disabled>送出 /render/furniture-edit</button>
        </div>
      </div>
      <div class="col">
        <div>最新圖片：</div>
        <div id="furnOut"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>5) 下載（前端臨時疊 Logo 用）</legend>
    <p>如果後端尚未放置 <code>static/logo/LOGO.png</code>，此處可本地疊公司 Logo 後下載。</p>
    <div>
      <input id="dlLogo" type="file" accept="image/*">
      <button id="btnDownload" disabled>下載目前顯示圖（疊本地 Logo）</button>
    </div>
  </fieldset>

<script>
(function(){
  const S = {
    api: document.getElementById('apiBase'),
    btnH: document.getElementById('btnHealth'),
    hz: document.getElementById('healthz'),

    file: document.getElementById('fileInput'),
    btnAnalyze: document.getElementById('btnAnalyze'),
    upInfo: document.getElementById('upInfo'),
    preview: document.getElementById('preview'),
    maskPreview: document.getElementById('maskPreview'),
    depthPreview: document.getElementById('depthPreview'),

    btnSaveMask: document.getElementById('btnSaveMask'),
    saveInfo: document.getElementById('saveInfo'),

    styles: document.getElementById('styles'),
    cMain: document.getElementById('cMain'),
    c1: document.getElementById('c1'),
    c2: document.getElementById('c2'),
    c3: document.getElementById('c3'),
    logoPos: document.getElementById('logoPos'),
    logoScale: document.getElementById('logoScale'),
    logoOpacity: document.getElementById('logoOpacity'),
    btnBatch: document.getElementById('btnBatch'),
    batchOut: document.getElementById('batchOut'),

    maskSrcRadios: document.querySelectorAll('input[name="masksrc"]'),
    maskFile: document.getElementById('maskFile'),
    ftypeRadios: document.querySelectorAll('input[name="ftype"]'),
    fReplace: document.getElementById('fReplace'),
    fRecolor: document.getElementById('fRecolor'),
    fSpec: document.getElementById('fSpec'),
    fColor: document.getElementById('fColor'),
    btnFurn: document.getElementById('btnFurn'),
    furnOut: document.getElementById('furnOut'),

    dlLogo: document.getElementById('dlLogo'),
    btnDownload: document.getElementById('btnDownload'),
  };

  let state = {
    jobId: null,
    originalUrl: null,
    combinedMaskB64: null,
    lastImageUrl: null, // for download
    maskUrlUploaded: null,
  };

  function $(sel){ return document.querySelector(sel); }
  function el(tag, attrs={}, children=[]) {
    const e = document.createElement(tag);
    for (const k in attrs) {
      if (k === 'text') e.textContent = attrs[k];
      else if (k === 'html') e.innerHTML = attrs[k];
      else e.setAttribute(k, attrs[k]);
    }
    (Array.isArray(children)?children:[children]).forEach(ch => ch && e.appendChild(ch));
    return e;
  }
  function imgFromB64(b64){ const i = new Image(); i.src = 'data:image/png;base64,' + b64; i.className='thumb'; return i; }
  function img(url){ const i = new Image(); i.src = url; i.className='thumb'; return i; }

  // health
  S.btnH.addEventListener('click', async ()=>{
    S.hz.textContent = '...';
    try{
      const r = await fetch(S.api.value.replace(/\/$/,'') + '/healthz');
      S.hz.textContent = r.status===204? 'OK 204' : ('HTTP ' + r.status);
    }catch(e){ S.hz.textContent = 'ERR: ' + e; }
  });

  // file select
  S.file.addEventListener('change', ()=>{
    S.btnAnalyze.disabled = !S.file.files?.length;
  });

  // analyze
  S.btnAnalyze.addEventListener('click', async ()=>{
    const base = S.api.value.replace(/\/$/,'');
    const fd = new FormData();
    fd.append('image', S.file.files[0]);
    S.upInfo.textContent = '上傳中...';
    try{
      const res = await fetch(base + '/analyze', { method:'POST', body: fd });
      const data = await res.json();
      if(data.error){ throw new Error(data.error); }
      state.jobId = data.jobId;
      state.originalUrl = data.original;
      state.combinedMaskB64 = data.combined_mask_b64;
      S.preview.innerHTML = '';
      S.preview.appendChild(img(state.originalUrl));
      S.maskPreview.innerHTML = data.masks?.editable_surface
        ? '' : '(server 未回 ui_mask)';
      if(data.masks?.editable_surface) S.maskPreview.appendChild(img(data.masks.editable_surface));
      S.depthPreview.innerHTML = data.depth_b64 ? '' : '(無深度或模型未載入)';
      if(data.depth_b64) S.depthPreview.appendChild(imgFromB64(data.depth_b64));
      S.btnSaveMask.disabled = false;
      S.btnBatch.disabled = false;
      S.btnFurn.disabled = false;
      S.upInfo.textContent = 'jobId=' + state.jobId;
    }catch(e){ S.upInfo.textContent = 'ERR: ' + e.message; }
  });

  // save mask (convert L mask -> UI PNG, then multipart upload)
  S.btnSaveMask.addEventListener('click', async ()=>{
    const base = S.api.value.replace(/\/$/,'');
    if(!state.combinedMaskB64){ S.saveInfo.textContent = '尚未有初始遮罩'; return; }
    S.saveInfo.textContent = '轉換與上傳中...';

    try{
      // Build a canvas from L mask (white=editable, black=protect)
      const img = new Image();
      img.src = 'data:image/png;base64,' + state.combinedMaskB64;
      await img.decode();

      const cL = document.createElement('canvas');
      cL.width = img.naturalWidth; cL.height = img.naturalHeight;
      const xL = cL.getContext('2d');
      xL.drawImage(img,0,0);

      // Convert to UI PNG (white=lock, transparent=editable)
      const cUI = document.createElement('canvas');
      cUI.width = cL.width; cUI.height = cL.height;
      const xUI = cUI.getContext('2d');
      const id = xL.getImageData(0,0,cL.width,cL.height);
      const od = xUI.createImageData(cL.width,cL.height);
      const D = id.data, O = od.data;
      for(let i=0;i<D.length;i+=4){
        const v = D[i]; // gray
        const editable = v > 127; // L: white=editable
        // UI: white pixel with alpha 255 means LOCK; transparent means editable
        O[i]=255; O[i+1]=255; O[i+2]=255; O[i+3] = editable ? 0 : 255;
      }
      xUI.putImageData(od,0,0);

      const blob = await new Promise(res=> cUI.toBlob(res, 'image/png'));
      const fd = new FormData();
      fd.append('jobId', state.jobId);
      fd.append('mask', blob, 'final_ui.png');
      const r = await fetch(base + '/masks/save', { method:'POST', body: fd });
      const d = await r.json();
      if(d.error) throw new Error(d.error);
      S.saveInfo.textContent = '已儲存最終遮罩。';
    }catch(e){ S.saveInfo.textContent = 'ERR: ' + e.message; }
  });

  // batch render
  S.btnBatch.addEventListener('click', async ()=>{
    const base = S.api.value.replace(/\/$/,'');
    const palette = {
      main: S.cMain.value,
      acc1: S.c1.value,
      acc2: S.c2.value,
      acc3: S.c3.value
    };
    const styles = (S.styles.value||'').split(',').map(s=>s.trim()).filter(Boolean).slice(0,3);
    const payload = {
      jobId: state.jobId,
      styles,
      palette,
      logo: {
        pos: S.logoPos.value,
        scale: Number(S.logoScale.value || 0.18),
        opacity: Number(S.logoOpacity.value || 0.9)
      }
    };
    S.batchOut.innerHTML = '執行中...';
    try{
      const r = await fetch(base + '/render/batch', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if(d.error) throw new Error(d.error);
      const items = d.images || [];
      S.batchOut.innerHTML = '';
      items.forEach(it=>{
        if(it.url){
          const box = el('div', {class:'out'});
          const im = img(it.url);
          im.addEventListener('click', ()=>{
            state.lastImageUrl = it.url;
            S.furnOut.innerHTML = '';
            S.furnOut.appendChild(img(it.url));
            S.btnDownload.disabled = false;
          });
          box.appendChild(im);
          box.appendChild(el('div',{text: it.style || ''}));
          S.batchOut.appendChild(box);
          state.lastImageUrl = it.url; // keep last for download
          S.btnDownload.disabled = false;
        }else{
          S.batchOut.appendChild(el('div',{class:'out', text: it.error || '生成失敗'}));
        }
      });
    }catch(e){ S.batchOut.innerHTML = 'ERR: ' + e.message; }
  });

  // mask source toggle
  S.maskSrcRadios.forEach(r=>r.addEventListener('change', ()=>{
    const useUpload = $('input[name="masksrc"]:checked').value === 'upload';
    S.maskFile.disabled = !useUpload;
  }));

  // furniture type toggle
  S.ftypeRadios.forEach(r=>r.addEventListener('change', ()=>{
    const t = $('input[name="ftype"]:checked').value;
    S.fReplace.style.display = t==='replace' ? '' : 'none';
    S.fRecolor.style.display = t==='recolor' ? '' : 'none';
  }));

  // upload mask helper -> /upload/mask
  async function uploadMaskAndGetUrl(){
    const base = S.api.value.replace(/\/$/,'');
    const fd = new FormData();
    fd.append('jobId', state.jobId);
    fd.append('mask', S.maskFile.files[0]);
    const r = await fetch(base + '/upload/mask', { method:'POST', body: fd });
    const d = await r.json();
    if(d.error) throw new Error(d.error);
    return d.maskUrl;
  }

  // furniture-edit
  S.btnFurn.addEventListener('click', async ()=>{
    const base = S.api.value.replace(/\/$/,'');
    let maskUrl;
    const src = $('input[name="masksrc"]:checked').value;
    try{
      if(src === 'upload'){
        if(!S.maskFile.files?.length) throw new Error('請先選擇遮罩 PNG');
        maskUrl = await uploadMaskAndGetUrl();
        state.maskUrlUploaded = maskUrl;
      }else{
        if(!state.jobId) throw new Error('尚未有 jobId');
        maskUrl = `/jobs/${state.jobId}/masks/final_L.png`;
      }
      const t = $('input[name="ftype"]:checked').value;
      const payload = { jobId: state.jobId, mask: maskUrl, type: t };
      if(t==='replace'){ payload.spec = S.fSpec.value || 'modern sofa with metal legs'; }
      else { payload.color = S.fColor.value || '#1E3A8A'; }
      const r = await fetch(base + '/render/furniture-edit', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if(d.error) throw new Error(d.error);
      state.lastImageUrl = d.imageUrl;
      S.furnOut.innerHTML = '';
      S.furnOut.appendChild(img(d.imageUrl));
      S.btnDownload.disabled = false;
    }catch(e){
      S.furnOut.innerHTML = 'ERR: ' + e.message;
    }
  });

  // download with local logo overlay
  S.btnDownload.addEventListener('click', async ()=>{
    try{
      if(!state.lastImageUrl) throw new Error('目前沒有可下載圖片');
      const baseImg = await loadImage(state.lastImageUrl);
      const cnv = document.createElement('canvas');
      cnv.width = baseImg.naturalWidth; cnv.height = baseImg.naturalHeight;
      const ctx = cnv.getContext('2d');
      ctx.drawImage(baseImg, 0, 0);
      if(S.dlLogo.files?.length){
        const logo = await fileToImage(S.dlLogo.files[0]);
        const scale = 0.18;
        const w = Math.max(1, Math.floor(baseImg.naturalWidth * scale));
        const h = Math.floor(w * logo.naturalHeight / logo.naturalWidth);
        const pad = Math.floor(baseImg.naturalWidth * 0.03);
        const x = baseImg.naturalWidth - w - pad;
        const y = baseImg.naturalHeight - h - pad;
        ctx.globalAlpha = 0.9;
        ctx.drawImage(logo, x, y, w, h);
        ctx.globalAlpha = 1.0;
      }
      const url = cnv.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'styled.png';
      a.click();
    }catch(e){ alert(e.message); }
  });

  function loadImage(url){
    return new Promise((resolve,reject)=>{
      const i = new Image(); i.crossOrigin='anonymous'; i.onload=()=>resolve(i); i.onerror=reject; i.src=url;
    });
  }
  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=>{ const i = new Image(); i.onload=()=>resolve(i); i.onerror=reject; i.src=fr.result; };
      fr.onerror = reject; fr.readAsDataURL(file);
    });
  }
})();
</script>
</body>
</html>
