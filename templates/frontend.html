<!DOCTYPE html>
<!-- 檔案說明：
  - 單檔前端（HTML/CSS/JS）用於與後端溝通進行「室內風格轉換」
  - 主要流程：上傳圖片 → 選風格與色系 → 遮罩設定 → 呼叫 /generate → 輪詢 /status 顯示結果
  - 與後端 API 對齊：GET /styles、POST /generate、GET /status/<task_id>、以及靜態檔路徑 /uploads /results /masks
-->

<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI風格轉換小幫手</title>
  <style>
    /*
      樣式說明：
      - 基底色系與卡片陰影（偏暖色）
      - .preview-wrap 與 .img-box 用於左右比對/滑桿比對容器
      - #sliderWrap 相關為滑桿比對外框與 thumb 樣式
      - 響應式：<=600px 時改為直式堆疊
    */

    body { background:#fff8f0;font-family:"Noto Sans TC",sans-serif; color:#222; }
    .container{max-width:600px;margin:40px auto;padding:2em 1em;box-shadow:0 8px 32px #cab6a4; border-radius:24px;}
    h2{font-size:1.8em; margin:0.2em 0 1em;}
    label{display:block;font-weight:600; margin:1em 0 0.5em;}
    .cute-btn{padding:0.5em 1.6em;background:#f7b84b;color:#fff;border:none;border-radius:28px;font-size:1.2em;cursor:pointer;box-shadow:0 2px 8px #f7dbac;}
    .cute-btn:active{background:#f2921d;}
    .preview-wrap{display:flex;gap:0.5em;align-items:flex-start;}
    .img-box{flex:1 1 0;width:48%;background:#f4efe8;border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;}
    .img-box .note{align-self:flex-start;}
    .img-box img{
  height: 360px;
  width: auto;
  object-fit: contain;
  border-radius:10px;
  box-shadow:0 2px 10px #ebdbd1;
  max-width: 100%;
}
    .row{margin:1.3em 0;}
    select,input[type=text]{padding:0.3em;border-radius:9px;font-size:1.1em;border:1.3px solid #f7b84b;}
    .note{color:#f48f1c; font-size:0.96em;}
    .hidden{display:none;}
    #sliderWrap{margin: 1.5em 0;}
    #sliderWrap .slider-outer{position:relative;max-width:500px;margin:auto;border-radius:16px;box-shadow:0 2px 12px #ebdbd1;}
    #sliderWrap .slider-outer{width:100%;  background:#eee;}
    #sliderWrap img{border-radius:16px;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;}
    #sliderClipWrap{transition:width 0.15s;height:100%;overflow:hidden;position:absolute;top:0;left:0;}
    #sliderControl{appearance:none;width:100%;height:8px;background:#f7dbac;border-radius:8px;outline:none;margin:0;position:absolute;bottom:-24px;left:0;z-index:4;}
    #sliderControl::-webkit-slider-thumb{appearance:none;width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    #sliderControl::-moz-range-thumb{width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    #sliderControl::-ms-thumb{width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    @media (max-width:600px) {
      .container{padding:1em 0.2em;}
      .preview-wrap{flex-direction:column;align-items:stretch;}
      .img-box{width:100%;margin-bottom:10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 主要內容容器：表單輸入、預覽、比對與錯誤訊息顯示 -->
    <h2>AI 風格轉換小幫手(Image1) 🏠</h2>

    <label>1️⃣ 上傳照片 <span class="note">(JPG/PNG, &lt;2MB)</span></label>
    <input type="file" id="imageInput" accept="image/png, image/jpeg" />
    <div class="note">僅限2MB以內，若超過請用手機截圖、壓縮App或<a href="https://tinypng.com" target="_blank">TinyPNG</a>壓縮</div>
    <div id="preview" class="row"></div>
    <!-- 上傳圖片後於此顯示縮圖預覽 -->

    <label>2️⃣ 選擇風格</label>
    <select id="styleSelect"></select>
    <!-- 後端 /styles 回傳的風格清單將注入到此下拉選單 -->
    <div id="styleDesc" class="note"></div>
    <!-- 簡短風格描述（自 styles.txt 擷取第一句/前10字）-->

    <label>3️⃣ 輸入主色系</label>
    <input type="text" id="colorInput" 
           <!-- 色票格式建議：「主色＋輔色」，例：白＋淺灰＋木色。程式會將「＋」轉英文逗號給模型理解 --> placeholder="例：白＋淺灰＋木色" maxlength="16"/>
    <div class="note">建議格式：主色＋輔色，以「＋」號分隔，例如「白＋奶茶色＋金」</div>

    
    <label>4️⃣ 遮罩設定（限制可編輯範圍）</label>
    <div class="note">白=可編輯，黑=保護。建議先用「聰明遮罩」。</div>
    <!-- 遮罩設定區塊：
         - smart：在 safe_edges 基礎上，加強保護亮窗與垂直線條
         - safe_edges：保護邊緣與外框
         - full：全圖可編輯（風險較高，可能破壞結構）
         - 參數可微調：margin_ratio / edge_thresh / window_bright_thresh / dilate_px / protect_windows
       -->
    <div id="maskControls" class="row" style="display:block; border:1px dashed #f7b84b; padding:10px; border-radius:10px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <label><input type="radio" name="maskMode" value="smart" checked> 聰明遮罩（smart）</label>
        <label><input type="radio" name="maskMode" value="safe_edges"> 邊緣保護（safe_edges）</label>
        <label><input type="radio" name="maskMode" value="full"> 全圖可編輯（full）</label>
      </div>
      <div id="smartOpts" style="margin-top:10px;">
        <div class="note" style="margin-bottom:6px;">進階（smart 專用）：覺得邊界還是會被改到？就把「邊緣門檻」降低、或把「膨脹像素」加大。</div>
        <div style="display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:8px;">
          <label>外框保護比例 margin_ratio（0.02–0.10）<br>
            <input type="number" id="opt_margin_ratio" min="0.01" max="0.20" step="0.01" value="0.04" style="width:120px;">
          </label>
          <label>邊緣門檻 edge_thresh（0–255）<br>
            <input type="number" id="opt_edge_thresh" min="0" max="255" step="1" value="28" style="width:120px;">
          </label>
          <label>亮區門檻 window_bright_thresh（0–255）<br>
            <input type="number" id="opt_window_bright_thresh" min="0" max="255" step="1" value="215" style="width:120px;">
          </label>
          <label>膨脹像素 dilate_px（0–20）<br>
            <input type="number" id="opt_dilate_px" min="0" max="20" step="1" value="6" style="width:120px;">
          </label>
          <label style="grid-column: 1 / -1;">
            <input type="checkbox" id="opt_protect_windows" checked> 保護高亮窗/玻璃/燈具（protect_windows）
          </label>
        </div>
      </div>
      <div id="maskPreviewWrap" class="hidden" style="margin-top:10px;">
        <div class="note">遮罩預覽（若後端回傳 mask_url 會顯示）：</div>
        <img id="maskPreview" src="" style="max-width:100%; border-radius:10px; box-shadow:0 2px 10px #ebdbd1;">
      </div>
    </div>

    <div class="row">
      <button class="cute-btn" id="genBtn">✨ 開始生成</button>
    </div>
    <div id="loading" class="note hidden">⏳ 正在生成，請耐心等候...</div>

    <div class="row" id="compareModeBtns" style="margin-bottom:1.2em; display:none;">
      <button class="cute-btn" id="sideBySideBtn">左右對比</button>
      <button class="cute-btn" id="sliderBtn">滑桿比對</button>
    </div>
    <!-- 左右並排（兩張圖片固定大小並列顯示） -->
    <div id="compareWrap" class="preview-wrap row hidden">
      <div class="img-box">
        <div class="note">原始圖片</div>
        <img id="originalImg" src="" alt="原圖預覽"/>
      </div>
      <div class="img-box">
        <div class="note">風格轉換</div>
        <img id="styledImg" src="" alt="風格圖預覽"/>
        <button class="cute-btn" id="downloadBtn" style="margin-top:1em;">⬇ 下載圖片</button>
      </div>
    </div>
    <!-- 滑桿比對（上層圖以 clip width 方式裁切，搭配 range 控制寬度） -->
    <div id="sliderWrap" class="hidden">
      <div class="slider-outer">
        <img id="sliderBefore" src="" style="z-index:1;">
        <div id="sliderClipWrap" style="z-index:2; width:0%">
          <img id="sliderAfter" src="">
        </div>
        <input type="range" min="0" max="100" value="0" id="sliderControl">
      </div>
      <div style="display:flex;justify-content:space-between;font-size:0.97em;color:#888;margin-top:0.4em;">
        <span>原始</span><span>風格</span>
      </div>
    </div>
    <div id="errMsg" class="note hidden" style="color:#e33;"></div>
  </div>
<script>
// ===========================
// 前端互動腳本（Vanilla JS）
// 功能：載入風格、處理上傳、組合遮罩參數、呼叫後端、輪詢任務狀態、顯示比對、下載圖片
// ===========================

// Helper: wait for <img> to fully load
// 等待圖片載入完成，避免尚未取得 naturalWidth/Height 就進行計算
function waitImg(img){
  return new Promise(res=>{
    if(img && img.complete && img.naturalWidth>0) return res();
    if(!img) return res();
    img.onload = ()=>res();
    img.onerror = ()=>res();
  });
}

// 後端基底位址：
// - 正式環境可維持雲端網址
// - 本機測試可改為空字串 '' 或 'http://localhost:5000'
const API_BASE = 'https://oldroomchange-image3.onrender.com';

let base64img = "", styleList = [];
const imgInput = document.getElementById('imageInput');
const preview = document.getElementById('preview');
const styleSelect = document.getElementById('styleSelect');
const styleDesc = document.getElementById('styleDesc');
const colorInput = document.getElementById('colorInput');
const genBtn = document.getElementById('genBtn');
const loading = document.getElementById('loading');
const compareModeBtns = document.getElementById('compareModeBtns');
const compareWrap = document.getElementById('compareWrap');
const originalImg = document.getElementById('originalImg');
const styledImg = document.getElementById('styledImg');
const downloadBtn = document.getElementById('downloadBtn');
const sliderWrap = document.getElementById('sliderWrap');
const sideBySideBtn = document.getElementById('sideBySideBtn');
const sliderBtn = document.getElementById('sliderBtn');
const sliderBefore = document.getElementById('sliderBefore');
const sliderAfter = document.getElementById('sliderAfter');
const sliderClipWrap = document.getElementById('sliderClipWrap');
const sliderControl = document.getElementById('sliderControl');
const errMsg = document.getElementById('errMsg');
// 前端：檔案大小上限（2MB），大於上限會提示壓縮
const MAX_SIZE = 2*1024*1024;
// Mask controls
// 取得 mask 單選按鈕 NodeList → 陣列
const maskModeRadios = () => [...document.querySelectorAll('input[name="maskMode"]')];
// smart 模式參數：即時讀取表單值（使用 Getter 確保最新）
const smartOpts = {
  get margin_ratio(){ return parseFloat(document.getElementById('opt_margin_ratio').value || '0.04'); },
  get edge_thresh(){ return parseInt(document.getElementById('opt_edge_thresh').value || '28'); },
  get window_bright_thresh(){ return parseInt(document.getElementById('opt_window_bright_thresh').value || '215'); },
  get dilate_px(){ return parseInt(document.getElementById('opt_dilate_px').value || '6'); },
  get protect_windows(){ return document.getElementById('opt_protect_windows').checked; }
};


// 載入風格（向 /styles 取資料，注入下拉選單；並顯示簡短描述）
fetch(`${API_BASE}/styles`).then(r=>r.json()).then(list=>{
  styleList=list;
  styleSelect.innerHTML = list.map((s,i)=>
    `<option value="${s.name}" ${i==0?'selected':''}>${s.name}</option>`
  ).join('');
  function getShortDesc(desc, name) {
    if(!desc) return name;
    let d = desc.replace(/。.*$/, '').replace(/[\r\n]/g,'').trim();
    return d.length>10 ? d.slice(0,10)+'...' : d;
  }
  styleDesc.textContent = getShortDesc(list[0]?.desc||"", list[0]?.name||"");
});
// 切換風格時，更新下方的風格描述
styleSelect.onchange = ()=>{
  const v = styleSelect.value;
  const info = styleList.find(s=>s.name==v);
  function getShortDesc(desc, name) {
    if(!desc) return name;
    let d = desc.replace(/。*$/, '').replace(/[\r\n]/g,'').trim();
    return d.length>10 ? d.slice(0,10)+'...' : d;
  }
  styleDesc.textContent = getShortDesc(info?.desc||"", info?.name||"");
};

// 選擇圖片時：
// - 驗證檔案型別/大小
// - 顯示預覽
imgInput.onchange = function(e){
  preview.innerHTML="";
  errMsg.classList.add('hidden');
  compareWrap.classList.add('hidden');
  sliderWrap.classList.add('hidden');
  compareModeBtns.style.display = 'none';
  base64img = "";
  const file = this.files[0];
  if(!file) return;
  if(!['image/jpeg','image/png'].includes(file.type)){
    alert('❌ 僅接受JPG/PNG格式圖片！');
    this.value="";
    return;
  }
  if(file.size > MAX_SIZE){
    alert('❌ 圖片檔案超過2MB！請使用手機截圖、調整畫質或前往 https://tinypng.com 壓縮。');
    this.value="";
    return;
  }
  if(file.size > MAX_SIZE*0.7){
    preview.innerHTML='<div class="note">⚠️ 檔案接近上限，建議壓縮可提升速度。</div>';
  }
  const reader = new FileReader();
  reader.onload = function(ev){
    base64img = ev.target.result;
    preview.innerHTML += `<img src="${base64img}" style="max-width:220px;max-height:150px;border-radius:12px;margin-top:10px;" alt="預覽"/>`;
  };
  reader.readAsDataURL(file);
};


// 切換 mask 模式時顯示/隱藏 smart 參數（非 smart 模式隱藏進階設定）
maskModeRadios().forEach(r=>{
  r.addEventListener('change', ()=>{
    const mode = maskModeRadios().find(x=>x.checked)?.value || 'smart';
    document.getElementById('smartOpts').style.display = (mode === 'smart') ? '' : 'none';
  });
});
// 預設 smart 顯示
document.getElementById('smartOpts').style.display = '';

// 送出請求：
// - 將 base64 圖 + 風格 + 色系 + 遮罩設定打包成 JSON
// - 呼叫 POST /generate 取得 task_id
// - 啟動輪詢 /status/<task_id> 等待完成
genBtn.onclick = async function(){
  errMsg.classList.add('hidden');
  if(!base64img){
    alert('請先選擇圖片！'); return;
  }
  if(!colorInput.value.trim()){
    alert('請輸入主色系（例：白＋淺灰＋木色）'); return;
  }
  loading.classList.remove('hidden');
  compareWrap.classList.add('hidden');
  sliderWrap.classList.add('hidden');
  compareModeBtns.style.display = 'none';
  genBtn.disabled=true;
  try{
    const r = await fetch(`${API_BASE}/generate`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify((()=>{ const mode = maskModeRadios().find(x=>x.checked)?.value || 'smart'; const payload = { image_base64: base64img, style: styleSelect.value, colors: colorInput.value, mask: mode }; if(mode==='smart'){ payload.mask_options = { margin_ratio: smartOpts.margin_ratio, edge_thresh: smartOpts.edge_thresh, window_bright_thresh: smartOpts.window_bright_thresh, dilate_px: smartOpts.dilate_px, protect_windows: smartOpts.protect_windows }; } return payload; })())
    });
    const resp = await r.json();
    if(resp.status==="failed"){
      throw new Error(resp.error||'伺服器錯誤，請稍後再試。');
    }
    let t = 0, maxTry=60;
    let poll;
    poll = setInterval(async ()=>{
      // 每 2 秒輪詢一次任務狀態
      const rs = await fetch(`${API_BASE}/status/${resp.task_id}`);
      const j = await rs.json();
      if(j.status==="completed"){
        // 成功：關閉 loading、顯示比對、綁定下載按鈕、顯示遮罩預覽
        clearInterval(poll);
        loading.classList.add('hidden');
        showComparison(j.original_image_url, j.styled_image_url);
        downloadBtn.onclick = ()=>downloadImg(j.styled_image_url);

        if (j.mask_url) {
          const wrap = document.getElementById('maskPreviewWrap');
          const mp = document.getElementById('maskPreview');
          mp.src = API_BASE + j.mask_url;
          wrap.classList.remove('hidden');
        }

        genBtn.disabled=false;
      }
      if(j.status==="failed"){
        // 失敗：顯示錯誤訊息
        clearInterval(poll);
        loading.classList.add('hidden');
        errMsg.textContent = "❌ 產生失敗："+(j.error||"未知錯誤"); errMsg.classList.remove('hidden');
        genBtn.disabled=false;
      }
      if(++t > maxTry){
        // 逾時：停止輪詢並提示
        clearInterval(poll);
        loading.classList.add('hidden');
        errMsg.textContent = "❌ 超時，請重新上傳圖片再試。";
        errMsg.classList.remove('hidden');
        genBtn.disabled=false;
      }
    },2000);
  }catch(e){
    loading.classList.add('hidden');
    errMsg.textContent = "❌ "+e.message;
    errMsg.classList.remove('hidden');
    genBtn.disabled=false;
  }
};

// 顯示比對圖（優化圖片大小/對齊/滑桿起點）：
// - 動態設定外框 aspect-ratio 以符合實圖比例
// - 預設先顯示「滑桿比對」模式並露出模式切換按鈕
function showComparison(originalUrl, styledUrl) {
  // Set sources
  if (typeof API_BASE === 'undefined') { window.API_BASE = ''; }
  originalImg.src = API_BASE + originalUrl;
  styledImg.src   = API_BASE + styledUrl;
  sliderBefore.src = API_BASE + originalUrl;
  sliderAfter.src  = API_BASE + styledUrl;

  Promise.all([waitImg(sliderAfter), waitImg(sliderBefore)]).then(()=> {
    const w = sliderAfter.naturalWidth || 1024;
    const h = sliderAfter.naturalHeight || 1024;
    const outer = document.querySelector('#sliderWrap .slider-outer');
    if (outer && outer.style) {
      outer.style.aspectRatio = w + ' / ' + h;  // dynamically match image ratio
    }
    // Reset slider position
    sliderClipWrap.style.width = "0%";
    sliderControl.value = 0;

    // Default show side-by-side compare
    compareWrap.classList.add('hidden');
    sliderWrap.classList.remove('hidden');
    if (typeof compareModeBtns !== 'undefined' && compareModeBtns) {
      compareModeBtns.style.display = '';
    }
  });
}

// 切換為左右並排比對
sideBySideBtn.onclick = function(){
  sliderWrap.classList.add('hidden');
  compareWrap.classList.remove('hidden');
}
// 切換為滑桿比對
sliderBtn.onclick = function(){
  compareWrap.classList.add('hidden');
  sliderWrap.classList.remove('hidden');
}

// 滑桿事件（同步 clip width）：
// 依 slider 數值（0–100）調整上層圖覆蓋寬度
sliderControl.oninput = function(){
  sliderClipWrap.style.width = `${this.value}%`;
}

// 下載圖片（自 /results 補上 API_BASE 以支援本機/雲端）
function downloadImg(url){
  fetch(API_BASE + url).then(r=>r.blob()).then(blob=>{
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "styled_output.png";
    document.body.appendChild(link);
    link.click(); document.body.removeChild(link);
  });
}
</script>
</body>
</html>


