<!DOCTYPE html>
<!-- æª”æ¡ˆèªªæ˜ï¼š
  - å–®æª”å‰ç«¯ï¼ˆHTML/CSS/JSï¼‰ç”¨æ–¼èˆ‡å¾Œç«¯æºé€šé€²è¡Œã€Œå®¤å…§é¢¨æ ¼è½‰æ›ã€
  - ä¸»è¦æµç¨‹ï¼šä¸Šå‚³åœ–ç‰‡ â†’ é¸é¢¨æ ¼èˆ‡è‰²ç³» â†’ é®ç½©è¨­å®š â†’ å‘¼å« /generate â†’ è¼ªè©¢ /status é¡¯ç¤ºçµæœ
  - èˆ‡å¾Œç«¯ API å°é½Šï¼šGET /stylesã€POST /generateã€GET /status/<task_id>ã€ä»¥åŠéœæ…‹æª”è·¯å¾‘ /uploads /results /masks
-->

<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AIé¢¨æ ¼è½‰æ›å°å¹«æ‰‹</title>
  <style>
    /*
      æ¨£å¼èªªæ˜ï¼š
      - åŸºåº•è‰²ç³»èˆ‡å¡ç‰‡é™°å½±ï¼ˆåæš–è‰²ï¼‰
      - .preview-wrap èˆ‡ .img-box ç”¨æ–¼å·¦å³æ¯”å°/æ»‘æ¡¿æ¯”å°å®¹å™¨
      - #sliderWrap ç›¸é—œç‚ºæ»‘æ¡¿æ¯”å°å¤–æ¡†èˆ‡ thumb æ¨£å¼
      - éŸ¿æ‡‰å¼ï¼š<=600px æ™‚æ”¹ç‚ºç›´å¼å †ç–Š
    */

    body { background:#fff8f0;font-family:"Noto Sans TC",sans-serif; color:#222; }
    .container{max-width:600px;margin:40px auto;padding:2em 1em;box-shadow:0 8px 32px #cab6a4; border-radius:24px;}
    h2{font-size:1.8em; margin:0.2em 0 1em;}
    label{display:block;font-weight:600; margin:1em 0 0.5em;}
    .cute-btn{padding:0.5em 1.6em;background:#f7b84b;color:#fff;border:none;border-radius:28px;font-size:1.2em;cursor:pointer;box-shadow:0 2px 8px #f7dbac;}
    .cute-btn:active{background:#f2921d;}
    .preview-wrap{display:flex;gap:0.5em;align-items:flex-start;}
    .img-box{flex:1 1 0;width:48%;background:#f4efe8;border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;}
    .img-box .note{align-self:flex-start;}
    .img-box img{
  height: 360px;
  width: auto;
  object-fit: contain;
  border-radius:10px;
  box-shadow:0 2px 10px #ebdbd1;
  max-width: 100%;
}
    .row{margin:1.3em 0;}
    select,input[type=text]{padding:0.3em;border-radius:9px;font-size:1.1em;border:1.3px solid #f7b84b;}
    .note{color:#f48f1c; font-size:0.96em;}
    .hidden{display:none;}
    #sliderWrap{margin: 1.5em 0;}
    #sliderWrap .slider-outer{position:relative;max-width:500px;margin:auto;border-radius:16px;box-shadow:0 2px 12px #ebdbd1;}
    #sliderWrap .slider-outer{width:100%;  background:#eee;}
    #sliderWrap img{border-radius:16px;position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;}
    #sliderClipWrap{transition:width 0.15s;height:100%;overflow:hidden;position:absolute;top:0;left:0;}
    #sliderControl{appearance:none;width:100%;height:8px;background:#f7dbac;border-radius:8px;outline:none;margin:0;position:absolute;bottom:-24px;left:0;z-index:4;}
    #sliderControl::-webkit-slider-thumb{appearance:none;width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    #sliderControl::-moz-range-thumb{width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    #sliderControl::-ms-thumb{width:28px;height:28px;background:#f7b84b;border-radius:50%;box-shadow:0 2px 4px #ccb999;}
    @media (max-width:600px) {
      .container{padding:1em 0.2em;}
      .preview-wrap{flex-direction:column;align-items:stretch;}
      .img-box{width:100%;margin-bottom:10px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ä¸»è¦å…§å®¹å®¹å™¨ï¼šè¡¨å–®è¼¸å…¥ã€é è¦½ã€æ¯”å°èˆ‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤º -->
    <h2>AI é¢¨æ ¼è½‰æ›å°å¹«æ‰‹(Image1) ğŸ </h2>

    <label>1ï¸âƒ£ ä¸Šå‚³ç…§ç‰‡ <span class="note">(JPG/PNG, &lt;2MB)</span></label>
    <input type="file" id="imageInput" accept="image/png, image/jpeg" />
    <div class="note">åƒ…é™2MBä»¥å…§ï¼Œè‹¥è¶…éè«‹ç”¨æ‰‹æ©Ÿæˆªåœ–ã€å£“ç¸®Appæˆ–<a href="https://tinypng.com" target="_blank">TinyPNG</a>å£“ç¸®</div>
    <div id="preview" class="row"></div>
    <!-- ä¸Šå‚³åœ–ç‰‡å¾Œæ–¼æ­¤é¡¯ç¤ºç¸®åœ–é è¦½ -->

    <label>2ï¸âƒ£ é¸æ“‡é¢¨æ ¼</label>
    <select id="styleSelect"></select>
    <!-- å¾Œç«¯ /styles å›å‚³çš„é¢¨æ ¼æ¸…å–®å°‡æ³¨å…¥åˆ°æ­¤ä¸‹æ‹‰é¸å–® -->
    <div id="styleDesc" class="note"></div>
    <!-- ç°¡çŸ­é¢¨æ ¼æè¿°ï¼ˆè‡ª styles.txt æ“·å–ç¬¬ä¸€å¥/å‰10å­—ï¼‰-->

    <label>3ï¸âƒ£ è¼¸å…¥ä¸»è‰²ç³»</label>
    <input type="text" id="colorInput" 
           <!-- è‰²ç¥¨æ ¼å¼å»ºè­°ï¼šã€Œä¸»è‰²ï¼‹è¼”è‰²ã€ï¼Œä¾‹ï¼šç™½ï¼‹æ·ºç°ï¼‹æœ¨è‰²ã€‚ç¨‹å¼æœƒå°‡ã€Œï¼‹ã€è½‰è‹±æ–‡é€—è™Ÿçµ¦æ¨¡å‹ç†è§£ --> placeholder="ä¾‹ï¼šç™½ï¼‹æ·ºç°ï¼‹æœ¨è‰²" maxlength="16"/>
    <div class="note">å»ºè­°æ ¼å¼ï¼šä¸»è‰²ï¼‹è¼”è‰²ï¼Œä»¥ã€Œï¼‹ã€è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚ã€Œç™½ï¼‹å¥¶èŒ¶è‰²ï¼‹é‡‘ã€</div>

    
    <label>4ï¸âƒ£ é®ç½©è¨­å®šï¼ˆé™åˆ¶å¯ç·¨è¼¯ç¯„åœï¼‰</label>
    <div class="note">ç™½=å¯ç·¨è¼¯ï¼Œé»‘=ä¿è­·ã€‚å»ºè­°å…ˆç”¨ã€Œè°æ˜é®ç½©ã€ã€‚</div>
    <!-- é®ç½©è¨­å®šå€å¡Šï¼š
         - smartï¼šåœ¨ safe_edges åŸºç¤ä¸Šï¼ŒåŠ å¼·ä¿è­·äº®çª—èˆ‡å‚ç›´ç·šæ¢
         - safe_edgesï¼šä¿è­·é‚Šç·£èˆ‡å¤–æ¡†
         - fullï¼šå…¨åœ–å¯ç·¨è¼¯ï¼ˆé¢¨éšªè¼ƒé«˜ï¼Œå¯èƒ½ç ´å£çµæ§‹ï¼‰
         - åƒæ•¸å¯å¾®èª¿ï¼šmargin_ratio / edge_thresh / window_bright_thresh / dilate_px / protect_windows
       -->
    <div id="maskControls" class="row" style="display:block; border:1px dashed #f7b84b; padding:10px; border-radius:10px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <label><input type="radio" name="maskMode" value="smart" checked> è°æ˜é®ç½©ï¼ˆsmartï¼‰</label>
        <label><input type="radio" name="maskMode" value="safe_edges"> é‚Šç·£ä¿è­·ï¼ˆsafe_edgesï¼‰</label>
        <label><input type="radio" name="maskMode" value="full"> å…¨åœ–å¯ç·¨è¼¯ï¼ˆfullï¼‰</label>
      </div>
      <div id="smartOpts" style="margin-top:10px;">
        <div class="note" style="margin-bottom:6px;">é€²éšï¼ˆsmart å°ˆç”¨ï¼‰ï¼šè¦ºå¾—é‚Šç•Œé‚„æ˜¯æœƒè¢«æ”¹åˆ°ï¼Ÿå°±æŠŠã€Œé‚Šç·£é–€æª»ã€é™ä½ã€æˆ–æŠŠã€Œè†¨è„¹åƒç´ ã€åŠ å¤§ã€‚</div>
        <div style="display:grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap:8px;">
          <label>å¤–æ¡†ä¿è­·æ¯”ä¾‹ margin_ratioï¼ˆ0.02â€“0.10ï¼‰<br>
            <input type="number" id="opt_margin_ratio" min="0.01" max="0.20" step="0.01" value="0.04" style="width:120px;">
          </label>
          <label>é‚Šç·£é–€æª» edge_threshï¼ˆ0â€“255ï¼‰<br>
            <input type="number" id="opt_edge_thresh" min="0" max="255" step="1" value="28" style="width:120px;">
          </label>
          <label>äº®å€é–€æª» window_bright_threshï¼ˆ0â€“255ï¼‰<br>
            <input type="number" id="opt_window_bright_thresh" min="0" max="255" step="1" value="215" style="width:120px;">
          </label>
          <label>è†¨è„¹åƒç´  dilate_pxï¼ˆ0â€“20ï¼‰<br>
            <input type="number" id="opt_dilate_px" min="0" max="20" step="1" value="6" style="width:120px;">
          </label>
          <label style="grid-column: 1 / -1;">
            <input type="checkbox" id="opt_protect_windows" checked> ä¿è­·é«˜äº®çª—/ç»ç’ƒ/ç‡ˆå…·ï¼ˆprotect_windowsï¼‰
          </label>
        </div>
      </div>
      <div id="maskPreviewWrap" class="hidden" style="margin-top:10px;">
        <div class="note">é®ç½©é è¦½ï¼ˆè‹¥å¾Œç«¯å›å‚³ mask_url æœƒé¡¯ç¤ºï¼‰ï¼š</div>
        <img id="maskPreview" src="" style="max-width:100%; border-radius:10px; box-shadow:0 2px 10px #ebdbd1;">
      </div>
    </div>

    <div class="row">
      <button class="cute-btn" id="genBtn">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
    </div>
    <div id="loading" class="note hidden">â³ æ­£åœ¨ç”Ÿæˆï¼Œè«‹è€å¿ƒç­‰å€™...</div>

    <div class="row" id="compareModeBtns" style="margin-bottom:1.2em; display:none;">
      <button class="cute-btn" id="sideBySideBtn">å·¦å³å°æ¯”</button>
      <button class="cute-btn" id="sliderBtn">æ»‘æ¡¿æ¯”å°</button>
    </div>
    <!-- å·¦å³ä¸¦æ’ï¼ˆå…©å¼µåœ–ç‰‡å›ºå®šå¤§å°ä¸¦åˆ—é¡¯ç¤ºï¼‰ -->
    <div id="compareWrap" class="preview-wrap row hidden">
      <div class="img-box">
        <div class="note">åŸå§‹åœ–ç‰‡</div>
        <img id="originalImg" src="" alt="åŸåœ–é è¦½"/>
      </div>
      <div class="img-box">
        <div class="note">é¢¨æ ¼è½‰æ›</div>
        <img id="styledImg" src="" alt="é¢¨æ ¼åœ–é è¦½"/>
        <button class="cute-btn" id="downloadBtn" style="margin-top:1em;">â¬‡ ä¸‹è¼‰åœ–ç‰‡</button>
      </div>
    </div>
    <!-- æ»‘æ¡¿æ¯”å°ï¼ˆä¸Šå±¤åœ–ä»¥ clip width æ–¹å¼è£åˆ‡ï¼Œæ­é… range æ§åˆ¶å¯¬åº¦ï¼‰ -->
    <div id="sliderWrap" class="hidden">
      <div class="slider-outer">
        <img id="sliderBefore" src="" style="z-index:1;">
        <div id="sliderClipWrap" style="z-index:2; width:0%">
          <img id="sliderAfter" src="">
        </div>
        <input type="range" min="0" max="100" value="0" id="sliderControl">
      </div>
      <div style="display:flex;justify-content:space-between;font-size:0.97em;color:#888;margin-top:0.4em;">
        <span>åŸå§‹</span><span>é¢¨æ ¼</span>
      </div>
    </div>
    <div id="errMsg" class="note hidden" style="color:#e33;"></div>
  </div>
<script>
// ===========================
// å‰ç«¯äº’å‹•è…³æœ¬ï¼ˆVanilla JSï¼‰
// åŠŸèƒ½ï¼šè¼‰å…¥é¢¨æ ¼ã€è™•ç†ä¸Šå‚³ã€çµ„åˆé®ç½©åƒæ•¸ã€å‘¼å«å¾Œç«¯ã€è¼ªè©¢ä»»å‹™ç‹€æ…‹ã€é¡¯ç¤ºæ¯”å°ã€ä¸‹è¼‰åœ–ç‰‡
// ===========================

// Helper: wait for <img> to fully load
// ç­‰å¾…åœ–ç‰‡è¼‰å…¥å®Œæˆï¼Œé¿å…å°šæœªå–å¾— naturalWidth/Height å°±é€²è¡Œè¨ˆç®—
function waitImg(img){
  return new Promise(res=>{
    if(img && img.complete && img.naturalWidth>0) return res();
    if(!img) return res();
    img.onload = ()=>res();
    img.onerror = ()=>res();
  });
}

// å¾Œç«¯åŸºåº•ä½å€ï¼š
// - æ­£å¼ç’°å¢ƒå¯ç¶­æŒé›²ç«¯ç¶²å€
// - æœ¬æ©Ÿæ¸¬è©¦å¯æ”¹ç‚ºç©ºå­—ä¸² '' æˆ– 'http://localhost:5000'
const API_BASE = 'https://oldroomchange-image3.onrender.com';

let base64img = "", styleList = [];
const imgInput = document.getElementById('imageInput');
const preview = document.getElementById('preview');
const styleSelect = document.getElementById('styleSelect');
const styleDesc = document.getElementById('styleDesc');
const colorInput = document.getElementById('colorInput');
const genBtn = document.getElementById('genBtn');
const loading = document.getElementById('loading');
const compareModeBtns = document.getElementById('compareModeBtns');
const compareWrap = document.getElementById('compareWrap');
const originalImg = document.getElementById('originalImg');
const styledImg = document.getElementById('styledImg');
const downloadBtn = document.getElementById('downloadBtn');
const sliderWrap = document.getElementById('sliderWrap');
const sideBySideBtn = document.getElementById('sideBySideBtn');
const sliderBtn = document.getElementById('sliderBtn');
const sliderBefore = document.getElementById('sliderBefore');
const sliderAfter = document.getElementById('sliderAfter');
const sliderClipWrap = document.getElementById('sliderClipWrap');
const sliderControl = document.getElementById('sliderControl');
const errMsg = document.getElementById('errMsg');
// å‰ç«¯ï¼šæª”æ¡ˆå¤§å°ä¸Šé™ï¼ˆ2MBï¼‰ï¼Œå¤§æ–¼ä¸Šé™æœƒæç¤ºå£“ç¸®
const MAX_SIZE = 2*1024*1024;
// Mask controls
// å–å¾— mask å–®é¸æŒ‰éˆ• NodeList â†’ é™£åˆ—
const maskModeRadios = () => [...document.querySelectorAll('input[name="maskMode"]')];
// smart æ¨¡å¼åƒæ•¸ï¼šå³æ™‚è®€å–è¡¨å–®å€¼ï¼ˆä½¿ç”¨ Getter ç¢ºä¿æœ€æ–°ï¼‰
const smartOpts = {
  get margin_ratio(){ return parseFloat(document.getElementById('opt_margin_ratio').value || '0.04'); },
  get edge_thresh(){ return parseInt(document.getElementById('opt_edge_thresh').value || '28'); },
  get window_bright_thresh(){ return parseInt(document.getElementById('opt_window_bright_thresh').value || '215'); },
  get dilate_px(){ return parseInt(document.getElementById('opt_dilate_px').value || '6'); },
  get protect_windows(){ return document.getElementById('opt_protect_windows').checked; }
};


// è¼‰å…¥é¢¨æ ¼ï¼ˆå‘ /styles å–è³‡æ–™ï¼Œæ³¨å…¥ä¸‹æ‹‰é¸å–®ï¼›ä¸¦é¡¯ç¤ºç°¡çŸ­æè¿°ï¼‰
fetch(`${API_BASE}/styles`).then(r=>r.json()).then(list=>{
  styleList=list;
  styleSelect.innerHTML = list.map((s,i)=>
    `<option value="${s.name}" ${i==0?'selected':''}>${s.name}</option>`
  ).join('');
  function getShortDesc(desc, name) {
    if(!desc) return name;
    let d = desc.replace(/ã€‚.*$/, '').replace(/[\r\n]/g,'').trim();
    return d.length>10 ? d.slice(0,10)+'...' : d;
  }
  styleDesc.textContent = getShortDesc(list[0]?.desc||"", list[0]?.name||"");
});
// åˆ‡æ›é¢¨æ ¼æ™‚ï¼Œæ›´æ–°ä¸‹æ–¹çš„é¢¨æ ¼æè¿°
styleSelect.onchange = ()=>{
  const v = styleSelect.value;
  const info = styleList.find(s=>s.name==v);
  function getShortDesc(desc, name) {
    if(!desc) return name;
    let d = desc.replace(/ã€‚*$/, '').replace(/[\r\n]/g,'').trim();
    return d.length>10 ? d.slice(0,10)+'...' : d;
  }
  styleDesc.textContent = getShortDesc(info?.desc||"", info?.name||"");
};

// é¸æ“‡åœ–ç‰‡æ™‚ï¼š
// - é©—è­‰æª”æ¡ˆå‹åˆ¥/å¤§å°
// - é¡¯ç¤ºé è¦½
imgInput.onchange = function(e){
  preview.innerHTML="";
  errMsg.classList.add('hidden');
  compareWrap.classList.add('hidden');
  sliderWrap.classList.add('hidden');
  compareModeBtns.style.display = 'none';
  base64img = "";
  const file = this.files[0];
  if(!file) return;
  if(!['image/jpeg','image/png'].includes(file.type)){
    alert('âŒ åƒ…æ¥å—JPG/PNGæ ¼å¼åœ–ç‰‡ï¼');
    this.value="";
    return;
  }
  if(file.size > MAX_SIZE){
    alert('âŒ åœ–ç‰‡æª”æ¡ˆè¶…é2MBï¼è«‹ä½¿ç”¨æ‰‹æ©Ÿæˆªåœ–ã€èª¿æ•´ç•«è³ªæˆ–å‰å¾€ https://tinypng.com å£“ç¸®ã€‚');
    this.value="";
    return;
  }
  if(file.size > MAX_SIZE*0.7){
    preview.innerHTML='<div class="note">âš ï¸ æª”æ¡ˆæ¥è¿‘ä¸Šé™ï¼Œå»ºè­°å£“ç¸®å¯æå‡é€Ÿåº¦ã€‚</div>';
  }
  const reader = new FileReader();
  reader.onload = function(ev){
    base64img = ev.target.result;
    preview.innerHTML += `<img src="${base64img}" style="max-width:220px;max-height:150px;border-radius:12px;margin-top:10px;" alt="é è¦½"/>`;
  };
  reader.readAsDataURL(file);
};


// åˆ‡æ› mask æ¨¡å¼æ™‚é¡¯ç¤º/éš±è— smart åƒæ•¸ï¼ˆé smart æ¨¡å¼éš±è—é€²éšè¨­å®šï¼‰
maskModeRadios().forEach(r=>{
  r.addEventListener('change', ()=>{
    const mode = maskModeRadios().find(x=>x.checked)?.value || 'smart';
    document.getElementById('smartOpts').style.display = (mode === 'smart') ? '' : 'none';
  });
});
// é è¨­ smart é¡¯ç¤º
document.getElementById('smartOpts').style.display = '';

// é€å‡ºè«‹æ±‚ï¼š
// - å°‡ base64 åœ– + é¢¨æ ¼ + è‰²ç³» + é®ç½©è¨­å®šæ‰“åŒ…æˆ JSON
// - å‘¼å« POST /generate å–å¾— task_id
// - å•Ÿå‹•è¼ªè©¢ /status/<task_id> ç­‰å¾…å®Œæˆ
genBtn.onclick = async function(){
  errMsg.classList.add('hidden');
  if(!base64img){
    alert('è«‹å…ˆé¸æ“‡åœ–ç‰‡ï¼'); return;
  }
  if(!colorInput.value.trim()){
    alert('è«‹è¼¸å…¥ä¸»è‰²ç³»ï¼ˆä¾‹ï¼šç™½ï¼‹æ·ºç°ï¼‹æœ¨è‰²ï¼‰'); return;
  }
  loading.classList.remove('hidden');
  compareWrap.classList.add('hidden');
  sliderWrap.classList.add('hidden');
  compareModeBtns.style.display = 'none';
  genBtn.disabled=true;
  try{
    const r = await fetch(`${API_BASE}/generate`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify((()=>{ const mode = maskModeRadios().find(x=>x.checked)?.value || 'smart'; const payload = { image_base64: base64img, style: styleSelect.value, colors: colorInput.value, mask: mode }; if(mode==='smart'){ payload.mask_options = { margin_ratio: smartOpts.margin_ratio, edge_thresh: smartOpts.edge_thresh, window_bright_thresh: smartOpts.window_bright_thresh, dilate_px: smartOpts.dilate_px, protect_windows: smartOpts.protect_windows }; } return payload; })())
    });
    const resp = await r.json();
    if(resp.status==="failed"){
      throw new Error(resp.error||'ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
    }
    let t = 0, maxTry=60;
    let poll;
    poll = setInterval(async ()=>{
      // æ¯ 2 ç§’è¼ªè©¢ä¸€æ¬¡ä»»å‹™ç‹€æ…‹
      const rs = await fetch(`${API_BASE}/status/${resp.task_id}`);
      const j = await rs.json();
      if(j.status==="completed"){
        // æˆåŠŸï¼šé—œé–‰ loadingã€é¡¯ç¤ºæ¯”å°ã€ç¶å®šä¸‹è¼‰æŒ‰éˆ•ã€é¡¯ç¤ºé®ç½©é è¦½
        clearInterval(poll);
        loading.classList.add('hidden');
        showComparison(j.original_image_url, j.styled_image_url);
        downloadBtn.onclick = ()=>downloadImg(j.styled_image_url);

        if (j.mask_url) {
          const wrap = document.getElementById('maskPreviewWrap');
          const mp = document.getElementById('maskPreview');
          mp.src = API_BASE + j.mask_url;
          wrap.classList.remove('hidden');
        }

        genBtn.disabled=false;
      }
      if(j.status==="failed"){
        // å¤±æ•—ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        clearInterval(poll);
        loading.classList.add('hidden');
        errMsg.textContent = "âŒ ç”¢ç”Ÿå¤±æ•—ï¼š"+(j.error||"æœªçŸ¥éŒ¯èª¤"); errMsg.classList.remove('hidden');
        genBtn.disabled=false;
      }
      if(++t > maxTry){
        // é€¾æ™‚ï¼šåœæ­¢è¼ªè©¢ä¸¦æç¤º
        clearInterval(poll);
        loading.classList.add('hidden');
        errMsg.textContent = "âŒ è¶…æ™‚ï¼Œè«‹é‡æ–°ä¸Šå‚³åœ–ç‰‡å†è©¦ã€‚";
        errMsg.classList.remove('hidden');
        genBtn.disabled=false;
      }
    },2000);
  }catch(e){
    loading.classList.add('hidden');
    errMsg.textContent = "âŒ "+e.message;
    errMsg.classList.remove('hidden');
    genBtn.disabled=false;
  }
};

// é¡¯ç¤ºæ¯”å°åœ–ï¼ˆå„ªåŒ–åœ–ç‰‡å¤§å°/å°é½Š/æ»‘æ¡¿èµ·é»ï¼‰ï¼š
// - å‹•æ…‹è¨­å®šå¤–æ¡† aspect-ratio ä»¥ç¬¦åˆå¯¦åœ–æ¯”ä¾‹
// - é è¨­å…ˆé¡¯ç¤ºã€Œæ»‘æ¡¿æ¯”å°ã€æ¨¡å¼ä¸¦éœ²å‡ºæ¨¡å¼åˆ‡æ›æŒ‰éˆ•
function showComparison(originalUrl, styledUrl) {
  // Set sources
  if (typeof API_BASE === 'undefined') { window.API_BASE = ''; }
  originalImg.src = API_BASE + originalUrl;
  styledImg.src   = API_BASE + styledUrl;
  sliderBefore.src = API_BASE + originalUrl;
  sliderAfter.src  = API_BASE + styledUrl;

  Promise.all([waitImg(sliderAfter), waitImg(sliderBefore)]).then(()=> {
    const w = sliderAfter.naturalWidth || 1024;
    const h = sliderAfter.naturalHeight || 1024;
    const outer = document.querySelector('#sliderWrap .slider-outer');
    if (outer && outer.style) {
      outer.style.aspectRatio = w + ' / ' + h;  // dynamically match image ratio
    }
    // Reset slider position
    sliderClipWrap.style.width = "0%";
    sliderControl.value = 0;

    // Default show side-by-side compare
    compareWrap.classList.add('hidden');
    sliderWrap.classList.remove('hidden');
    if (typeof compareModeBtns !== 'undefined' && compareModeBtns) {
      compareModeBtns.style.display = '';
    }
  });
}

// åˆ‡æ›ç‚ºå·¦å³ä¸¦æ’æ¯”å°
sideBySideBtn.onclick = function(){
  sliderWrap.classList.add('hidden');
  compareWrap.classList.remove('hidden');
}
// åˆ‡æ›ç‚ºæ»‘æ¡¿æ¯”å°
sliderBtn.onclick = function(){
  compareWrap.classList.add('hidden');
  sliderWrap.classList.remove('hidden');
}

// æ»‘æ¡¿äº‹ä»¶ï¼ˆåŒæ­¥ clip widthï¼‰ï¼š
// ä¾ slider æ•¸å€¼ï¼ˆ0â€“100ï¼‰èª¿æ•´ä¸Šå±¤åœ–è¦†è“‹å¯¬åº¦
sliderControl.oninput = function(){
  sliderClipWrap.style.width = `${this.value}%`;
}

// ä¸‹è¼‰åœ–ç‰‡ï¼ˆè‡ª /results è£œä¸Š API_BASE ä»¥æ”¯æ´æœ¬æ©Ÿ/é›²ç«¯ï¼‰
function downloadImg(url){
  fetch(API_BASE + url).then(r=>r.blob()).then(blob=>{
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "styled_output.png";
    document.body.appendChild(link);
    link.click(); document.body.removeChild(link);
  });
}
</script>
</body>
</html>


